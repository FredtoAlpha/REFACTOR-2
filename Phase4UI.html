<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Répartition Classes - Version Universelle</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SortableJS pour drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js pour les graphiques -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS pour export Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF pour export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas pour screenshots PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    /* Variables CSS pour les couleurs */
    :root {
      --primary: #5b21b6;
      --primary-dark: #4c1d95;
      --secondary: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e293b;
      --light: #f8fafc;
      
      /* Couleurs sexe adoucies */
      --sexe-f: #ec4899;
      --sexe-f-light: #fbcde6;
      --sexe-m: #3b82f6;
      --sexe-m-light: #d7e8fe;
    }

    /* optionnel : léger renfort d'opacité */
    .student-card.sexe-F,
    .student-card.sexe-M { opacity:.96; }

    /* ========== STYLES POUR LES OPTIONS DE LISIBILITÉ ========== */
    
    /* Boutons d'options de lisibilité : on stylise uniquement ce qui n'est pas Tailwind */
    .btn-lisibilite {
      background: #f3f4f6;
      color: #6b7280;
      border: 1px solid #d1d5db;
      padding: 0.5rem 0.75rem;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 0.375rem;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      transition: all 0.2s;
      cursor: pointer;
      outline: none;
    }
    .btn-lisibilite:hover {
      background: #e5e7eb;
      color: #374151;
      border-color: #9ca3af;
    }
    .btn-lisibilite.active {
      background: #3b82f6;
      color: white;
      border-color: #2563eb;
    }
    
    /* Effets de lisibilité sur les noms */
    .student-fullname.size-small { font-size: 0.75rem; }
    .student-fullname.size-medium { font-size: 0.95rem; }
    .student-fullname.size-large { font-size: 1.15rem; }
    .student-fullname.size-xlarge { font-size: 1.35rem; }
    
    .student-fullname.style-bold { font-weight: 700; }
    .student-fullname.style-highlight { 
      background: #fef3c7; 
      padding: 2px 4px;
      border-radius: 3px;
    }
    .student-fullname.style-outline { 
      border: 2px solid #3b82f6;
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    /* Contraste élevé */
    .contrast-high .student-fullname {
      color: #000 !important;
      text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
    }
    
    /* Contraste maximum */
    .contrast-max .student-fullname {
      color: #000 !important;
      font-weight: 900 !important;
      text-shadow: 2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff;
    }
    
    /* Symboles pour les genres, version très visible */
    .student-card.symbols-symbols .student-fullname::before {
      font-size: 1.3em;
      font-weight: bold;
      margin-right: 10px;
      vertical-align: middle;
      display: inline-block;
    }
    .student-card.symbols-symbols.sexe-F .student-fullname::before {
      content: "♀ ";
      color: #000;
    }
    .student-card.symbols-symbols.sexe-M .student-fullname::before {
      content: "♂ ";
      color: #000;
    }
    /* On supprime la couleur de fond quand symboles activés */
    .student-card.symbols-symbols {
      background: #fff !important;
      border-color: #bbb !important;
    }
    .student-card.symbols-symbols .student-fullname {
      color: #000 !important;
    }
    /* On garde la couleur rose/bleu uniquement si symbols n'est PAS activé */
    .student-card.symbols-colors.sexe-F {
      background: var(--sexe-f-light);
      border-color: #fbbdd7;
    }
    .student-card.symbols-colors.sexe-M {
      background: var(--sexe-m-light);
      border-color: #bfdbfe;
    }
    /* Couleurs + symboles : fond blanc + symbole + petit badge couleur à droite */
    .student-card.symbols-both {
      background: #fff !important;
      border-color: #bbb !important;
      position: relative;
    }
    .student-card.symbols-both.sexe-F .student-fullname::after {
      content: " ";
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--sexe-f-light);
      border-radius: 50%;
      margin-left: 8px;
      vertical-align: middle;
      border: 1.5px solid #fbbdd7;
    }
    .student-card.symbols-both.sexe-M .student-fullname::after {
      content: " ";
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--sexe-m-light);
      border-radius: 50%;
      margin-left: 8px;
      vertical-align: middle;
      border: 1.5px solid #bfdbfe;
    }
    /* Mode plein écran */
    body.fullscreen-mode {
      overflow: hidden;
    }
    body.fullscreen-mode .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 40;
    }
    body.fullscreen-mode main {
      margin-top: 80px;
    }

    /* Mode sombre */
    body.dark-mode {
      --dark: #f8fafc;
      --light: #1e293b;
      background-color: #0f172a;
      color: #e2e8f0;
    }

    body.dark-mode .app-header,
    body.dark-mode .class-column,
    body.dark-mode .chart-container,
    body.dark-mode .stats-panel,
    body.dark-mode .modal-content {
      background-color: #1e293b;
      color: #e2e8f0;
      border-color: #334155;
    }

    /* ========== STYLES POUR LES INDICATEURS DE FEEDBACK EN TEMPS RÉEL ========== */
    
    /* Panneau de feedback flottant */
    .feedback-panel {
      position: fixed;
      top: 100px;
      right: 20px;
      width: 280px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border: 2px solid #e5e7eb;
      z-index: 1000;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .feedback-panel.minimized {
      width: 60px;
      height: 60px;
      overflow: hidden;
    }
    
    .feedback-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    
    .feedback-content {
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .feedback-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .feedback-metric:last-child {
      border-bottom: none;
    }
    
    .metric-label {
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }
    
    .metric-value {
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .metric-change {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .metric-change.improved {
      background: #dcfce7;
      color: #166534;
    }
    
    .metric-change.degraded {
      background: #fef2f2;
      color: #dc2626;
    }
    
    .metric-change.neutral {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    /* Animation pour les changements */
    @keyframes metricPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .metric-value.changed {
      animation: metricPulse 0.6s ease-in-out;
    }
    
    /* Indicateur de drag en cours */
    .student-card.dragging {
      opacity: 0.7;
      transform: rotate(5deg);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    /* Zone de drop avec feedback */
    .droppable-zone.drag-over {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px dashed #f59e0b;
      transform: scale(1.02);
      transition: all 0.2s ease;
    }
    
    .droppable-zone.drag-over.improved {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border-color: #10b981;
    }
    
    .droppable-zone.drag-over.degraded {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-color: #ef4444;
    }
    
    /* Badge de score sur les cartes élèves */
    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin: 1px;
    }
    
    .score-badge.math {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    
    .score-badge.french {
      background: #fce7f3;
      color: #be185d;
      border: 1px solid #f9a8d4;
    }
    
    /* Indicateur de contrainte sur les cartes */
    .constraint-indicator {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      color: white;
    }
    
    .constraint-indicator.asso {
      background: #10b981;
    }
    
    .constraint-indicator.disso {
      background: #ef4444;
    }

    body.dark-mode .search-input,
    body.dark-mode .form-control {
      background-color: #334155;
      border-color: #475569;
      color: #e2e8f0;
    }

    body.dark-mode .droppable-zone {
      background-color: #334155;
    }

    body.dark-mode .student-card {
      background-color: #475569;
      border-color: #64748b;
    }

    body.dark-mode .student-card.sexe-F {
      background: #831843;
      border-color: #be185d;
    }

    body.dark-mode .student-card.sexe-M {
      background: #1e3a8a;
      border-color: #2563eb;
    }

    body.dark-mode .student-fullname {
      color: #f1f5f9;
    }

    body.dark-mode .badge-compact {
      background: #451a03 !important;
      color: #fef3c7 !important;
      border-color: #92400e !important;
    }

    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Animation fade-in */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    /* ========== NOUVEAU LAYOUT 3 LIGNES ========== */
    
    /* Carte élève ultra-compacte avec couleurs adoucies */
    .student-card {
      width: 100%;
      background: white;
      border-radius: 8px;
      padding: 6px 14px;
      margin-bottom: 4px;
      border: 2px solid transparent;
      cursor: grab;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transform-origin: center;
    }
    
    /* Zoom sur les cartes */
    body.zoom-cards .student-card {
      padding: 10px 14px;
      margin-bottom: 6px;
    }
    
    body.zoom-cards .card-line {
      height: 24px !important;
    }
    
    body.zoom-cards .student-fullname {
      font-size: 0.95rem;
    }
    
    body.zoom-cards .mini-badge {
      height: 20px;
      font-size: 11px;
      padding: 0 8px;
    }
    
    body.zoom-cards .score-pill {
      width: 26px;
      height: 26px;
      font-size: 13px;
    }
    
    .student-card.sexe-F {
      background: var(--sexe-f-light);
      border-color: #fbbdd7;
    }
    
    .student-card.sexe-M {
      background: var(--sexe-m-light);
      border-color: #bfdbfe;
    }
    
    .student-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .student-card.dragging {
      cursor: grabbing;
      opacity: 0.8;
      transform: scale(1.02) rotate(1deg);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .student-card.swap-mode {
      animation: pulse 1.5s infinite;
      border-style: dashed;
      border-width: 3px;
      border-color: #fbbf24;
    }
    
    .student-card.search-highlight {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
      transform: scale(1.02);
    }
    
    /* Lignes de la carte */
    .card-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 20px;
    }
    
    .card-line-1 { height: 22px; }
    .card-line-2, .card-line-3 { height: 18px; }
    
    /* Ligne 1: Nom complet (NOM Prénom) */
    .student-fullname {
      font-size: 0.85rem;
      font-weight: 700;
      line-height: 1.1;
      color: #0f172a;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    
    /* Ligne 2: Container pour tous les badges */
.all-badges {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;  /* ← CENTRÉ ! */
  min-height: 16px;
}
    
    /* Ligne 3: Source + scores - ALIGNEMENT FIXE */
    .card-line-3 {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
    }

    .source-class {
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .scores {
      display: flex;
      gap: 3px;
      justify-content: flex-end;
      min-width: fit-content;
    }
    
    /* Mini badges avec couleurs marquantes */
    .mini-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: var(--badge-h, 16px);
      padding: 0 6px;
      border-radius: 8px;
      font-size: calc(var(--badge-h, 16px) * 0.55);
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      margin-left: 2px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    
    /* ========== BADGES COMPACTS ========== */
    .badge-compact {
      background: #fef3c7 !important;  /* jaune très clair */
      color: #92400e !important;       /* brun pour contraste */
      border: 1px solid #fcd34d !important; /* bordure jaune */
      font-weight: 800 !important;
      box-shadow: 0 1px 2px rgba(146, 64, 14, 0.2) !important;
    }
    
    /* Badges dissociation/association - TOUJOURS VISIBLES */
    .badge-disso {
      background: #0f172a !important;
      color: white !important;
    }
    
    .badge-asso {
      background: #f1f5f9 !important;
      color: #0f172a !important;
      border: 1px solid #94a3b8 !important;
    }
    
    /* Badges LV2 avec couleurs distinctes - FORCÉ */
    .badge-ESP { 
      background: #dc2626 !important; 
      color: white !important; 
    }
    .badge-ITA { 
      background: #059669 !important; 
      color: white !important; 
    }
    .badge-ALL { 
      background: #2563eb !important; 
      color: white !important; 
    }
    .badge-LATIN { 
      background: #7c3aed !important; 
      color: white !important; 
    }
    .badge-GRECO { 
      background: #dc2626 !important; 
      color: white !important; 
    }
    
    /* Badges Options avec couleurs marquantes - FORCÉ */
    .badge-CHAV { 
      background: #7c3aed !important; 
      color: white !important; 
    }
    .badge-LLCA { 
      background: #0891b2 !important; 
      color: white !important; 
    }
    .badge-EURO { 
      background: #d97706 !important; 
      color: white !important; 
    }
    .badge-BIL { 
      background: #047857 !important; 
      color: white !important; 
    }
    .badge-GREC { 
      background: #b91c1c !important; 
      color: white !important; 
    }
    
    /* Badge mobilité plus visible */
    .badge-mobilite {
      background: #fbbf24 !important;
      color: #78350f !important;
      font-weight: 800 !important;
    }
    
/* Badge DISPO carré */
.badge-dispo {
  background: #374151 !important;
  color: white !important;
  border-radius: 4px !important;
  padding: 2px 4px !important;
  font-size: 10px !important;
  font-weight: 700 !important;
  letter-spacing: 0.5px !important;
  min-width: 28px !important;
  text-align: center !important;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
}

    /* Mode sombre - badges restent visibles */
    body.dark-mode .mini-badge {
      opacity: 0.95;
    }
    
    /* Ajustement pour les petites cartes */
    .card-sm .mini-badge {
      padding: 0 4px;
      margin-left: 1px;
    }
    
    /* Scores en pastilles colorées */
    .score-pill {
      width: 22px;
      height: 22px;
      border-radius: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: white;
      margin-left: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    /* Couleurs des scores selon la valeur */
    .score-pill.score-4 { 
      background: #006400; /* Vert foncé */
    }
    
    .score-pill.score-3 { 
      background: #22c55e; /* Vert clair */
    }
    
    .score-pill.score-2 { 
      background: #fbbf24; /* Jaune */
      color: #78350f;
    }
    
    .score-pill.score-1 { 
      background: #dc2626; /* Rouge */
    }

    /* ---------------------------  CARTES FLUIDES 3 LIGNES  --------------------------- */
    /* 3 tailles de carte selon la largeur disponible */
    .card-sm { 
      --fs-name: .80rem; 
      --badge-h: 16px; 
      --score: 20px;
    }
    .card-md { 
      --fs-name: .85rem; 
      --badge-h: 18px; 
      --score: 22px;
    }
    .card-lg { 
      --fs-name: .90rem; 
      --badge-h: 20px; 
      --score: 24px;
    }

    /* Application des variables aux éléments */
    .student-fullname { 
      font-size: var(--fs-name, 0.85rem);
      font-weight: 700;
      color: #0f172a;
    }

    /* Scores avec taille adaptative */
    .score-pill {
      width: var(--score, 22px); 
      height: var(--score, 22px);
      font-size: calc(var(--score, 22px) * 0.5);
      border-radius: 50%;
      font-weight: 700;
    }

    /* S'assurer que les badges sont toujours visibles */
    .all-badges {
      display: flex !important;
      gap: 2px;
      flex-wrap: wrap;
    }

    /* Mode compact : réduire encore plus les marges */
    body.stats-open .card-line {
      height: 16px !important;
      margin-bottom: 1px;
    }

    body.stats-open .card-line-1 {
      height: 18px !important;
    }

    /* Colonnes de classe modernes et compactes */
    .class-column {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      overflow: hidden;
      width: 100%;
      min-width: 200px;
      max-width: none;
    }
    
    .class-column:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .class-header {
  background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%); /* Violet ! */
  color: white;
  padding: 12px;
  position: relative;
}

/* Vue simple : en-tête ultra-compact sur 1 ligne */
body.simple-view .class-header {
  padding: 6px 10px !important;
}

body.simple-view .class-header h2 {
  font-size: 1rem !important;
  margin-bottom: 0 !important;
}

body.simple-view .class-title-line {
  margin-bottom: 0 !important;
}

/* CACHER les boutons de tri en vue simple */
body.simple-view .sort-buttons {
  display: none !important;
}

/* Mode Essential : cartes avec badges essentiels uniquement */
body.essential-view .class-header {
  padding: 8px 10px !important;
}

body.essential-view .card-line-3 {
  display: none !important;  /* Masquer la ligne des scores */
}

/* Masquer les badges options en mode essential */
body.essential-view .badge-CHAV,
body.essential-view .badge-LLCA,
body.essential-view .badge-EURO,
body.essential-view .badge-BIL,
body.essential-view .badge-GREC {
  display: none !important;
}

    /* CORRECTION PROBLÈME 2 : En-tête sur une ligne */
    .class-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .class-title-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    
    .class-counts {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
    }
    
    .class-stats {
      display: flex;
      gap: 12px;
      font-size: 0.875rem;
      opacity: 0.9;
      align-items: center;
    }

    /* Boutons de tri */
    .sort-buttons {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .sort-btn {
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .sort-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .sort-btn.active {
      background: rgba(255, 255, 255, 0.4);
    }

    /* Zone de drop */
    .droppable-zone {
      min-height: 400px;
      max-height: calc(100vh - 320px);
      overflow-y: auto;
      padding: 8px;
      background: #f8fafc;
    }
    
    .droppable-zone.drag-over {
      background: #e0f2fe;
      box-shadow: inset 0 0 0 2px #0ea5e9;
    }
    
    .droppable-zone.swap-target {
      background: #dcfce7;
      box-shadow: inset 0 0 0 3px #22c55e;
    }
    
    .droppable-zone.drop-forbidden {
      background: #fee2e2;
      box-shadow: inset 0 0 0 3px #dc2626;
    }

    /* Scrollbar personnalisée */
    .droppable-zone::-webkit-scrollbar {
      width: 4px;
    }
    
    .droppable-zone::-webkit-scrollbar-track {
      background: #e2e8f0;
    }
    
    .droppable-zone::-webkit-scrollbar-thumb {
      background: #94a3b8;
      border-radius: 2px;
    }

    /* Header moderne */
    .app-header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    /* Message d'erreur stylé */
    .error-container {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border: 2px solid #fca5a5;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      margin: 2rem;
    }

    .error-icon {
      font-size: 3rem;
      color: #dc2626;
      margin-bottom: 1rem;
    }

    .error-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #7f1d1d;
      margin-bottom: 1rem;
    }

    .error-message {
      color: #991b1b;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .error-suggestions {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      text-align: left;
    }

    .error-suggestions ul {
      list-style-type: disc;
      margin-left: 1.5rem;
      color: #374151;
    }

    .error-suggestions li {
      margin-bottom: 0.5rem;
    }

    /* Boutons modernes */
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      border: none;
      cursor: pointer;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
  background: #5b21b6; /* Violet au lieu de var(--primary) */
  color: white;
}
    
    .btn-secondary {
      background: #64748b;
      color: white;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-swap {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    .btn-swap.active {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      animation: pulse 1.5s infinite;
    }
    
    .btn-admin {
      background: #dc2626;
      color: white;
    }
    
    .btn-admin.active {
      background: #059669;
    }

    .btn-dark-mode {
      background: #1e293b;
      color: white;
    }

    body.dark-mode .btn-dark-mode {
      background: #f8fafc;
      color: #1e293b;
    }

    /* Toast moderne */
    .toast {
      background: white;
      color: #1e293b;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid;
    }
    
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.info { border-left-color: var(--primary); }

    /* Loading spinner */
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Search input */
    .search-input {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 12px;
      width: 250px;
      font-size: 0.875rem;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 33, 182, 0.1);
    }
    
    /* Graphiques */
    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      margin-bottom: 10px;
    }
    
    .chart-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    /* CORRECTION PROBLÈME 4 : Stats panel avec z-index réduit */
    .stats-panel {
      width: 600px;
      max-width: 90vw;
      z-index: 40;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
      animation: slideInRight 0.3s ease-out;
      resize: horizontal;
      overflow: auto;
    }

    .stats-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      cursor: move;
    }

    .stats-panel.anchored {
      position: relative;
      width: 100%;
      height: auto;
      transform: none !important;
      box-shadow: none;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s ease-out;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    /* Formulaire */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-control {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 33, 182, 0.1);
    }

    /* Table règles */
    .rules-table {
      width: 100%;
      border-collapse: collapse;
    }

    .rules-table th,
    .rules-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .rules-table th {
      background: #f8fafc;
      font-weight: 600;
    }

    /* Suggestions de swap */
    .swap-suggestions {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .swap-suggestion {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      background: white;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .swap-suggestion:last-child {
      margin-bottom: 0;
    }

    /* Comparaison avant/après */
    .comparison-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); /* fluide */
      gap: 12px;
      margin-top: 2rem;
    }

    .comparison-side {
      padding: 1rem;
      border-radius: 8px;
      background: #f8fafc;
    }

    .comparison-side h3 {
      font-weight: 600;
      margin-bottom: 1rem;
    }

    /* Mode plein écran */
    body.fullscreen-stats {
      overflow: hidden;
    }

    body.fullscreen-stats .stats-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100% !important;
      max-width: 100% !important;
      transform: none !important;
      border-radius: 0;
    }

    /* Raccourcis clavier */
    .keyboard-shortcuts {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.75rem;
      z-index: 1000;
      max-width: 300px;
    }

    .keyboard-shortcuts h4 {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
    }

    .shortcut-key {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-family: monospace;
    }

    /* CORRECTION PROBLÈME 4 : Overlay non bloquant pour stats */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(2px);
      z-index: 30;
      pointer-events: none;
    }
    
    .overlay.active {
      pointer-events: auto;
    }
    /* ========== EFFET ACCORDÉON RESPONSIVE ========== */
    /* Grille qui occupe TOUTE la largeur disponible */
    #board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      width: 100%;
      padding-right: 12px;
      margin: 0;
      max-width: none;
    }

    /* Quand le panneau stats s'ouvre : compression accordéon */
    body.stats-open #board {
      width: calc(100% - var(--stats-width, 600px));
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    /* Colonnes adaptatives */
    .class-column {
      width: 100%;
      min-width: 160px;
      transition: all 0.3s ease;
    }

    /* Adaptation fine selon nombre de colonnes et taille écran */
    @media (min-width: 1920px) {
      #board {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      body.stats-open #board {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
    }

    @media (min-width: 2560px) {
      #board {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      body.stats-open #board {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }

    /* Pour 6 colonnes sur grand écran */
    @container (min-width: 1600px) {
      #board {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* Animation fluide du panneau stats */
    #statsPanel {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Zone de drop adaptative */
    .droppable-zone {
      min-height: 400px;
      max-height: calc(100vh - 200px);
    }

    /* Compression des cartes en mode stats */
    body.stats-open .student-card {
      padding: 5px 8px;
      margin-bottom: 3px;
    }

    body.stats-open .mini-badge {
      height: 14px;
      font-size: 8px;
      padding: 0 4px;
    }

    body.stats-open .score-pill {
      width: 20px;
      height: 20px;
      font-size: 10px;
    }

    /* Header de colonne plus compact */
    body.stats-open .class-header {
      padding: 10px;
    }

    body.stats-open .class-header h2 {
      font-size: 1.1rem;
    }
    .card-line-2 .all-badges {
  justify-content: center !important;
}

/* ========== NOUVEAUX STYLES POUR STATS SUPPLÉMENTAIRES ========== */
.stats-metric {
  text-align: center;
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.metric-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
}

.metric-label {
  font-size: 0.75rem;
  color: #64748b;
  margin-top: 4px;
}

.conformity-grid {
  display: grid;
  gap: 4px;
  margin-top: 12px;
  font-size: 0.7rem;
}

.conformity-cell {
  padding: 4px;
  border-radius: 4px;
  text-align: center;
  font-weight: 600;
  color: white;
}

.conformity-ok { background: #10b981; }
.conformity-warning { background: #f59e0b; }
.conformity-error { background: #ef4444; }
.conformity-undefined { background: #6b7280; }

.indicator-card {
  background: #f8fafc;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  border-left: 4px solid;
}

.indicator-good { border-left-color: #10b981; }
.indicator-warning { border-left-color: #f59e0b; }
.indicator-bad { border-left-color: #ef4444; }

/* Mode sombre */
body.dark-mode .stats-metric {
  background: #334155;
  border-color: #475569;
}

body.dark-mode .metric-value {
  color: #f1f5f9;
}

body.dark-mode .indicator-card {
  background: #334155;
}

/* Vue simplifiée - cartes ULTRA compactes */
.simple-mode { 
  padding: 1px 6px !important;    /* ← RÉDUIT ! */
  margin-bottom: 0px !important;   /* ← AUCUNE MARGE ! */
}

/* Symboles en vue simplifiée */
.simple-mode.symbols-symbols .student-simple-name::before {
  font-size: 1.2em;
  font-weight: bold;
  margin-right: 8px;
  vertical-align: middle;
  display: inline-block;
}

.simple-mode.symbols-symbols.sexe-F .student-simple-name::before {
  content: "♀ ";
  color: #000;
}

.simple-mode.symbols-symbols.sexe-M .student-simple-name::before {
  content: "♂ ";
  color: #000;
}

/* Couleurs en vue simplifiée */
.simple-mode.symbols-colors.sexe-F {
  background: var(--sexe-f-light) !important;
  border-color: #fbbdd7 !important;
}

.simple-mode.symbols-colors.sexe-M {
  background: var(--sexe-m-light) !important;
  border-color: #bfdbfe !important;
}

/* Couleurs + symboles en vue simplifiée */
.simple-mode.symbols-both {
  background: #fff !important;
  border-color: #bbb !important;
}

.simple-mode.symbols-both .student-simple-name::after {
  content: " ";
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-left: 6px;
  vertical-align: middle;
  border: 1px solid #bbb;
}

.simple-mode.symbols-both.sexe-F .student-simple-name::after {
  background: var(--sexe-f-light);
  border-color: #fbbdd7;
}

.simple-mode.symbols-both.sexe-M .student-simple-name::after {
  background: var(--sexe-m-light);
  border-color: #bfdbfe;
}

.simple-line { 
  /* plus de hauteur fixe, sera géré dynamiquement en JS */
  display: flex; 
  align-items: center; 
}

.student-simple-name {
  font-size: 0.8rem;
  line-height: 1;
  font-weight: 700 !important;
  -webkit-text-stroke: 1px black;
}

body.dark-mode .student-simple-name {
  -webkit-text-stroke: 1px white;
}

/* Zone de drop MAXIMALE en mode simple */
body.simple-view .droppable-zone {
  min-height: calc(100vh - 140px) !important;  /* ← PRESQUE TOUT L'ÉCRAN ! */
  max-height: calc(100vh - 140px) !important;
  padding: 2px !important;
  overflow-y: auto;
}

/* Masquer des éléments en mode simple */
body.simple-view .class-stats {
  display: none;
}

body.simple-view .class-counts {
  font-size: 0.75rem;
}

body.simple-view .class-title-line {
  margin-bottom: 4px;
}

/* ==== SUPPRIME (quasi) TOUTES LES MARGES BAS DE PAGE ==== */
html, body { height: 100%; }          /* occupe 100 % du viewport */
body       { display:flex; flex-direction:column; }

main       {                          /* zone qui contient #board  */
  flex: 1;                            /* prend toute la hauteur libre */
  padding-bottom: 0 !important;       /* retire le petit padding Tailwind */
}

/* ======= MODAL DE DÉMARRAGE (centrage et animation améliorés) ======= */
#startupModal .bg-white.rounded-lg.shadow-xl.p-8.max-w-md.w-full.text-center.relative {
  max-width: 700px !important;
  padding: 3rem 2rem !important;
}
#startupModal h2 {
  font-size: 2.5rem !important;
  margin-bottom: 2rem !important;
}
#startupModal .btn {
  font-size: 1.25rem !important;
  padding: 1.25rem 2rem !important;  /* Ajout padding horizontal */
  margin-bottom: 1.25rem !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  text-align: center !important;
}
#startupModal .btn span {
  display: block !important;
  margin-top: 0.5rem !important;
}
#startupModal .space-y-3.mb-6 > * {
  margin-bottom: 1.5rem !important;
}
#startupModal .text-xs {
  font-size: 1rem !important;
}
@keyframes modalSlideIn {
  from { 
    opacity: 0; 
    transform: scale(0.95) translateY(-20px);
  }
  to { 
    opacity: 1; 
    transform: scale(1) translateY(0);
  }
}
#startupModal > div {
  animation: modalSlideIn 0.3s ease-out;
}

    /* ========== NOUVELLES FONCTIONNALITÉS ========== */
    
    /* Boutons de filtre rapide */
    .filter-btn {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      background: #f3f4f6;
      color: #6b7280;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .filter-btn.active {
      background: #5b21b6;
      color: white;
      border-color: #5b21b6;
    }

    /* Cartes filtrées */
    .student-card.filtered-out {
      opacity: 0.2;
      pointer-events: none;
      transform: scale(0.95);
    }

    /* Panel historique */
    .history-panel {
      position: fixed;
      left: 0;
      top: 60px;
      bottom: 0;
      width: 300px;
      background: white;
      border-right: 1px solid #e5e7eb;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 35;
      overflow-y: auto;
    }

    .history-panel.open {
      transform: translateX(0);
    }

    .history-timeline {
      padding: 1rem;
    }

    .timeline-item {
      padding: 0.75rem;
      border-left: 3px solid #e5e7eb;
      margin-left: 1rem;
      margin-bottom: 1rem;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }

    .timeline-item:hover {
      background: #f8fafc;
      border-left-color: #5b21b6;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: #5b21b6;
      border-radius: 50%;
      border: 2px solid white;
    }

    .timeline-time {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .timeline-action {
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .timeline-details {
      font-size: 0.875rem;
      color: #4b5563;
      margin-top: 0.25rem;
    }

    /* Mode focus */
    .focused-column {
      position: fixed !important;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 100;
      width: 90vw !important;
      max-width: 600px !important;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }
    
    /* Indicateur de mise à jour des stats */
    .stats-updated {
      animation: pulse-green 2s ease-in-out;
      background: #10b981 !important;
      color: white !important;
    }
    
    @keyframes pulse-green {
      0%, 100% { background: #10b981; }
      50% { background: #059669; }
    }

    .focus-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 99;
    }

    .exit-focus-hint {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 101;
    }

    /* Menu bookmarks */
    .bookmarks-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      z-index: 50;
    }

    .bookmarks-menu.open {
      display: block;
    }

    .bookmark-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background 0.2s;
    }

    .bookmark-item:hover {
      background: #f8fafc;
    }

    .bookmark-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .bookmark-meta {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .bookmark-actions {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }

    .new-bookmark-form {
      padding: 1rem;
      border-top: 2px solid #e5e7eb;
    }

    /* Mode sombre pour les nouvelles fonctionnalités */
    body.dark-mode .filter-btn {
      background: #334155;
      color: #e2e8f0;
      border-color: #475569;
    }

    body.dark-mode .filter-btn:hover {
      background: #475569;
      color: #f1f5f9;
    }

    body.dark-mode .filter-btn.active {
      background: #5b21b6;
      color: white;
    }

    body.dark-mode .history-panel {
      background: #1e293b;
      border-color: #334155;
    }

    body.dark-mode .timeline-item:hover {
      background: #334155;
    }

    body.dark-mode .bookmarks-menu {
      background: #1e293b;
      border-color: #334155;
    }

    body.dark-mode .bookmark-item:hover {
      background: #334155;
    }

    /* Distinguer visuellement les groupes créés */
    .class-column[data-group-name] .class-header {
      background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%) !important;
    }

    .class-column[data-group-name] .classe-name::before {
      content: "📊 ";
      margin-right: 4px;
    }

    /* Vraies classes avec indicateur */
    .class-column:not([data-group-name]) .classe-name::before {
      content: "🏫 ";
      margin-right: 4px;
    }

    /* Animation de mise à jour des graphiques */
    .stats-panel.updating {
      animation: statsUpdate 0.3s ease-in-out;
    }

    @keyframes statsUpdate {
      0% { opacity: 1; }
      50% { opacity: 0.8; transform: scale(0.99); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* Barre de progression sauvegarde */
    .save-progress-bar {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border: 2px solid #e5e7eb;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .save-progress-bar.show {
      transform: translateX(0);
    }

    .save-progress-header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .save-progress-content {
      padding: 16px;
    }

    .progress-bar-container {
      background: #f3f4f6;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-steps {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 8px;
    }

    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      opacity: 0.5;
    }

    .progress-step.active {
      opacity: 1;
      color: #10b981;
      font-weight: 600;
    }

    .progress-step.completed {
      opacity: 1;
      color: #059669;
    }

    .progress-step i {
      margin-right: 8px;
      width: 12px;
    }

    /* Menu Paramètres avec sections */
    .settings-section {
      border-bottom: 1px solid #e5e7eb;
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section-header {
      padding: 10px 16px;
      background: #f9fafb;
      font-weight: 600;
      font-size: 0.85rem;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-item {
      width: 100%;
      text-align: left;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      color: #374151;
      background: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .settings-item:hover:not(:disabled) {
      background: #f3f4f6;
    }

    .settings-item:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .settings-item-inline {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-item-inline:hover:not(:disabled) {
      background: #e5e7eb;
    }

    .settings-item-inline:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .filter-btn-compact {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn-compact:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .filter-btn-compact.active {
      background: #3b82f6;
      color: white;
      border-color: #2563eb;
    }

    /* Largeur menu paramètres */
    #settingsDropdown {
      max-height: 80vh;
      overflow-y: auto;
    }

  </style>

</head>
<body class="min-h-screen bg-gray-50 font-sans text-slate-800">

<!-- SPINNER DE CHARGEMENT GLOBAL -->
<div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
  <div class="spinner"></div>
</div>

<!-- 1. MODAL DE DÉMARRAGE (indépendant) -->
<div id="startupModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center relative">
    <!-- Bouton de fermeture -->
    <button id="closeStartupModal" class="absolute top-2 right-3 text-gray-400 hover:text-gray-700 text-2xl focus:outline-none" title="Fermer" aria-label="Fermer">
      <i class="fa fa-times"></i>
    </button>
    <h2 id="modal-title" class="text-2xl font-bold mb-4 text-center">Choisissez le mode de travail</h2>
    <div class="space-y-3 mb-6 flex flex-col items-center">
      <button class="btn btn-primary w-11/12 mx-auto" data-mode="TEST">Mode START <span class="text-xs">(Démarrer une répartition)</span></button>
      <button class="btn btn-secondary w-11/12 mx-auto" data-mode="CACHE">Mode CONTINUE <span class="text-xs">(Reprendre une répartition)</span></button>
      <button class="btn btn-success w-11/12 mx-auto" data-mode="INT">Mode FINISH <span class="text-xs">(Corriger une répartition)</span></button>
    </div>
    <div id="restoreCacheBlock" class="mb-4 hidden text-center">
      <button id="btnRestoreCache" class="btn btn-warning w-11/12 mx-auto mb-2"><i class="fas fa-history"></i> Restaurer la dernière sauvegarde automatique</button>
      <div class="text-xs text-gray-500 mt-2">Dernière sauvegarde : <span id="lastCacheDate"></span></div>
    </div>
  </div>
</div>

<!-- 2. BADGE DE MODE (indépendant) -->
<div id="modeBadge" class="fixed top-2 left-2 z-40 px-3 py-1 rounded-full font-bold text-xs shadow-lg hidden"></div>

<!-- 3. CONTENU PRINCIPAL DE L'APPLICATION (en dehors du modal) -->
<!-- Header moderne avec infos complètes -->
<header class="app-header px-6 py-3" role="banner" aria-label="Navigation principale">
  <div class="flex justify-between items-center">
    <!-- GAUCHE -->
    <div class="flex items-center gap-4">
      <!-- Logo -->
      <div>
        <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
          <i class="fas fa-graduation-cap text-purple-700"></i>
          Classes <span id="niveau-detected" class="text-purple-600"></span>
        </h1>
      </div>

      <!-- Recherche -->
      <div class="relative">
        <input id="search" type="text" placeholder="Rechercher..." class="search-input" aria-label="Rechercher un élève">
        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>

      <!-- Boutons essentiels -->
      <div class="flex items-center gap-2">
        <label for="viewModeSelect" class="text-sm font-medium">Vue:</label>
        <select id="viewModeSelect" class="px-3 py-1 border rounded bg-white text-sm" title="Sélectionner le mode d'affichage">
          <option value="complete">Complète</option>
          <option value="essential">Essentielle</option>
          <option value="simple">Simple</option>
        </select>
      </div>
      <button id="btnStats" class="btn btn-primary" title="Statistiques" aria-label="Afficher les statistiques">
        <i class="fas fa-chart-bar"></i> Stats
      </button>
      <button id="btnChangeMode" class="btn btn-secondary" onclick="openStartupModal()" title="Changer de mode">
        <i class="fas fa-exchange-alt"></i> Mode
      </button>
    </div>

    <!-- DROITE -->
    <nav class="flex items-center gap-3" role="navigation" aria-label="Menus d'actions">
      <!-- Menu Paramètres -->
      <div class="relative" id="settingsMenuWrapper">
        <button id="btnSettings" class="btn btn-secondary flex items-center gap-2" title="Paramètres et options" aria-expanded="false" aria-haspopup="menu">
          <i class="fas fa-cog"></i> Paramètres <i class="fas fa-caret-down"></i>
        </button>
        <div id="settingsDropdown" class="absolute right-0 mt-2 w-72 bg-white rounded shadow-lg z-50 hidden overflow-hidden" role="menu" aria-hidden="true">

          <!-- Section Affichage -->
          <div class="settings-section">
            <div class="settings-section-header">
              <i class="fas fa-palette"></i> Affichage
            </div>
            <button id="menuDarkMode" class="settings-item" role="menuitem">
              <i class="fas fa-moon"></i> Mode sombre
            </button>
            <button id="menuZoom" class="settings-item" role="menuitem">
              <i class="fas fa-search-plus"></i> Zoom cartes
            </button>
            <button id="menuFullscreen" class="settings-item" role="menuitem">
              <i class="fas fa-expand"></i> Plein écran
            </button>
          </div>

          <!-- Section Actions -->
          <div class="settings-section">
            <div class="settings-section-header">
              <i class="fas fa-bolt"></i> Actions
            </div>
            <div class="flex gap-1 px-4 py-2">
              <button id="btnUndo" class="flex-1 settings-item-inline" disabled role="menuitem">
                <i class="fas fa-undo"></i> Annuler
              </button>
              <button id="btnRedo" class="flex-1 settings-item-inline" disabled role="menuitem">
                <i class="fas fa-redo"></i> Refaire
              </button>
            </div>
            <button id="btnSwap" class="settings-item" role="menuitem">
              <i class="fas fa-exchange-alt"></i> Mode Swap
            </button>
            <button id="btnHistory" class="settings-item" role="menuitem">
              <i class="fas fa-history"></i> Historique
            </button>
            <button id="menuBookmarks" class="settings-item" role="menuitem">
              <i class="fas fa-bookmark"></i> Favoris
            </button>
            <button id="menuOptimize" class="settings-item" role="menuitem">
              <i class="fas fa-magic"></i> Optimiser
            </button>
            <button id="menuConstraints" class="settings-item" role="menuitem">
              <i class="fas fa-link"></i> Contraintes
            </button>
            <button id="menuFilters" class="settings-item" role="menuitem">
              <i class="fas fa-filter"></i> Filtres
            </button>
          </div>

          <!-- Section Données -->
          <div class="settings-section">
            <div class="settings-section-header">
              <i class="fas fa-database"></i> Données
            </div>
            <button id="menuImportScores" class="settings-item" role="menuitem">
              <i class="fas fa-upload"></i> Import Scores
            </button>
            <button id="btnSave" class="settings-item" role="menuitem">
              <i class="fas fa-save"></i> Sauvegarder
            </button>
            <button id="btnExport" class="settings-item" role="menuitem">
              <i class="fas fa-download"></i> Export
            </button>
            <button id="menuRules" class="settings-item" role="menuitem">
              <i class="fas fa-edit"></i> Règles
            </button>
          </div>

          <!-- Section Filtres -->
          <div class="settings-section">
            <div class="settings-section-header">
              <i class="fas fa-filter"></i> Filtres
            </div>
            <div class="px-4 py-2 grid grid-cols-2 gap-1">
              <button class="filter-btn-compact" data-filter="all">Tous</button>
              <button class="filter-btn-compact" data-filter="PERMUT">PERMUT</button>
              <button class="filter-btn-compact" data-filter="FIXE">FIXE</button>
              <button class="filter-btn-compact" data-filter="ESP">ESP</button>
              <button class="filter-btn-compact" data-filter="ITA">ITA</button>
              <button class="filter-btn-compact" data-filter="ALL">ALL</button>
              <button class="filter-btn-compact" data-filter="D">Disso</button>
              <button class="filter-btn-compact" data-filter="A">Asso</button>
            </div>
          </div>

          <!-- Section Aide -->
          <div class="settings-section">
            <div class="settings-section-header">
              <i class="fas fa-question-circle"></i> Aide
            </div>
            <button id="btnHelp" class="settings-item" role="menuitem">
              <i class="fas fa-keyboard"></i> Raccourcis
            </button>
            <button id="btnTutorial" class="settings-item" role="menuitem">
              <i class="fas fa-graduation-cap"></i> Tutoriel
            </button>
          </div>

        </div>
      </div>

      <!-- Admin toujours visible -->
      <button id="btnAdmin" class="btn btn-admin" title="Mode administrateur" aria-label="Activer le mode administrateur">
        <i class="fas fa-unlock-alt"></i> Admin
      </button>
    </nav>
  </div>
</header>

<!-- Zone principale -->
<main class="w-full" role="main" aria-label="Répartition des élèves">
  <div id="board"></div>
</main>

<!-- Panneau de feedback en temps réel (pour les groupes uniquement) -->
<div id="feedbackPanel" class="feedback-panel" style="display: none;" role="complementary" aria-live="polite" aria-label="Statistiques en temps réel">
  <div class="feedback-header">
    <span><i class="fas fa-chart-line mr-2"></i>Indicateurs Groupes</span>
    <div class="flex gap-2">
      <button id="minimizeFeedback" class="text-white hover:text-yellow-200 transition-colors" aria-label="Réduire le panneau">
        <i class="fas fa-minus"></i>
      </button>
      <button id="closeFeedback" class="text-white hover:text-red-200 transition-colors" aria-label="Fermer le panneau">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="feedback-content">
    <div class="feedback-metric">
      <span class="metric-label">Équilibre F/M</span>
      <div class="metric-value" id="balanceMetric" aria-atomic="true">
        <span id="balanceValue">0.0</span>
        <div class="metric-change neutral" id="balanceChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Contraintes</span>
      <div class="metric-value" id="constraintsMetric" aria-atomic="true">
        <span id="constraintsValue">0</span>
        <div class="metric-change neutral" id="constraintsChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Diversité</span>
      <div class="metric-value" id="diversityMetric" aria-atomic="true">
        <span id="diversityValue">0.0</span>
        <div class="metric-change neutral" id="diversityChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Taille groupes</span>
      <div class="metric-value" id="sizeMetric" aria-atomic="true">
        <span id="sizeValue">0.0</span>
        <div class="metric-change neutral" id="sizeChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Équilibre scores</span>
      <div class="metric-value" id="scoresMetric" aria-atomic="true">
        <span id="scoresValue">0.0</span>
        <div class="metric-change neutral" id="scoresChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Mobilité</span>
      <div class="metric-value" id="mobilityMetric" aria-atomic="true">
        <span id="mobilityValue">0.0</span>
        <div class="metric-change neutral" id="mobilityChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Score global</span>
      <div class="metric-value" id="globalScoreMetric" aria-atomic="true">
        <span id="globalScoreValue">0.0</span>
        <div class="metric-change neutral" id="globalScoreChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Panel historique (initialement caché) -->
<div id="historyPanel" class="history-panel">
  <div class="p-4 border-b">
    <h3 class="font-bold text-lg flex items-center justify-between">
      Historique des actions
      <button onclick="toggleHistoryPanel()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </h3>
  </div>
  <div id="historyTimeline" class="history-timeline"></div>
</div>

<!-- Menu bookmarks (dropdown) -->
<div class="relative">
  <div id="bookmarksMenu" class="bookmarks-menu">
    <div id="bookmarksList"></div>
    <div class="new-bookmark-form">
      <button class="btn btn-primary w-full" onclick="saveAsBookmark()">
        <i class="fas fa-plus"></i> Nouveau favori
      </button>
    </div>
  </div>
</div>

<!-- Panneau rétractable de lisibilité (initialement caché) -->
<div id="lisibilite-panel" class="fixed top-0 left-0 w-full bg-white shadow-lg z-50 transition-transform duration-300 transform -translate-y-full" style="padding: 24px 0 12px 0;">
  <div class="max-w-6xl mx-auto px-6">
    <div class="flex flex-row items-center justify-between mb-6">
      <div class="text-xl font-bold"><i class="fa fa-eye mr-2"></i>Options de lisibilité</div>
      <button id="close-lisibilite-panel" class="text-gray-500 hover:text-gray-800 text-2xl px-4 focus:outline-none" title="Fermer"><i class="fa fa-times"></i></button>
    </div>
    
    <!-- Options de lisibilité -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      
      <!-- Taille des noms -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Taille des noms</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite" data-size="small">Petite</button>
          <button class="btn-lisibilite active" data-size="medium">Moyenne</button>
          <button class="btn-lisibilite" data-size="large">Grande</button>
          <button class="btn-lisibilite" data-size="xlarge">Très grande</button>
        </div>
      </div>
      
      <!-- Style des noms -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Style des noms</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite active" data-style="normal">Normal</button>
          <button class="btn-lisibilite" data-style="bold">Gras</button>
          <button class="btn-lisibilite" data-style="highlight">Surligné</button>
          <button class="btn-lisibilite" data-style="outline">Encadré</button>
        </div>
      </div>
      
      <!-- Contraste -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Contraste</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite active" data-contrast="normal">Normal</button>
          <button class="btn-lisibilite" data-contrast="high">Élevé</button>
          <button class="btn-lisibilite" data-contrast="max">Maximum</button>
        </div>
      </div>
      
      <!-- Symboles genres -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Affichage genres</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite active" data-symbols="colors">Couleurs</button>
          <button class="btn-lisibilite" data-symbols="symbols">Symboles</button>
          <button class="btn-lisibilite" data-symbols="both">Couleurs + Symboles</button>
        </div>
      </div>
      
    </div>
    
    <!-- Boutons d'action -->
    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
      <button id="reset-lisibilite" class="btn btn-secondary">
        <i class="fas fa-undo"></i> Réinitialiser
      </button>
      <button id="fullscreen-mode" class="btn btn-primary">
        <i class="fas fa-expand"></i> Mode plein écran
      </button>
    </div>
  </div>
</div>

<script>
// =======================================================
// FONCTIONS UTILITAIRES GLOBALES (accessibles partout)
// =======================================================

// 🔧 PROTECTION REALTIME FEEDBACK
window.RealTimeFeedback = window.RealTimeFeedback || null;


// ========== BARRE DE PROGRESSION SAUVEGARDE ==========
class SaveProgressManager {
  constructor() {
    this.progressBar = null;
    this.progressFill = null;
    this.progressPercentage = null;
    this.currentSave = null;
    this.init();
  }
  
  init() {
    // Créer la barre de progression dynamiquement
    const progressHTML = `
      <div id="saveProgressBar" class="save-progress-bar">
        <div class="save-progress-header">
          <span><i class="fas fa-save mr-2"></i>Création des onglets INT...</span>
          <button id="minimizeProgress" class="text-white hover:text-yellow-200 transition-colors">
            <i class="fas fa-minus"></i>
          </button>
        </div>
        <div class="save-progress-content">
          <div class="progress-bar-container">
            <div id="progressBarFill" class="progress-bar-fill"></div>
          </div>
          <div id="progressPercentage" class="text-center text-sm font-semibold text-gray-700">0%</div>
          <div class="progress-steps">
            <div id="step1" class="progress-step">
              <i class="fas fa-circle-notch"></i>
              <span>Préparation des données...</span>
            </div>
            <div id="step2" class="progress-step">
              <i class="fas fa-circle-notch"></i>
              <span>Validation LV2 obligatoire...</span>
            </div>
            <div id="step3" class="progress-step">
              <i class="fas fa-circle-notch"></i>
              <span>Création onglets INT...</span>
            </div>
            <div id="step4" class="progress-step">
              <i class="fas fa-circle-notch"></i>
              <span>Formatage automatique...</span>
            </div>
            <div id="step5" class="progress-step">
              <i class="fas fa-circle-notch"></i>
              <span>Finalisation...</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', progressHTML);
    
    this.progressBar = document.getElementById('saveProgressBar');
    this.progressFill = document.getElementById('progressBarFill');
    this.progressPercentage = document.getElementById('progressPercentage');
    
    this.setupEventListeners();
  }
  
  setupEventListeners() {
    const minimizeBtn = document.getElementById('minimizeProgress');
    if (minimizeBtn) {
      minimizeBtn.addEventListener('click', () => this.toggleMinimize());
    }
  }
  
  start() {
    if (this.currentSave) {
      toast('Une sauvegarde est déjà en cours...', 'warning');
      return false;
    }
    this.currentSave = Date.now();
    this.show();
    this.updateProgress(0, 'step1');
    return true;
  }
  
  show() {
    if (this.progressBar) {
      this.progressBar.classList.add('show');
    }
  }
  
  hide() {
    if (this.progressBar) {
      this.progressBar.classList.remove('show');
    }
    this.currentSave = null;
    setTimeout(() => this.reset(), 300);
  }
  
  updateProgress(percentage, activeStep) {
    if (this.progressFill) {
      this.progressFill.style.width = percentage + '%';
    }
    if (this.progressPercentage) {
      this.progressPercentage.textContent = Math.round(percentage) + '%';
    }
    
    const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
    const activeIndex = steps.indexOf(activeStep);
    
    steps.forEach((stepId, index) => {
      const stepElement = document.getElementById(stepId);
      if (!stepElement) return;
      
      const icon = stepElement.querySelector('i');
      if (index < activeIndex) {
        stepElement.className = 'progress-step completed';
        icon.className = 'fas fa-check-circle';
      } else if (index === activeIndex) {
        stepElement.className = 'progress-step active';
        icon.className = 'fas fa-spinner';
      } else {
        stepElement.className = 'progress-step';
        icon.className = 'fas fa-circle-notch';
      }
    });
  }
  
  complete(success = true) {
    if (success) {
      this.updateProgress(100, 'step5');
      ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(stepId => {
        const stepElement = document.getElementById(stepId);
        if (stepElement) {
          stepElement.className = 'progress-step completed';
          stepElement.querySelector('i').className = 'fas fa-check-circle';
        }
      });
      
      const header = this.progressBar?.querySelector('.save-progress-header span');
      if (header) {
        header.innerHTML = '<i class="fas fa-check mr-2"></i>Onglets INT créés et formatés !';
      }
      setTimeout(() => this.hide(), 2000);
    } else {
      const header = this.progressBar?.querySelector('.save-progress-header span');
      if (header) {
        header.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Erreur création INT';
        header.parentElement.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
      }
      setTimeout(() => this.hide(), 3000);
    }
  }
  
  reset() {
    this.updateProgress(0, 'step1');
    const header = this.progressBar?.querySelector('.save-progress-header span');
    if (header) {
      header.innerHTML = '<i class="fas fa-save mr-2"></i>Création des onglets INT...';
      header.parentElement.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    }
  }
  
  toggleMinimize() {
    // Implémentation simple du toggle
    const content = this.progressBar?.querySelector('.save-progress-content');
    if (content) {
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }
  }
}

// Initialiser le gestionnaire
window.saveProgressManager = new SaveProgressManager();

// Fonction de sauvegarde avec barre de progression
async function saveWithProgressINT() {
  if (!window.saveProgressManager.start()) return;
  
  try {
    // Étape 1 : Préparation (25%)
    window.saveProgressManager.updateProgress(25, 'step1');
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const disposition = exportDisposition();
    if (Object.keys(disposition).length === 0) {
      throw new Error('Aucune classe à sauvegarder');
    }
    
    // Étape 2 : Validation LV2 (50%)
    window.saveProgressManager.updateProgress(50, 'step2');
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Étape 3 : Création des onglets INT (75%)
    window.saveProgressManager.updateProgress(75, 'step3');
    
    const result = await gsRun('saveElevesSnapshot', disposition);
    if (!result?.success) {
      throw new Error(result?.error || 'Erreur serveur');
    }
    
    // Étape 4 : Formatage automatique (90%)
    window.saveProgressManager.updateProgress(90, 'step4');
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Étape 5 : Finalisation (100%)
    window.saveProgressManager.updateProgress(100, 'step5');
    await new Promise(resolve => setTimeout(resolve, 200));
    
    window.saveProgressManager.complete(true);
    toast(`Onglets INT créés et formatés avec succès pour ${Object.keys(disposition).length} classes`, 'success');
    
  } catch (error) {
    console.error('Erreur création onglets INT:', error);
    window.saveProgressManager.complete(false);
    toast('Erreur: ' + error.message, 'error');
  }
}

// ========== ANCIENNES FONCTIONS MIGRÉES VERS App.* ==========
// Les fonctions suivantes ont été déplacées vers l'architecture modulaire :
// - toast() -> App.UI.toast()
// - adjustSimpleNamesFontSize() -> App.UI.adjustSimpleNamesFontSize()
// - isRealClass() -> App.Utils.isRealClass()
// - updateColumnStats() -> App.UI.updateColumnStats()
// - updateAllColumnStats() -> App.UI.updateAllColumnStats()
// - updateAdvancedStats() -> App.Stats.updateAdvancedStats()
// - exportDisposition() -> App.Data.exportDisposition()
// - saveImmediateCache() -> App.Data.saveImmediateCache()
// - updateUndoRedoButtons() -> App.History.updateUndoRedoButtons()
//
// Des wrappers globaux sont disponibles pour compatibilité (voir section WRAPPERS ci-dessous)
// undo() et redo() migrés vers App.History

// ========== APPELS GOOGLE APPS SCRIPT ==========
function gsRun(fnName, ...args) {
  return new Promise((resolve, reject) => {
    console.log(`📡 Appel fonction: ${fnName}`);
    
    try {
      // Vérifier si on est dans l'environnement Google Apps Script
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        const api = google.script.run;
        
        if (typeof api[fnName] === 'function') {
          // Appel correct : d'abord les handlers, puis la fonction
          api
            .withSuccessHandler((result) => {
              console.log(`✅ ${fnName} succès:`, result);
              resolve(result);
            })
            .withFailureHandler((error) => {
              console.error(`❌ ${fnName} erreur:`, error);
              reject(error);
            })[fnName](...args);
          return;
        }
      }
                
    } catch (error) {
      console.error(`💥 Erreur dans gsRun:`, error);
      reject(error);
    }
  });
}

// ========== FONCTION AFFICHAGE D'ERREUR UNIVERSELLE ==========
function showErrorState(message, suggestions = []) {
  const board = document.getElementById('board');
  if (!board) {
    console.error('Élément #board introuvable');
    return;
  }
  
  const defaultSuggestions = [
    'Vérifiez que vos onglets se terminent par "TEST" (ex: 4°1TEST, 4°2TEST...)',
    'Assurez-vous que vos onglets contiennent des données avec au moins les colonnes ID et NOM',
    'Créez un onglet "_STRUCTURE" avec les règles de répartition',
    'Vérifiez la configuration de votre Google Sheet'
  ];
  
  const allSuggestions = suggestions.length > 0 ? suggestions : defaultSuggestions;
  
  board.innerHTML = `
    <div class="col-span-full">
      <div class="error-container">
        <div class="error-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 class="error-title">Aucune donnée trouvée</h2>
        <div class="error-message">
          ${message}
        </div>
        <div class="error-suggestions">
          <h3 class="font-semibold mb-2">Suggestions pour résoudre le problème :</h3>
          <ul>
            ${allSuggestions.map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>
        <div class="mt-4">
          <button onclick="attemptRefresh()" class="btn btn-primary">
            <i class="fas fa-sync"></i> Réessayer
          </button>
          <button onclick="createDemoStructure()" class="btn btn-secondary ml-3">
            <i class="fas fa-plus"></i> Créer structure exemple
          </button>
        </div>
      </div>
    </div>
  `;
}

// ========== DÉTECTION AUTOMATIQUE DU NIVEAU ==========
function detectNiveau(data) {
  if (!data || data.length === 0) return '';
  
  // Analyser les noms de classes pour détecter le niveau
  const classes = data.map(group => group.classe);
  const niveaux = new Set();
  
  classes.forEach(classe => {
    const match = classe.match(/^(\d°)/);
    if (match) {
      niveaux.add(match[1]);
    }
  });
  
  if (niveaux.size === 1) {
    return Array.from(niveaux)[0];
  } else if (niveaux.size > 1) {
    return `Multi-niveaux (${Array.from(niveaux).join(', ')})`;
  }
  
  return 'Niveau non détecté';
}

// ========== FONCTION DE TRI DES COLONNES ==========
function sortColumn(classe, sortType, direction = 'asc') {
  const dropZone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
  if (!dropZone) return;

  const cards = Array.from(dropZone.querySelectorAll('.student-card'));
  const students = cards.map(card => ({
    card,
    data: STATE.students[card.dataset.id]
  }));

  // facteur : +1 en asc, -1 en desc
  const f = direction === 'asc' ? 1 : -1;

  switch (sortType) {
    /* --- NOM ------------------------------------------------------- */
    case 'name':
      students.sort((a, b) => f * a.data.nom.localeCompare(b.data.nom));
      break;

    /* --- LV2 ------------------------------------------------------- */
    case 'lv2':
      students.sort((a, b) => {
        const ordre = ['ESP', 'ITA', 'ALL', 'LATIN', 'GRECO'];
        const iA = ordre.indexOf((a.data.lv2 || '').toUpperCase());
        const iB = ordre.indexOf((b.data.lv2 || '').toUpperCase());
        return f * ((iA === -1 ? 999 : iA) - (iB === -1 ? 999 : iB));
      });
      break;

    /* --- OPTION ---------------------------------------------------- */
    case 'option':
      students.sort((a, b) => {
        if (!a.data.opt && !b.data.opt) return 0;
        if (!a.data.opt) return  f;   // « sans option » en bas quand asc
        if (!b.data.opt) return -f;
        return f * a.data.opt.localeCompare(b.data.opt);
      });
      break;

    /* --- SCORE COM ---------------------------------------------- */
    case 'score':
      students.sort((a, b) => {
        // Tri par score COM uniquement
        const scoreA = a.data.scores.COM || 0;
        const scoreB = b.data.scores.COM || 0;
        return f * (scoreB - scoreA); // décroissant en asc
      });
      break;
  }

  /* ré-injection dans le DOM */
  dropZone.innerHTML = '';
  students.forEach(({ card }) => dropZone.appendChild(card));

  /* mémorise le dernier tri */
  STATE.sortOrder[classe] = { type: sortType, dir: direction };
}

// ========== FONCTION DE VALIDATION DES MOUVEMENTS ==========
function canMove(eleveId, srcClasse, dstClasse) {
  if (STATE.adminMode || srcClasse === dstClasse) return { ok: true };

  const e = STATE.students[eleveId];
  const dr = STATE.rules[dstClasse] || {};
  const dc = getCurrentClassContent(dstClasse);

  /* 🔒 FIXE : jamais de déplacement */
  if (e.mobilite === 'FIXE')
    return { ok:false, reason:`${e.nom} est FIXE dans sa classe` };

  /* 🔒 PERMUT : BLOQUÉ EN DRAG&DROP NORMAL */
  if (e.mobilite === 'PERMUT')
    return { ok:false, reason:`${e.nom} est PERMUT - utilisez le mode SWAP` };

    /* 🔒 SPEC : même règle que FIXE  (option prioritaire) */
if (e.mobilite === 'SPEC')
  return { ok:false, reason:`${e.nom} est SPEC (option obligatoire)` };

  /* 🔒 DISSOCIATION : BLOQUÉ EN DRAG&DROP NORMAL */
  if (e.disso)
    return { ok:false, reason:`${e.nom} a un code D${e.disso} - utilisez le mode SWAP` };

  /* CAPACITÉ : on avertit mais on autorise */
  if (dr.capacity && dc.length >= dr.capacity) {
    return {
      ok: true,
      warn: `${dstClasse} dépasse sa capacité (${dr.capacity})`
    };
  }

  /* ASSOCIATION */
  if (e.asso) {
    const grp = STATE.aGroups[`A${e.asso}`] || [];
    const encSrc = grp.filter(id => id !== eleveId)
                      .some(id => document.querySelector(`.student-card[data-id="${id}"]`)
                                   ?.closest('.droppable-zone').dataset.classe === srcClasse);
    if (encSrc)
      return { ok:false, reason:`Groupe A${e.asso} doit bouger ensemble (mode Swap ou Admin)` };
  }

  /* VÉRIFIER LV2 et OPTIONS */
  const checkTag = (tag, label) => {
    const tagUp = String(tag || '').trim().toUpperCase();
    if (!tagUp) return true;

    /* LV2 ESP autorisé partout */
    if (label === 'LV2' && tagUp === 'ESP') return true;

    /* Aucune règle pour la classe ➜ tout interdit */
    if (!dr.quotas || Object.keys(dr.quotas).length === 0) {
      return { ok:false, reason:`${label} ${tagUp} interdit dans ${dstClasse} (aucun quota défini)` };
    }

    /* Tag absent dans les quotas ➜ interdit */
    if (!(tagUp in dr.quotas)) {
      return { ok:false, reason:`${label} ${tagUp} interdit dans ${dstClasse}` };
    }

    /* Quota à 0 ➜ interdit */
    if (dr.quotas[tagUp] === 0) {
      return { ok:false, reason:`${label} ${tagUp} interdit dans ${dstClasse} (quota 0)` };
    }

    /* Élèves déjà présents avec ce tag */
    const currentCnt = dc.filter(id => {
      const s = STATE.students[id];
      return s && (String(s.lv2).toUpperCase() === tagUp ||
                   String(s.opt).toUpperCase() === tagUp);
    }).length;

    if (currentCnt >= dr.quotas[tagUp]) {
      return { ok:false, reason:`Quota ${tagUp} atteint (${dr.quotas[tagUp]})` };
    }

    return true;
  };

  const r1 = checkTag(e.lv2, 'LV2');
  if (r1 !== true) return r1;
  console.log(eleveId, e.opt)
  const r2 = checkTag(e.opt, 'Option');
  if (r2 !== true) return r2;

  return { ok:true };
}

// ========== FONCTION UTILITAIRE POUR RÉCUPÉRER LE CONTENU D'UNE CLASSE ==========
function getCurrentClassContent(classe) {
  const dropZone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
  if (!dropZone) return [];
  
  return Array.from(dropZone.querySelectorAll('.student-card'))
    .map(card => card.dataset.id);
}

// ========== FONCTIONS DE GESTION DES SWAPS ==========
function canSwap(id1, id2) {
  const card1 = document.querySelector(`.student-card[data-id="${id1}"]`);
  const card2 = document.querySelector(`.student-card[data-id="${id2}"]`);
  
  if (!card1 || !card2) return { ok: false, reason: 'Élève introuvable' };
  
  const classe1 = card1.closest('.droppable-zone').dataset.classe;
  const classe2 = card2.closest('.droppable-zone').dataset.classe;
  
  if (classe1 === classe2) return { ok: false, reason: 'Même classe' };
  
  const eleve1 = STATE.students[id1];
  const eleve2 = STATE.students[id2];
  
  // Mode admin : tout est permis
  if (STATE.adminMode) return { ok: true };
  
  // FIXE et SPEC : jamais déplaçables
  if (eleve1.mobilite === 'FIXE' || eleve2.mobilite === 'FIXE') {
    return { ok: false, reason: 'FIXE ne peut pas bouger' };
  }
  
  if (eleve1.mobilite === 'SPEC' || eleve2.mobilite === 'SPEC') {
    return { ok: false, reason: 'SPEC ne peut pas bouger' };
  }
  
  // MÊME CODE D = SWAP OK
  if (eleve1.disso && eleve2.disso && eleve1.disso === eleve2.disso) {
    return { ok: true };
  }
  
  // PERMUT : vérifier compatibilité
  if (eleve1.mobilite === 'PERMUT' && eleve2.mobilite === 'PERMUT') {
    const lv1 = (eleve1.lv2 || '').toUpperCase();
    const lv2 = (eleve2.lv2 || '').toUpperCase();
    
    if (lv1 === 'ESP' || lv2 === 'ESP') {
      return { ok: true };
    }
    
    if (lv1 !== lv2) {
      return { ok: false, reason: `PERMUT : LV2 différentes` };
    }
    
    return { ok: true };
  }
  
  if (eleve1.mobilite === 'PERMUT' || eleve2.mobilite === 'PERMUT') {
    return { ok: false, reason: 'PERMUT ne peut échanger qu\'avec un autre PERMUT' };
  }
  
  // Vérifier codes D différents
  if (eleve1.disso || eleve2.disso) {
    if (eleve1.disso) {
      const dejaPresent = getCurrentClassContent(classe2).some(id => {
        const s = STATE.students[id];
        return s && s.disso === eleve1.disso && id !== id2;
      });
      
      if (dejaPresent) {
        return { ok: false, reason: `Un D${eleve1.disso} est déjà dans ${classe2}` };
      }
    }
    
    if (eleve2.disso) {
      const dejaPresent = getCurrentClassContent(classe1).some(id => {
        const s = STATE.students[id];
        return s && s.disso === eleve2.disso && id !== id1;
      });
      
      if (dejaPresent) {
        return { ok: false, reason: `Un D${eleve2.disso} est déjà dans ${classe1}` };
      }
    }
  }
  
  // Vérifier les quotas basiques
  const dr1 = STATE.rules[classe2] || {};
  const dr2 = STATE.rules[classe1] || {};
  
  if (eleve1.lv2 && eleve1.lv2.toUpperCase() !== 'ESP') {
    if (!dr1.quotas || dr1.quotas[eleve1.lv2.toUpperCase()] === 0) {
      return { ok: false, reason: `${eleve1.lv2} interdit dans ${classe2}` };
    }
  }
  
  if (eleve2.lv2 && eleve2.lv2.toUpperCase() !== 'ESP') {
    if (!dr2.quotas || dr2.quotas[eleve2.lv2.toUpperCase()] === 0) {
      return { ok: false, reason: `${eleve2.lv2} interdit dans ${classe1}` };
    }
  }
  
  return { ok: true };
}

function performSwap(id1, id2) {
  const card1 = document.querySelector(`.student-card[data-id="${id1}"]`);
  const card2 = document.querySelector(`.student-card[data-id="${id2}"]`);
  
  if (!card1 || !card2) return;
  
  const zone1 = card1.closest('.droppable-zone');
  const zone2 = card2.closest('.droppable-zone');
  
  if (!zone1 || !zone2) return;
  
  // Animation de swap
  card1.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  card2.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  
  // Échanger les cartes
  zone2.appendChild(card1);
  zone1.appendChild(card2);
  
  // Historique
  const swapAction = {
    type: 'swap',
    id1, id2,
    eleve1Name: STATE.students[id1]?.nom || 'Élève 1',
    eleve2Name: STATE.students[id2]?.nom || 'Élève 2',
    classe1: zone1.dataset.classe,
    classe2: zone2.dataset.classe,
    timestamp: new Date().toISOString()
  };
  STATE.history.push(swapAction);
  STATE.historyTimeline.push(swapAction);
  STATE.future = [];
  updateUndoRedoButtons();
  
  // Mettre à jour le panneau historique
  updateHistoryPanel();
  
  // ✅ UNE SEULE mise à jour des colonnes
  updateAllColumnStats();
  
  // ✅ UNE SEULE mise à jour des stats avancées avec délai
  setTimeout(() => updateAdvancedStats(), 150);
  
  // Feedback temps réel
if (window.RealTimeFeedback) {
  window.RealTimeFeedback.updateMetrics();
}
  
  // Sauvegarde
  if (STATE.currentMode === 'CACHE') {
    setTimeout(() => saveImmediateCache(), 200);
  }
  
  const eleve1 = STATE.students[id1];
  const eleve2 = STATE.students[id2];
  toast(`Swap réussi entre ${eleve1.nom} et ${eleve2.nom}`, 'success');
}

function handleCardClick(e) {
  if (!STATE.swapMode) return;
  
  const card = e.currentTarget;
  const eleveId = card.dataset.id;
  const eleve = STATE.students[eleveId];
  
  // Première sélection
  if (!STATE.swapFirst) {
    STATE.swapFirst = eleveId;
    card.classList.add('swap-mode');
    
    let msg = `${eleve.nom} sélectionné`;
    if (eleve.mobilite === 'PERMUT') msg += ' (PERMUT)';
    else if (eleve.disso) msg += ` (D${eleve.disso})`;
    msg += ' – choisissez un élève à échanger';
    toast(msg, 'info');
    
    // Mettre en évidence les autres colonnes
    document.querySelectorAll('.droppable-zone').forEach(zone => {
      if (zone.dataset.classe !== card.closest('.droppable-zone').dataset.classe) {
        zone.classList.add('swap-target');
      }
    });
    return;
  }
  
  // Deuxième sélection
  const firstId = STATE.swapFirst;
  const firstCard = document.querySelector(`.student-card[data-id="${firstId}"]`);
  
  // Même élève : annuler
  if (eleveId === firstId) {
    firstCard.classList.remove('swap-mode');
    document.querySelectorAll('.droppable-zone').forEach(z => z.classList.remove('swap-target'));
    STATE.swapFirst = null;
    return;
  }
  
  // Vérifier et effectuer le swap
  const check = canSwap(firstId, eleveId);
  if (check.ok) {
    performSwap(firstId, eleveId);
  } else {
    toast(check.reason, 'error');
  }
  
  // Nettoyer l'état
  firstCard.classList.remove('swap-mode');
  document.querySelectorAll('.student-card').forEach(c => c.classList.remove('swap-mode'));
  document.querySelectorAll('.droppable-zone').forEach(z => z.classList.remove('swap-target'));
  STATE.swapFirst = null;
}

// ========== FONCTION HELPER POUR SIMPLIFIER LES NOMS COMPOSÉS ==========
// VERSION 4.0 - Harmonisée avec InterfaceV2
console.log('🔄 VERSION 4.0 - Fonction simplifierNomComplet chargée dans Phase4UI');

function simplifierNomComplet(nom, prenom) {
  if (
    typeof window !== 'undefined' &&
    window.simplifierNomComplet &&
    typeof window.simplifierNomComplet === 'function' &&
    window.simplifierNomComplet.version === '4.0' &&
    window.simplifierNomComplet !== simplifierNomComplet
  ) {
    return window.simplifierNomComplet(nom, prenom);
  }

  if (!nom || !prenom) return nom || prenom || '';

  nom = nom.trim().replace(/\s+/g, ' ');
  prenom = prenom.trim().replace(/\s+/g, ' ');

  const nomSimple = nom.split(/[\s-]+/)[0];

  let prenomSimple = prenom;
  if (/[\s-]/.test(prenom)) {
    const parts = prenom.split(/[\s-]+/);
    prenomSimple = parts[0];
    if (parts.length > 1 && parts[0].length < 8) {
      prenomSimple += `-${parts[1].charAt(0)}.`;
    }
  }

  if (prenomSimple.length > 12) {
    prenomSimple = prenomSimple.substring(0, 10) + '.';
  }

  let resultat = `${nomSimple} ${prenomSimple}`;

  const MAX_LENGTH = 25;
  if (resultat.length > MAX_LENGTH) {
    const nomLength = nomSimple.length;
    const availableForPrenom = MAX_LENGTH - nomLength - 1;

    if (availableForPrenom < prenomSimple.length) {
      prenomSimple = prenomSimple.substring(0, Math.max(3, availableForPrenom - 1)) + '.';
      resultat = `${nomSimple} ${prenomSimple}`;
    }
  }

  if (nom !== nomSimple || prenom !== prenomSimple) {
    console.log(`✂️ Phase4UI v4.0 - Nom simplifié: "${nom} ${prenom}" → "${resultat}" (${resultat.length} car.)`);
  }

  return resultat;
}

simplifierNomComplet.version = '4.0';

if (
  typeof window !== 'undefined' &&
  (!window.simplifierNomComplet || window.simplifierNomComplet.version !== '4.0')
) {
  window.simplifierNomComplet = simplifierNomComplet;
  console.log('✅ Phase4UI v4.0 - simplifierNomComplet exposée globalement');
}

// ========== FONCTION DE CRÉATION DES CARTES ÉLÈVES ==========
function createStudentCard(eleve) {
  /* --- STOP "CARTE VIDE" : on ignore les enregistrements sans id --- */
  if (!eleve || !eleve.id || !eleve.id.trim()) return null;
  /* ---------------------------------------------------------------- */

  const template = document.querySelector('#tpl-carte-eleve');
  const card = template.content.cloneNode(true).children[0];

  card.dataset.id = eleve.id;
  card.classList.add(`sexe-${eleve.sexe}`);

  // Attributs ARIA pour la carte élève
  const nomCompletAria = eleve.prenom ? `${eleve.nom} ${eleve.prenom}` : eleve.nom;
  card.setAttribute('role', 'listitem');
  card.setAttribute('aria-label', nomCompletAria);
  card.setAttribute('aria-grabbed', 'false');

  // ========== MODE SIMPLE : FOND BLANC + POLICE COULEUR SEXE + SOULIGNE ROUGE SI COM=1 ==========
  if (STATE.viewMode === 'simple') {
    card.classList.add('simple-mode');
    card.innerHTML = `<div class="simple-line">
      <span class="student-simple-name"></span>
    </div>`;
    const nameEl = card.querySelector('.student-simple-name');

    // Nom complet simplifié
    let nomComplet = simplifierNomComplet(eleve.nom, eleve.prenom);

    // Couleur de police selon sexe
    let couleurTexte = '#333'; // Gris foncé par défaut
    if (eleve.sexe === 'F') {
      couleurTexte = '#ec4899'; // Rose pour F
    } else if (eleve.sexe === 'M') {
      couleurTexte = '#3b82f6'; // Bleu pour M
    }

    // Souligné rouge si score COM = 1
    let soulignement = 'none';
    let couleurSoulignement = '';
    if (eleve.scores && eleve.scores.COM && parseInt(eleve.scores.COM) === 1) {
      soulignement = 'underline';
      couleurSoulignement = '#FF0000'; // Rouge
    }

    // Appliquer les styles
    nameEl.textContent = nomComplet;
    nameEl.style.display = 'block';
    nameEl.style.textAlign = 'center';
    nameEl.style.fontSize = '1.1rem';
    nameEl.style.fontWeight = '600';
    nameEl.style.padding = '8px';
    nameEl.style.color = couleurTexte;
    nameEl.style.textDecoration = soulignement;
    nameEl.style.overflow = 'hidden';
    nameEl.style.textOverflow = 'ellipsis';
    nameEl.style.whiteSpace = 'nowrap';
    nameEl.style.maxWidth = '100%';
    if (soulignement === 'underline') {
      nameEl.style.textDecorationColor = couleurSoulignement;
      nameEl.style.textDecorationThickness = '3px';
      nameEl.style.textUnderlineOffset = '3px';
    }

    card.style.background = '#fff'; // Fond blanc pour tous
    card.style.border = '1px solid rgba(0,0,0,0.1)';
    card.style.borderRadius = '6px';
  } else if (STATE.viewMode === 'essential') {
    // Mode essentiel : nom + badges essentiels (pas d'options ni scores)
    const fullNameElement = card.querySelector('.student-fullname');
    const nomComplet = simplifierNomComplet(eleve.nom, eleve.prenom);
    fullNameElement.textContent = nomComplet;

    // NOM EN ROUGE si score COM = 1
    if (eleve.scores && eleve.scores.COM && parseInt(eleve.scores.COM) === 1) {
      fullNameElement.style.color = '#FF0000';
      fullNameElement.style.fontWeight = '700';
    }

    // Badges essentiels : LV2, OPT, DISSO, ASSO (PAS DE DISPO)
    const allBadgesContainer = card.querySelector('.all-badges');
    allBadgesContainer.style.justifyContent = 'center';

    let totalBadges = 0;
    if (eleve.mobilite && eleve.mobilite !== 'LIBRE') totalBadges++;
    if (eleve.disso) totalBadges++;
    if (eleve.asso) totalBadges++;
    if (eleve.lv2) totalBadges++;
    const compactMode = totalBadges > 3;

    // Badge Mobilité
    if (eleve.mobilite && eleve.mobilite !== 'LIBRE') {
      const badge = document.createElement('span');
      let mobText = eleve.mobilite;
      let mobClass = 'badge-mobilite';
      if (compactMode) {
        const abrevMap = {'CONDI': 'CO', 'FIXE': 'FI', 'PERMUT': 'PER', 'SPEC': 'SP'};
        mobText = abrevMap[eleve.mobilite] || eleve.mobilite;
        mobClass += ' badge-compact';
      }
      badge.className = `mini-badge ${mobClass}`;
      badge.textContent = mobText;
      badge.title = `Mobilité: ${eleve.mobilite}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge Dissociation
    if (eleve.disso) {
      const badge = document.createElement('span');
      badge.className = 'mini-badge badge-disso';
      badge.textContent = eleve.disso.replace(/^D/i, 'D');
      badge.title = `Dissociation: ${eleve.disso}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge Association
    if (eleve.asso) {
      const badge = document.createElement('span');
      badge.className = 'mini-badge badge-asso';
      badge.textContent = eleve.asso.replace(/^A/i, 'A');
      badge.title = `Association: ${eleve.asso}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge LV2
    if (eleve.lv2 && eleve.lv2.trim()) {
      const badge = document.createElement('span');
      badge.className = `mini-badge badge-${eleve.lv2.toUpperCase()}`;
      badge.textContent = eleve.lv2.toUpperCase();
      badge.title = `LV2: ${eleve.lv2}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge OPT
    if (eleve.opt && eleve.opt.trim()) {
      const badge = document.createElement('span');
      badge.className = `mini-badge badge-${eleve.opt.toUpperCase()}`;
      badge.textContent = eleve.opt.toUpperCase();
      badge.title = `Option: ${eleve.opt}`;
      allBadgesContainer.appendChild(badge);
    }

    // Source uniquement (pas de scores)
    card.querySelector('.source-class').textContent = eleve.source || '';
    card.querySelector('.scores').innerHTML = '';
  } else {
    // ========== MODE COMPLETE: NOM + LV2/OPT + BADGES SCORES ==========
    const fullNameElement = card.querySelector('.student-fullname');
    const nomComplet = simplifierNomComplet(eleve.nom, eleve.prenom);
    fullNameElement.textContent = nomComplet;
    fullNameElement.className = 'student-fullname';

    // NOM EN ROUGE si score COM = 1
    if (eleve.scores && eleve.scores.COM && parseInt(eleve.scores.COM) === 1) {
      fullNameElement.style.color = '#FF0000';
      fullNameElement.style.fontWeight = '700';
    }
    
    // Badge DISPO (nom complet)
    const dispoContainer = card.querySelector('.badge-dispo-container');
    if (eleve.dispo && eleve.dispo.trim()) {
      const dispoBadge = document.createElement('span');
      dispoBadge.className = 'badge-dispo';
      const dispoValue = eleve.dispo.toUpperCase().trim();
      dispoBadge.textContent = dispoValue; // Afficher le nom complet
      dispoBadge.title = `Dispositif: ${eleve.dispo}`;
      dispoContainer.appendChild(dispoBadge);
    }

    // ========== LIGNE 2: TOUS LES BADGES (LV2, OPT, DISSO, ASSO) ==========
    const allBadgesContainer = card.querySelector('.all-badges');
    allBadgesContainer.style.justifyContent = 'center';

    // Badge LV2
    if (eleve.lv2 && eleve.lv2.trim()) {
      const badge = document.createElement('span');
      badge.className = `mini-badge badge-${eleve.lv2.toUpperCase()}`;
      badge.textContent = eleve.lv2.toUpperCase();
      badge.title = `LV2: ${eleve.lv2}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge Option
    if (eleve.opt && eleve.opt.trim()) {
      const badge = document.createElement('span');
      badge.className = `mini-badge badge-${eleve.opt.toUpperCase()}`;
      badge.textContent = eleve.opt.toUpperCase();
      badge.title = `Option: ${eleve.opt}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge Dissociation
    if (eleve.disso) {
      const badge = document.createElement('span');
      badge.className = 'mini-badge badge-disso';
      badge.textContent = eleve.disso.replace(/^D/i, 'D');
      badge.title = `Dissociation: ${eleve.disso}`;
      allBadgesContainer.appendChild(badge);
    }

    // Badge Association
    if (eleve.asso) {
      const badge = document.createElement('span');
      badge.className = 'mini-badge badge-asso';
      badge.textContent = eleve.asso.replace(/^A/i, 'A');
      badge.title = `Association: ${eleve.asso}`;
      allBadgesContainer.appendChild(badge);
    }
    
    // ========== LIGNE 3: Source + Scores ==========
    card.querySelector('.source-class').textContent = eleve.source || '';
    
    // Badges scores COM/TRA/PART/ABS avec lettres et couleurs
    const scoresContainer = card.querySelector('.scores');
    const scoreMap = [
      { key: 'COM', label: 'Comportement', letter: 'C' },
      { key: 'TRA', label: 'Travail', letter: 'T' },
      { key: 'PART', label: 'Participation', letter: 'P' },
      { key: 'ABS', label: 'Absences', letter: 'A' }
    ];
    scoreMap.forEach(({ key, label, letter }) => {
      const value = eleve.scores[key];
      if (value && value > 0) {
        const pill = document.createElement('div');
        pill.className = `score-pill score-${value}`;
        pill.textContent = letter; // Afficher la LETTRE (C, T, P, A)
        pill.title = `${label}: ${value}/4`;
        scoresContainer.appendChild(pill);
      }
    });
  }
  
  // Event listeners pour drag & drop et swap
  card.addEventListener('dragstart', handleDragStart);
  card.addEventListener('dragend', handleDragEnd);
  card.addEventListener('click', handleCardClick);
  
  return card;
}

// ========== FONCTION DE CRÉATION DES COLONNES DE CLASSE ==========
function createClassColumn(classe, eleves) {
  // On retire d'emblée les enregistrements "vides"
  const clean = eleves.filter(e => e && e.id && e.id.trim());

  const column = document.querySelector('#tpl-classe-col')
                 .content.cloneNode(true).children[0];

  // Attributs ARIA pour la colonne
  const classHeader = column.querySelector('.class-header');
  if (classHeader) {
    classHeader.id = `class-header-${classe}`;
  }
  column.setAttribute('role', 'region');
  column.setAttribute('aria-labelledby', `class-header-${classe}`);

  column.querySelector('.classe-name').textContent = classe;
  column.querySelector('.count').textContent   = clean.length;
  column.querySelector('.count-f').textContent = clean.filter(e => e.sexe === 'F').length;
  column.querySelector('.count-m').textContent = clean.filter(e => e.sexe === 'M').length;

  const dropZone = column.querySelector('.droppable-zone');
  dropZone.dataset.classe = classe;
  dropZone.setAttribute('role', 'list');
  dropZone.setAttribute('aria-label', `Liste des élèves de ${classe}`);

  // Boutons de tri
  column.querySelectorAll('.sort-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      const sortType = e.currentTarget.dataset.sort;
      const prev     = STATE.sortOrder[classe] || {};
      const dir      = (prev.type === sortType && prev.dir === 'asc') ? 'desc' : 'asc';

      sortColumn(classe, sortType, dir);

      // Feedback visuel
      column.querySelectorAll('.sort-btn').forEach(b => {
        const i = b.querySelector('i');
        if (b === e.currentTarget) {
          b.classList.add('active');
          i.classList.toggle('fa-sort-up',   dir === 'asc');
          i.classList.toggle('fa-sort-down', dir === 'desc');
        } else {
          b.classList.remove('active');
          i.classList.remove('fa-sort-up', 'fa-sort-down');
        }
      });
    });
  });

  // Drag-and-drop
  dropZone.addEventListener('dragover',  handleDragOver);
  dropZone.addEventListener('drop',      handleDrop);
  dropZone.addEventListener('dragleave', handleDragLeave);

  const sortable = new Sortable(dropZone, {
    group: 'students',
    animation: 150,
    ghostClass: 'opacity-50',
    dragClass: 'dragging',
    onEnd: handleSortEnd,
    onStart: (evt) => {
      console.log('🖱️ Drag started:', evt.item.dataset.id);
      // Stocker l'élément en cours de déplacement
      STATE.draggingElement = evt.item;
      STATE.dragStartZone = evt.from;
    },
    onMove: (evt) => {
      console.log('🖱️ Drag move:', evt.dragged.dataset.id, 'from', evt.from.dataset.classe, 'to', evt.to.dataset.classe);
    }
  });
  
  // (SUPPRIMÉ : double appel de handleSortEnd - onEnd de SortableJS suffit)
  
  console.log('🔧 Sortable créé pour zone:', dropZone.dataset.classe);

  // Cartes élèves
  clean.forEach(e => {
    const c = createStudentCard(e);
    if (c) dropZone.appendChild(c);
  });

  // Adaptation dynamique de la taille des noms en vue simplifiée
  setTimeout(() => adjustSimpleNamesFontSize(dropZone), 0);
  return column;
}

// ========== HANDLERS DRAG & DROP ==========
function handleDragStart(e) {
  if (STATE.swapMode) return; // Pas de drag en mode swap

  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', e.target.dataset.id);
  // Mettre à jour aria-grabbed
  e.target.setAttribute('aria-grabbed', 'true');
  e.target.classList.add('dragging');
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  // Remettre aria-grabbed à false
  e.target.setAttribute('aria-grabbed', 'false');
  document.querySelectorAll('.drag-over, .drop-forbidden').forEach(el => {
    el.classList.remove('drag-over', 'drop-forbidden');
  });
}

function handleDragOver(e) {
  if (STATE.swapMode) return;
  e.preventDefault();
  
  // Vérifier si le drop est autorisé
  const draggedId = e.dataTransfer.getData('text/plain') || 
    document.querySelector('.dragging')?.dataset.id;
  
  if (draggedId) {
    const draggedCard = document.querySelector(`.student-card[data-id="${draggedId}"]`);
    if (draggedCard) {
      const srcClasse = draggedCard.closest('.droppable-zone').dataset.classe;
      const dstClasse = e.currentTarget.dataset.classe;
      
      const check = canMove(draggedId, srcClasse, dstClasse);
      
      if (check.ok || STATE.adminMode) {
        e.currentTarget.classList.add('drag-over');
        e.currentTarget.classList.remove('drop-forbidden');
        
        // Prévisualiser l'impact du déplacement
        if (window.RealTimeFeedback && srcClasse !== dstClasse) {
  window.RealTimeFeedback.previewMove(draggedId, dstClasse);
}
      } else {
        e.currentTarget.classList.add('drop-forbidden');
        e.currentTarget.classList.remove('drag-over');
        
        // Réinitialiser les changements si drop interdit
        if (window.RealTimeFeedback) {
  window.RealTimeFeedback.resetChanges();
        }
      }
    }
  }
}

function handleDragLeave(e) {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('drag-over', 'drop-forbidden');
    
    // Réinitialiser les changements quand on quitte la zone
    if (RealTimeFeedback) {
      RealTimeFeedback.resetChanges();
    }
  }
}

function handleDrop(e) {
  if (STATE.swapMode) return;
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over', 'drop-forbidden');
}

// ========== FONCTION DE RAFRAÎCHISSEMENT ==========
window.attemptRefresh = async function() {
  console.log('🔄 Tentative de rafraîchissement...');
  const currentMode = localStorage.getItem('mode-selection') || 'TEST';
  const success = await loadDataForMode(currentMode);
  if (!success) {
    // Si échec, essayer de recharger complètement
    await initRepartitionApp();
  }
}

// ========== CRÉER STRUCTURE EXEMPLE ==========
window.createDemoStructure = async function() {
  try {
    const result = await gsRun('createDemoStructure');
    if (result) {
      toast('Structure d\'exemple créée ! Actualisez la page.', 'success');
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      toast('Erreur lors de la création de la structure', 'error');
    }
  } catch (error) {
    console.error('Erreur createDemoStructure:', error);
    toast('Impossible de créer la structure exemple', 'error');
  }
}

// REMPLACER handleSortEnd par :
window.handleSortEnd = function(evt) {
  console.log('🎯 handleSortEnd CLEAN');
  
  if (STATE.swapMode) return;

  const eleveId = evt.item.dataset.id;
  const oldClasse = evt.from.dataset.classe;
  const newClasse = evt.to.dataset.classe;

  // Si même classe, juste mise à jour des colonnes
  if (oldClasse === newClasse) {
    updateAllColumnStats(); // ← CET APPEL MANQUE PEUT-ÊTRE
    if (window.RealTimeFeedback) window.RealTimeFeedback.updateMetrics();
    return;
  }

  const check = canMove(eleveId, oldClasse, newClasse);

  if (!check.ok && !STATE.adminMode) {
    evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex] || null);
    toast(check.reason, 'error');
    updateAllColumnStats(); // ← CET APPEL MANQUE PEUT-ÊTRE
    return;
  }

  if (check.warn && !STATE.adminMode) {
    toast(check.warn, 'warning');
  }

  // Historique
  const moveAction = {
    type: 'move', 
    eleveId, 
    eleveName: STATE.students[eleveId]?.nom || 'Élève',
    oldClasse, 
    newClasse,
    oldIndex: evt.oldIndex, 
    newIndex: evt.newIndex,
    timestamp: new Date().toISOString()
  };
  STATE.history.push(moveAction);
  STATE.historyTimeline.push(moveAction);
  STATE.future = [];
  updateUndoRedoButtons();
  
  // Mettre à jour le panneau historique
  updateHistoryPanel();

  // ✅ UNE SEULE mise à jour des colonnes
  updateAllColumnStats(); // ← CET APPEL DOIT ÊTRE PRÉSENT
  
  // ✅ UNE SEULE mise à jour des stats avancées avec délai
  setTimeout(() => updateAdvancedStats(), 150);
  
  // Feedback temps réel
  if (RealTimeFeedback) RealTimeFeedback.updateMetrics();
  
  // Sauvegarde
  if (STATE.currentMode === 'CACHE') {
    setTimeout(() => saveImmediateCache(), 200);
  }
};

// REMPLACER updateStatsPanel par cette version simplifiée :
window.updateStatsPanel = function() {
  console.log('📊 updateStatsPanel appelée');
  
  const panel = document.getElementById('statsPanel');
  if (!panel || panel.classList.contains('translate-x-full')) {
    console.log('📊 Panneau fermé, skip');
    return;
  }
  
  // Récupérer le type de score actuel ou utiliser 'COM' par défaut
  const scoreType = typeof currentScoreType !== 'undefined' ? currentScoreType : 'COM';
  
  // Forcer la mise à jour complète des graphiques
  updateCharts(scoreType, true);
  
  console.log('📊 Mise à jour du panneau terminée');
};



// ========== FONCTION MANQUANTE - Chargement des données selon le mode ==========
async function loadDataForMode(mode) {
  showSpinner();
  try {
    // Appel à la fonction Google Apps Script pour récupérer les données
    const result = await gsRun('getClassesData', mode);
    if (!result || !result.success) {
      console.error('❌ Erreur lors du chargement des données:', result?.error);
      return false;
    }
    // Stocker les données dans STATE
    STATE.originalData = result.data;
    STATE.rules = result.rules || {};
    STATE.niveau = detectNiveau(result.data);
    // Mettre à jour l'interface
    const niveauElement = document.getElementById('niveau-detected');
    if (niveauElement) {
      niveauElement.textContent = STATE.niveau;
    }
    // Créer le dictionnaire des élèves et les groupes
    STATE.students = {};
    STATE.aGroups = {};
    result.data.forEach(group => {
      group.eleves.forEach(eleve => {
        STATE.students[eleve.id] = eleve;
        // Grouper les associations
        if (eleve.asso) {
          const key = `A${eleve.asso}`;
          if (!STATE.aGroups[key]) STATE.aGroups[key] = [];
          STATE.aGroups[key].push(eleve.id);
        }
      });
    });
    // Afficher les colonnes
    renderBoard(result.data);
    return true;
  } catch (error) {
    console.error('💥 Erreur fatale:', error);
    return false;
  } finally {
    hideSpinner();
  }
}

// ========== FONCTION - Affichage des colonnes/classes ==========
function renderBoard(data) {
  const board = document.getElementById('board');
  if (!board) {
    console.error('Élément #board introuvable');
    return;
  }

  board.innerHTML = '';
  if (!data || data.length === 0) {
    showErrorState('Aucune classe trouvée');
    return;
  }

  /* --- tri naturel des intitulés "6°1", "6°2", … --- */
  const sortedData = data.slice().sort((a, b) => {
    const ma = a.classe.match(/(\d+)°(\d+)/);
    const mb = b.classe.match(/(\d+)°(\d+)/);
    if (ma && mb) {
      const nivA = +ma[1], nivB = +mb[1];
      if (nivA !== nivB) return nivA - nivB;
      return +ma[2] - +mb[2];
    }
    return a.classe.localeCompare(b.classe);
  });

  /* --- création des colonnes --- */
  sortedData.forEach(group => {
    const col = createClassColumn(group.classe, group.eleves);
    if (col) board.appendChild(col);
  });

  /* --- ajustements de présentation --- */
  setTimeout(resizeCards, 100);
  updateAllColumnStats();              // <-- nouvelle ligne : compteurs à jour !

  if (STATE.viewMode === 'simple') {
    setTimeout(() => {
      document.querySelectorAll('.droppable-zone')
              .forEach(zone => adjustSimpleNamesFontSize(zone));
    }, 120);
  }

  if (window.applyLisibilitePreferences) {
    window.applyLisibilitePreferences();
  }

  /* --- initialisation des graphiques --- */
  setTimeout(() => {
    if (typeof initCharts === 'function') {
      initCharts();
      console.log('📊 Graphiques initialisés après chargement des données');
    }
  }, 200);
}

// ========== FONCTION MANQUANTE - AFFICHAGE DU BADGE DE MODE ==========
function showModeBadge(mode) {
  const badge = document.getElementById('modeBadge');
  if (badge) {
    badge.textContent = 'MODE ' + mode;
    badge.style.background = mode === 'INT' ? '#10b981' : mode === 'CACHE' ? '#f59e0b' : '#3b82f6';
    badge.style.color = 'white';
    badge.classList.remove('hidden');
  }
}

// ========== FONCTIONS MANQUANTES - Auto-save ==========
function startAutoSave() {
  stopAutoSave(); // ← On s'assure qu'il n'y en a qu'un
  console.log('🔄 Auto-save CACHE activé (1 minute)');
  autoSaveInterval = setInterval(async () => {
    const disposition = exportDisposition();
    const cacheData = {
      date: new Date().toISOString(),
      disposition: disposition,
      mode: STATE.currentMode
    };

    // Sauvegarde locale dans le navigateur
    localStorage.setItem('cache-data', JSON.stringify(cacheData));
    console.log('💾 Auto-save LOCAL effectué');

    // Sauvegarde distante dans le backend (PropertiesService + onglets CACHE)
    if (typeof gsRun === 'function') {
      try {
        const result = await gsRun('saveCacheData', cacheData);
        if (result && result.success) {
          console.log('💾 Auto-save BACKEND réussi');
        } else {
          console.warn('⚠️ Auto-save BACKEND échoué:', result?.error);
        }
      } catch (error) {
        console.error('❌ Erreur auto-save BACKEND:', error);
      }
    }
  }, 60000); // Toutes les 1 minute
}

function stopAutoSave() {
  if (autoSaveInterval !== null) { // ← Vérifie l'existence
    clearInterval(autoSaveInterval);
    autoSaveInterval = null;
    console.log('⏹️ Auto-save arrêté');
  }
}

// ========== FONCTION MANQUANTE - Vérifier le cache ==========
async function checkCache() {
  const restoreBlock = document.getElementById('restoreCacheBlock');
  const lastDate = document.getElementById('lastCacheDate');

  // 1. Vérifier d'abord le localStorage
  const cached = localStorage.getItem('cache-data');
  if (cached) {
    try {
      const data = JSON.parse(cached);
      if (restoreBlock) restoreBlock.classList.remove('hidden');
      if (lastDate) {
        lastDate.textContent = new Date(data.date).toLocaleString('fr-FR');
      }
      return; // On a trouvé des données dans le localStorage
    } catch (e) {
      console.error('Cache localStorage invalide:', e);
    }
  }

  // 2. Si pas de localStorage, vérifier le backend (PropertiesService)
  try {
    console.log('🔍 Vérification de la sauvegarde automatique depuis le backend...');
    const backendCache = await gsRun('getLastCacheInfo');

    if (backendCache && backendCache.exists && backendCache.date) {
      console.log('✅ Sauvegarde automatique trouvée dans le backend:', backendCache);
      if (restoreBlock) restoreBlock.classList.remove('hidden');
      if (lastDate) {
        const date = new Date(backendCache.date);
        lastDate.textContent = date.toLocaleString('fr-FR');
      }
    } else {
      console.log('ℹ️ Aucune sauvegarde automatique trouvée');
      if (restoreBlock) restoreBlock.classList.add('hidden');
    }
  } catch (error) {
    console.error('❌ Erreur lors de la vérification du cache backend:', error);
  }
}

// ========== FONCTION MANQUANTE - Restaurer le cache ==========
async function restoreCache() {
  const cached = localStorage.getItem('cache-data');
  if (!cached) return;
  try {
    const data = JSON.parse(cached);
    localStorage.setItem('mode-selection', data.mode);
    await initRepartitionApp();
    // Appliquer la disposition sauvegardée
    if (data.disposition) {
      Object.entries(data.disposition).forEach(([classe, ids]) => {
        const zone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
        if (zone) {
          ids.forEach(id => {
            const card = document.querySelector(`.student-card[data-id="${id}"]`);
            if (card) zone.appendChild(card);
          });
        }
      });
    }
    updateAllColumnStats();
    toast('Cache restauré avec succès', 'success');
  } catch (e) {
    console.error('Erreur restauration cache:', e);
    toast('Erreur lors de la restauration', 'error');
  }
}

// =======================================================
// VARIABLES GLOBALES
// =======================================================
let autoSaveInterval = null;

// DÉPLACER STATE ICI !
let STATE = {
    viewMode: localStorage.getItem('viewMode') || 'complete',
    students: {},
    rules: {},
    aGroups: {},
    history: [],
    historyTimeline: [], // Ajouté pour le panneau historique
    future: [],
    swapMode: false,
    swapFirst: null,
    adminMode: false,
    searchTerm: '',
    darkMode: false,
    zoomMode: false,
    fullscreenStats: false,
    anchoredStats: false,
    currentMode: null,
    originalData: null,
    niveau: '',
    sortOrder: {},
    lastSaveError: false,
    draggingElement: null,
    dragStartZone: null
};

// Variables pour les graphiques (les déplacer aussi)
window.chartCommunication = null;
window.chartDistribution = null;
window.chartLV2 = null;
window.chartOptions = null;

// ============================================
// ARCHITECTURE MODULAIRE
// ============================================
/**
 * Architecture modulaire de l'application InterfaceV2
 *
 * Cette section organise le code JavaScript en modules logiques pour améliorer
 * l'organisation et la maintenabilité du code (12561 lignes).
 *
 * DOCUMENTATION COMPLÈTE : Voir ARCHITECTURE_MODULAIRE.md
 *
 * MODULES DISPONIBLES :
 * - App.state       : État global de l'application (alias de STATE)
 * - App.UI          : Création et manipulation des éléments UI
 * - App.DragDrop    : Gestion du drag and drop
 * - App.Views       : Gestion des différentes vues (simple, complete, swap, dark mode)
 * - App.History     : Historique et undo/redo
 * - App.Stats       : Statistiques et métriques
 * - App.Constraints : Validation des contraintes
 * - App.Data        : Import/Export et sauvegarde
 * - App.Search      : Recherche et filtres
 * - App.Utils       : Fonctions utilitaires
 * - App.Init        : Initialisation de l'application
 *
 * COMPATIBILITÉ :
 * Des fonctions wrapper globales sont disponibles pour assurer la compatibilité
 * avec le code existant. Voir section "FONCTIONS WRAPPER POUR COMPATIBILITÉ" ci-dessous.
 *
 * UTILISATION :
 * // Nouveau code (recommandé)
 * App.UI.toast('Message', 'success');
 *
 * // Code legacy (toujours supporté via wrappers)
 * toast('Message', 'success');
 *
 * MIGRATION EN COURS :
 * ✅ App.UI          - toast, updateColumnStats, showSpinner, etc.
 * ✅ App.History     - undo, redo, updateUndoRedoButtons
 * ✅ App.Stats       - updateAdvancedStats
 * ✅ App.Data        - exportDisposition, saveImmediateCache
 * ✅ App.Utils       - isRealClass
 * ⏳ App.Views       - À migrer : toggleViewMode, toggleSwapMode, etc.
 * ⏳ App.DragDrop    - À migrer : handleDragStart, handleDrop, etc.
 * ⏳ App.Constraints - À migrer : canMove, canSwap
 * ⏳ App.Search      - À migrer : searchStudents, filterByTag
 * ⏳ App.Init        - À migrer : setupEventListeners, initApp
 */

const App = {
  // ============================================
  // ÉTAT GLOBAL (référence vers STATE)
  // ============================================
  get state() {
    return STATE;
  },

  // ============================================
  // MODULE UI - Création et manipulation des éléments
  // ============================================
  UI: {
    /**
     * Affiche une notification toast
     * @param {string} message - Message à afficher
     * @param {string} type - Type de notification (info, success, error, warning)
     */
    toast(message, type = 'info') {
      const icons = {
        info: 'fa-info-circle',
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle'
      };

      const isSwapError = type === 'error';
      const toast = document.createElement('div');

      if (isSwapError) {
        toast.className = `toast ${type} fade-in`;
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 9999;
          font-size: 1.5rem;
          padding: 24px 40px;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
          border-radius: 12px;
          background: #dc2626;
          color: white;
          border: none;
          font-weight: 600;
          min-width: 400px;
          text-align: center;
        `;
      } else {
        toast.className = `toast ${type} fixed bottom-4 right-4 z-50 fade-in`;
      }

      toast.innerHTML = `
        <i class="fas ${icons[type]} ${isSwapError ? 'text-2xl mr-3' : 'text-lg'}"></i>
        <span>${message}</span>
      `;

      document.body.appendChild(toast);

      const duration = isSwapError ? 4000 : 3000;

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    },

    /**
     * Met à jour les statistiques d'une colonne de classe
     * @param {HTMLElement} column - Élément DOM de la colonne
     * @param {Array} eleves - Liste des élèves
     */
    updateColumnStats(column, eleves) {
      if (!column) return;

      const count   = eleves.length;
      const countF  = eleves.filter(e => e.sexe === 'F').length;
      const countM  = eleves.filter(e => e.sexe === 'M').length;

      column.querySelector('.count').textContent    = count;
      column.querySelector('.count-f').textContent  = countF;
      column.querySelector('.count-m').textContent  = countM;

      const scoreCats = ['C', 'T', 'P', 'A'];
      const counters  = { C:[0,0,0,0], T:[0,0,0,0], P:[0,0,0,0], A:[0,0,0,0] };

      eleves.forEach(e => {
        scoreCats.forEach(cat => {
          const v = +e.scores?.[cat] || 0;
          if (v >= 1 && v <= 4) counters[cat][v-1]++;
        });
      });

      scoreCats.forEach(cat => {
        counters[cat].forEach((val, i) => {
          const el = column.querySelector(`.count-${cat.toLowerCase()}${i+1}`);
          if (el) el.textContent = val;
        });
      });
    },

    /**
     * Met à jour les statistiques de toutes les colonnes
     */
    updateAllColumnStats() {
      console.log('📊 App.UI.updateAllColumnStats - version modulaire');

      document.querySelectorAll('.class-column').forEach(column => {
        const className = column.querySelector('.classe-name').textContent;
        if (!App.Utils.isRealClass(className)) return;

        const dropZone = column.querySelector('.droppable-zone');
        const cards = Array.from(dropZone.querySelectorAll('.student-card'));
        const eleves = cards.map(card => STATE.students[card.dataset.id]).filter(Boolean);

        App.UI.updateColumnStats(column, eleves);
      });
    },

    /**
     * Ajuste la taille de police des noms en vue simplifiée
     * @param {HTMLElement} dropZone - Zone de dépôt
     */
    adjustSimpleNamesFontSize(dropZone) {
      if (!STATE || STATE.viewMode !== 'simple') return;
      const cards = Array.from(dropZone.querySelectorAll('.student-card'));
      if (cards.length === 0) return;

      let zoneHeight = dropZone.clientHeight || dropZone.offsetHeight || 0;
      if (!zoneHeight) {
        const parent = dropZone.closest('.class-column');
        if (parent) zoneHeight = parent.clientHeight || parent.offsetHeight || 0;
      }
      if (!zoneHeight) return;

      const availableHeight = zoneHeight - 30;
      const minFont = 16;
      const maxFont = 32;
      let fontSize = Math.floor(availableHeight / cards.length) - 2;

      if (isNaN(fontSize) || fontSize < minFont) fontSize = minFont;
      if (fontSize > maxFont) fontSize = maxFont;

      cards.forEach(card => {
        const nameEl = card.querySelector('.student-simple-name');
        const lineEl = card.querySelector('.simple-line');
        if (nameEl) {
          nameEl.style.fontSize = fontSize + 'px';
          nameEl.style.lineHeight = (fontSize + 2) + 'px';
        }
        if (lineEl) {
          lineEl.style.height = (fontSize + 6) + 'px';
        }
      });
    },

    /**
     * Affiche/masque le spinner de chargement
     */
    showSpinner() {
      document.getElementById('loadingSpinner')?.classList.remove('hidden');
    },

    hideSpinner() {
      document.getElementById('loadingSpinner')?.classList.add('hidden');
    }
  },

  // ============================================
  // MODULE DRAG & DROP
  // ============================================
  DragDrop: {
    // Ces fonctions seront migrées depuis le code existant
    // Pour l'instant, on laisse des placeholders qui appelleront les fonctions globales
  },

  // ============================================
  // MODULE VIEWS - Gestion des vues
  // ============================================
  Views: {
    // Placeholders pour les fonctions de vue
  },

  // ============================================
  // MODULE HISTORY - Historique et undo/redo
  // ============================================
  History: {
    /**
     * Met à jour l'état des boutons undo/redo
     */
    updateUndoRedoButtons() {
      const btnUndo = document.getElementById('btnUndo');
      const btnRedo = document.getElementById('btnRedo');

      if (btnUndo) btnUndo.disabled = STATE.history.length === 0;
      if (btnRedo) btnRedo.disabled = STATE.future.length === 0;
    },

    /**
     * Annule la dernière action
     */
    undo() {
      if (STATE.history.length === 0) return;

      const action = STATE.history.pop();
      STATE.future.push(action);

      // Retirer aussi de historyTimeline
      if (STATE.historyTimeline.length > 0) {
        STATE.historyTimeline.pop();
      }

      if (action.type === 'move') {
        const card = document.querySelector(`.student-card[data-id="${action.eleveId}"]`);
        const oldZone = document.querySelector(`.droppable-zone[data-classe="${action.oldClasse}"]`);

        if (card && oldZone) {
          // Insérer à l'ancienne position si possible
          if (action.oldIndex < oldZone.children.length) {
            oldZone.insertBefore(card, oldZone.children[action.oldIndex]);
          } else {
            oldZone.appendChild(card);
          }
        }
      } else if (action.type === 'swap') {
        if (typeof performSwap === 'function') {
          performSwap(action.id2, action.id1); // Swap inverse
          STATE.history.pop(); // Enlever le swap ajouté par performSwap
        }
      }

      App.History.updateUndoRedoButtons();
      App.UI.updateAllColumnStats();

      // Mettre à jour le panneau historique
      if (typeof updateHistoryPanel === 'function') {
        updateHistoryPanel();
      }

      // Mise à jour intelligente des statistiques
      setTimeout(() => App.Stats.updateAdvancedStats(), 150);

      // Sauvegarde après undo
      if (STATE.currentMode === 'CACHE') {
        App.Data.saveImmediateCache();
      }
    },

    /**
     * Refait la dernière action annulée
     */
    redo() {
      if (STATE.future.length === 0) return;

      const action = STATE.future.pop();

      if (action.type === 'move') {
        const card = document.querySelector(`.student-card[data-id="${action.eleveId}"]`);
        const newZone = document.querySelector(`.droppable-zone[data-classe="${action.newClasse}"]`);

        if (card && newZone) {
          if (action.newIndex < newZone.children.length) {
            newZone.insertBefore(card, newZone.children[action.newIndex]);
          } else {
            newZone.appendChild(card);
          }
        }
        STATE.history.push(action);
        // Ajouter aussi à historyTimeline pour le panneau historique
        STATE.historyTimeline.push(action);
      } else if (action.type === 'swap') {
        if (typeof performSwap === 'function') {
          performSwap(action.id1, action.id2);
        }
      }

      App.History.updateUndoRedoButtons();
      App.UI.updateAllColumnStats();

      // Mettre à jour le panneau historique
      if (typeof updateHistoryPanel === 'function') {
        updateHistoryPanel();
      }

      // Mise à jour intelligente des statistiques
      setTimeout(() => App.Stats.updateAdvancedStats(), 150);

      // Sauvegarde après redo
      if (STATE.currentMode === 'CACHE') {
        App.Data.saveImmediateCache();
      }
    }
  },

  // ============================================
  // MODULE STATS - Statistiques
  // ============================================
  Stats: {
    /**
     * Met à jour les statistiques avancées
     */
    updateAdvancedStats() {
      console.log('📊 App.Stats.updateAdvancedStats',
                  'chartsReady=', window.areChartsReady?.(),
                  'typeof updateCharts =', typeof updateCharts);

      const panel = document.getElementById('statsPanel');
      if (!panel || panel.classList.contains('translate-x-full')) {
        console.log('📊 Panneau fermé, skip mise à jour');
        return;
      }

      if (typeof updateNewMetrics === 'function') {
        console.log('🔢 updateNewMetrics lancé');
        updateNewMetrics();
      }

      console.log('📊 Appel de updateCharts()...');
      if (typeof updateCharts === 'function') {
        updateCharts();
      }
      console.log('📊 updateCharts() terminé');

      if (typeof updateLV2Details === 'function') {
        updateLV2Details();
      }
    }
  },

  // ============================================
  // MODULE CONSTRAINTS - Validation
  // ============================================
  Constraints: {
    // Placeholders pour les fonctions de contraintes
  },

  // ============================================
  // MODULE DATA - Import/Export
  // ============================================
  Data: {
    /**
     * Exporte la disposition actuelle
     * @returns {Object} Disposition des classes
     */
    exportDisposition() {
      const result = {};
      document.querySelectorAll('.class-column').forEach(column => {
        const classe = column.querySelector('.classe-name').textContent;
        const ids = Array.from(column.querySelectorAll('.student-card')).map(card => card.dataset.id);
        result[classe] = ids;
      });
      return result;
    },

    /**
     * Sauvegarde immédiate dans le cache
     */
    async saveImmediateCache() {
      try {
        const disposition = App.Data.exportDisposition();
        const cacheData = {
          date: new Date().toISOString(),
          disposition: disposition,
          mode: STATE.currentMode
        };

        localStorage.setItem('cache-data', JSON.stringify(cacheData));

        if (typeof gsRun === 'function') {
          try {
            const result = await gsRun('saveCacheData', cacheData);
            if (result && result.success) {
              console.log('💾 Sauvegarde automatique CACHE réussie');
            } else {
              console.warn('⚠️ Sauvegarde CACHE échouée:', result?.error);
            }
          } catch (error) {
            console.error('❌ Erreur sauvegarde CACHE:', error);
          }
        }
      } catch (error) {
        console.error('❌ Erreur dans saveImmediateCache:', error);
      }
    }
  },

  // ============================================
  // MODULE SEARCH - Recherche et filtres
  // ============================================
  Search: {
    // Placeholders pour les fonctions de recherche
  },

  // ============================================
  // MODULE UTILS - Utilitaires
  // ============================================
  Utils: {
    /**
     * Vérifie si un nom de classe est une vraie classe (pas un groupe)
     * @param {string} className - Nom de la classe
     * @returns {boolean}
     */
    isRealClass(className) {
      const groupPatterns = [
        /^level_/i,
        /^grp_/i,
        /^groupe_/i,
        /^group_/i,
        /_Groupe\d*$/i,
        /^ESP_/i,
        /^ITA_/i,
        /^ALL_/i,
        /^LATIN_/i,
        /^MATH_/i,
        /^FR_/i,
        /^Niveau/i
      ];

      for (const pattern of groupPatterns) {
        if (pattern.test(className)) {
          return false;
        }
      }

      const classPattern = /^\d+°\d+$/;
      return classPattern.test(className);
    }
  },

  // ============================================
  // MODULE INIT - Initialisation
  // ============================================
  Init: {
    // Placeholders pour l'initialisation
  }
};

// ============================================
// FONCTIONS WRAPPER POUR COMPATIBILITÉ
// ============================================
/**
 * Ces fonctions wrapper assurent la compatibilité avec les event handlers HTML existants
 * et le code legacy. Elles délèguent simplement vers les modules appropriés.
 */

// Wrapper pour toast
function toast(message, type = 'info') {
  return App.UI.toast(message, type);
}

// Wrapper pour updateColumnStats
function updateColumnStats(column, eleves) {
  return App.UI.updateColumnStats(column, eleves);
}

// Wrapper pour updateAllColumnStats
function updateAllColumnStats() {
  return App.UI.updateAllColumnStats();
}

// Wrapper pour adjustSimpleNamesFontSize
function adjustSimpleNamesFontSize(dropZone) {
  return App.UI.adjustSimpleNamesFontSize(dropZone);
}

// Wrapper pour isRealClass
function isRealClass(className) {
  return App.Utils.isRealClass(className);
}

// Wrapper pour exportDisposition
function exportDisposition() {
  return App.Data.exportDisposition();
}

// Wrapper pour saveImmediateCache
async function saveImmediateCache() {
  return App.Data.saveImmediateCache();
}

// Wrapper pour updateUndoRedoButtons
function updateUndoRedoButtons() {
  return App.History.updateUndoRedoButtons();
}

// Wrapper pour updateAdvancedStats
function updateAdvancedStats() {
  return App.Stats.updateAdvancedStats();
}

// Wrapper pour undo
function undo() {
  return App.History.undo();
}

// Wrapper pour redo
function redo() {
  return App.History.redo();
}

// Wrapper pour showSpinner/hideSpinner
function showSpinner() {
  return App.UI.showSpinner();
}

function hideSpinner() {
  return App.UI.hideSpinner();
}

// =======================================================
// FONCTIONS GLOBALES (Legacy - À migrer progressivement)
// =======================================================
// showSpinner() et hideSpinner() migrés vers App.UI






// ========== AJUSTEMENT TAILLE DES CARTES ==========
function resizeCards(){
  document.querySelectorAll('.student-card').forEach(card=>{
    const w = card.offsetWidth;
    // Toujours retirer toutes les classes
    card.classList.remove('card-sm','card-md','card-lg');
    // Puis ajouter la classe appropriée
    if     (w > 320) card.classList.add('card-lg');
    else if(w > 240) card.classList.add('card-md');
    else             card.classList.add('card-sm');
  });
}






// ========== FONCTION D'OUVERTURE DU MODAL DE DÉMARRAGE ==========
// Fonction déjà définie plus haut

// =======================================================
// INITIALISATION QUAND LE DOM EST PRÊT
// =======================================================
window.addEventListener('DOMContentLoaded', (event) => {
  console.log("DOM prêt. Tous les scripts peuvent s'exécuter.");

  // GESTION DU MODAL DE DÉMARRAGE
  const startupModal = document.getElementById('startupModal');
  const closeStartupModalBtn = document.getElementById('closeStartupModal');

  if (closeStartupModalBtn && startupModal) {
    closeStartupModalBtn.addEventListener('click', () => {
      startupModal.classList.add('hidden');
    });
  }

  // =======================================================
  // 1. GESTION DES OPTIONS DE LISIBILITÉ
  // =======================================================
  (function() {
    const toggleBtn = document.getElementById('btnLisibilite');
    const panel = document.getElementById('lisibilite-panel');
    const closeBtn = document.getElementById('close-lisibilite-panel');
    const resetBtn = document.getElementById('reset-lisibilite');
    const fullscreenBtn = document.getElementById('fullscreen-mode');

    // On vérifie que les éléments critiques existent avant de continuer
    if (!toggleBtn || !panel || !closeBtn) {
        console.warn('Certains éléments du panneau de lisibilité sont introuvables. Fonctionnalité désactivée.');
        return;
    }
  
  // État des options de lisibilité
  let lisibiliteState = {
    size: 'medium',
    style: 'normal',
    contrast: 'normal',
    symbols: 'colors'
  };
  
  // Charger les préférences sauvegardées
  function loadPreferences() {
    const saved = localStorage.getItem('lisibilite-preferences');
    if (saved) {
      lisibiliteState = { ...lisibiliteState, ...JSON.parse(saved) };
      applyPreferences();
    }
  }
  
  // Sauvegarder les préférences
  function savePreferences() {
    localStorage.setItem('lisibilite-preferences', JSON.stringify(lisibiliteState));
  }
  
  // Appliquer les préférences aux noms (vue normale ET simplifiée)
  function applyPreferences() {
    // Vue normale
    const names = document.querySelectorAll('.student-fullname');
    names.forEach(name => {
      name.classList.remove('size-small', 'size-medium', 'size-large', 'size-xlarge');
      name.classList.remove('style-normal', 'style-bold', 'style-highlight', 'style-outline');
      name.classList.add(`size-${lisibiliteState.size}`);
      name.classList.add(`style-${lisibiliteState.style}`);
      name.style.color = '';
      name.style.background = '';
      name.style.fontWeight = '';
      // Contraste élevé/max : forcer noir/blanc, sinon laisser couleur par défaut
      if (lisibiliteState.contrast === 'high' || lisibiliteState.contrast === 'max') {
        name.style.color = '#000';
        name.style.textShadow = lisibiliteState.contrast === 'max'
          ? '2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff'
          : '1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff';
        name.style.fontWeight = '900';
      } else {
        name.style.color = '';
        name.style.textShadow = '';
      }
      // Style highlight/outline
      if (lisibiliteState.style === 'highlight') {
        name.style.background = '#fef3c7';
      }
      if (lisibiliteState.style === 'outline') {
        name.style.border = '2px solid #3b82f6';
        name.style.borderRadius = '3px';
      } else {
        name.style.border = '';
        name.style.borderRadius = '';
      }
      // Symboles/genres
      const card = name.closest('.student-card');
      if (card) {
        card.classList.remove('symbols-colors', 'symbols-symbols', 'symbols-both');
        card.classList.add(`symbols-${lisibiliteState.symbols}`);
        // Fond blanc forcé si symboles ou contraste, sinon couleur par défaut
        if (lisibiliteState.symbols !== 'colors' || lisibiliteState.contrast !== 'normal') {
          card.style.background = '#fff';
          card.style.borderColor = '#bbb';
        } else {
          card.style.background = '';
          card.style.borderColor = '';
        }
      }
    });
    // Vue simplifiée
    const simpleNames = document.querySelectorAll('.student-simple-name');
    simpleNames.forEach(name => {
      name.style.fontSize =
        lisibiliteState.size === 'small' ? '0.75rem' :
        lisibiliteState.size === 'medium' ? '0.95rem' :
        lisibiliteState.size === 'large' ? '1.15rem' :
        '1.35rem';
      name.style.fontWeight = lisibiliteState.style === 'bold' ? '700' :
        lisibiliteState.style === 'highlight' ? '700' :
        lisibiliteState.style === 'outline' ? '700' :
        '600';
      name.style.background = lisibiliteState.style === 'highlight' ? '#fef3c7' : '';
      name.style.border = lisibiliteState.style === 'outline' ? '2px solid #3b82f6' : '';
      name.style.borderRadius = lisibiliteState.style === 'outline' ? '3px' : '';
      // En mode simplifié, toujours fond blanc et police noire
      name.style.color = '#000';
      name.style.textShadow = '';
      name.style.fontWeight = '900';
      const card = name.closest('.student-card');
      if (card) {
        card.classList.remove('symbols-colors', 'symbols-symbols', 'symbols-both');
        card.classList.add(`symbols-${lisibiliteState.symbols}`);
        card.style.background = '#fff';
        card.style.borderColor = '#bbb';
      }
    });
    // Appliquer le contraste au body
    document.body.classList.remove('contrast-high', 'contrast-max');
    if (lisibiliteState.contrast !== 'normal') {
      document.body.classList.add(`contrast-${lisibiliteState.contrast}`);
    }
    // Appliquer les symboles aux cartes (vue normale)
    const cards = document.querySelectorAll('.student-card');
    cards.forEach(card => {
      card.classList.remove('symbols-colors', 'symbols-symbols', 'symbols-both');
      card.classList.add(`symbols-${lisibiliteState.symbols}`);
      // Fond blanc forcé si symboles ou contraste, sinon couleur par défaut
      if (lisibiliteState.symbols !== 'colors' || lisibiliteState.contrast !== 'normal') {
        card.style.background = '#fff';
        card.style.borderColor = '#bbb';
      } else {
        card.style.background = '';
        card.style.borderColor = '';
      }
    });
    updateActiveButtons();
  }
  
  // Mettre à jour les boutons actifs
  function updateActiveButtons() {
    document.querySelectorAll('.btn-lisibilite').forEach(btn => {
      btn.classList.remove('active');
    });
    
    document.querySelectorAll(`[data-size="${lisibiliteState.size}"]`).forEach(btn => btn.classList.add('active'));
    document.querySelectorAll(`[data-style="${lisibiliteState.style}"]`).forEach(btn => btn.classList.add('active'));
    document.querySelectorAll(`[data-contrast="${lisibiliteState.contrast}"]`).forEach(btn => btn.classList.add('active'));
    document.querySelectorAll(`[data-symbols="${lisibiliteState.symbols}"]`).forEach(btn => btn.classList.add('active'));
  }
  
  // Gestion des clics sur les boutons d'options
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-lisibilite')) {
      const type = e.target.dataset.size || e.target.dataset.style || e.target.dataset.contrast || e.target.dataset.symbols;
      const category = e.target.dataset.size ? 'size' : e.target.dataset.style ? 'style' : e.target.dataset.contrast ? 'contrast' : 'symbols';
      
      lisibiliteState[category] = type;
      applyPreferences();
      savePreferences();
    }
  });
  
  // Gestion de l'ouverture/fermeture du panneau
  if (toggleBtn && panel && closeBtn) {
    toggleBtn.addEventListener('click', () => {
      panel.classList.remove('-translate-y-full');
      panel.classList.add('translate-y-0');
    });
    closeBtn.addEventListener('click', () => {
      panel.classList.remove('translate-y-0');
      panel.classList.add('-translate-y-full');
    });
  }
  
  // Réinitialiser les options
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      lisibiliteState = {
        size: 'medium',
        style: 'normal',
        contrast: 'normal',
        symbols: 'colors'
      };
      applyPreferences();
      savePreferences();
    });
  }
  
  // Mode plein écran
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', async () => {
      try {
        if (document.fullscreenElement) {
          await document.exitFullscreen();
        } else {
          await document.documentElement.requestFullscreen();
        }
      } catch (error) {
        console.error('Erreur mode plein écran:', error);
        toast('Erreur mode plein écran. Vérifiez les permissions du navigateur.', 'error');
      }
    });
    
    // Gestion des événements fullscreen pour mettre à jour le bouton
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> Quitter plein écran';
        document.body.classList.add('fullscreen-mode');
      } else {
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> Mode plein écran';
        document.body.classList.remove('fullscreen-mode');
      }
    });
  }
  
  // Charger les préférences au démarrage
  loadPreferences();
  
  // Appliquer les préférences quand de nouveaux élèves sont chargés
  const originalRenderBoard = window.renderBoard;
  if (originalRenderBoard) {
    window.renderBoard = function(...args) {
      const result = originalRenderBoard.apply(this, args);
      setTimeout(applyPreferences, 100); // Appliquer après le rendu
      return result;
    };
  }

  // Appliquer les préférences après chaque bascule de vue
  window.applyLisibilitePreferences = applyPreferences;
  })();


  // =======================================================
  // 2. LOGIQUE PRINCIPALE DE L'APPLICATION
  // =======================================================
  
  // TOUT votre code principal va ici, de "const CONFIG = ..." jusqu'à la fin
  const CONFIG = {
    adminPassword: 'admin123',
    animation: {
      duration: 150
    }
  };
  
  // ========== GESTIONNAIRE D'ERREURS ==========
  window.addEventListener('error', (e) => {
    console.error('Erreur capturée:', e.message);
    e.preventDefault();
  });
  
  
  
  // ========== FONCTION DE RAFRAÎCHISSEMENT ==========
  window.attemptRefresh = async function() {
    console.log('🔄 Tentative de rafraîchissement...');
    const currentMode = localStorage.getItem('mode-selection') || 'TEST';
    const success = await loadDataForMode(currentMode);
    if (!success) {
      // Si échec, essayer de recharger complètement
      await initRepartitionApp();
    }
  }
  
  
  
  /* ---------- helper : élève vraiment valide --------- */
  function isValidStudent(e) {
    return e                     // objet présent
        && e.id && e.id.trim()   // id non-vide
        && e.nom && e.nom.trim();/* au moins un NOM non-vide  */
  }
  
 
  
  
  // ========== MISE À JOUR DES STATISTIQUES ==========
  // Fonctions déjà définies plus haut
  

  
  // Fonction pour déplacer automatiquement un groupe A
  function moveGroupA(eleveId, srcClasse, dstClasse) {
    const eleve = STATE.students[eleveId];
    if (!eleve.asso) return;
    
    const group = STATE.aGroups[`A${eleve.asso}`] || [];
    const movedMembers = [];
    
    // Déplacer tous les membres du groupe qui sont dans srcClasse
    group.forEach(memberId => {
      const memberCard = document.querySelector(`.student-card[data-id="${memberId}"]`);
      if (!memberCard) return;
      
      const memberClasse = memberCard.closest('.droppable-zone').dataset.classe;
      if (memberClasse === srcClasse) {
        const dstZone = document.querySelector(`.droppable-zone[data-classe="${dstClasse}"]`);
        if (dstZone) {
          dstZone.appendChild(memberCard);
          movedMembers.push(STATE.students[memberId].nom);
        }
      }
    });
    
    if (movedMembers.length > 1) {
      toast(`Groupe A${eleve.asso} déplacé : ${movedMembers.join(', ')}`, 'info');
    }
  }
  
  // ========== GESTION DES SWAPS - REMPLACEMENT COMPLET ==========
  // Remplacez TOUTE la section de gestion des swaps par ce code
  
  // Fonction pour vérifier si un swap est possible
  
  
  
  // Fonction pour gérer le clic sur une carte
  
  
  // Fonction pour activer/désactiver le mode swap
  function toggleSwapMode() {
    STATE.swapMode = !STATE.swapMode;
    STATE.swapFirst = null;

    const btnSwap = document.getElementById('btnSwap');
    const sortables = document.querySelectorAll('.droppable-zone');

    if (STATE.swapMode) {
      btnSwap.classList.add('active');
      btnSwap.setAttribute('aria-pressed', 'true');
      toast('Mode swap activé - Cliquez sur deux élèves pour les échanger', 'info');

      // Désactiver le drag & drop
      sortables.forEach(zone => {
        const sortable = Sortable.get(zone);
        if (sortable) sortable.option('disabled', true);
      });
    } else {
      btnSwap.classList.remove('active');
      btnSwap.setAttribute('aria-pressed', 'false');
      
      // Réactiver le drag & drop
      sortables.forEach(zone => {
        const sortable = Sortable.get(zone);
        if (sortable) sortable.option('disabled', false);
      });
      
      // Nettoyer les sélections
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.remove('swap-mode');
      });
      document.querySelectorAll('.droppable-zone').forEach(zone => {
        zone.classList.remove('swap-target');
      });
    }
  }
  
  // S'assurer que performSwapAndClose est bien défini pour la modal
  window.performSwapAndClose = function(id1, id2) {
    performSwap(id1, id2);
    
  }
  
  // ========== SUGGESTIONS DE SWAPS ==========
  function findSwapSuggestions() {
    const suggestions = [];
    const classes = Object.keys(STATE.rules);
    
    // Analyser chaque paire de classes
    for (let i = 0; i < classes.length; i++) {
      for (let j = i + 1; j < classes.length; j++) {
        const classe1 = classes[i];
        const classe2 = classes[j];
        
        const students1 = getCurrentClassContent(classe1).map(id => STATE.students[id]);
        const students2 = getCurrentClassContent(classe2).map(id => STATE.students[id]);
        
        // Chercher des swaps équilibrants
        students1.forEach(s1 => {
          students2.forEach(s2 => {
            // Vérifier si le swap est possible
            const check = canSwap(s1.id, s2.id);
            if (!check.ok) return;
            
            // Calculer l'amélioration (exemple : équilibrage des sexes)
            const countF1 = students1.filter(s => s.sexe === 'F').length;
            const countM1 = students1.filter(s => s.sexe === 'M').length;
            const countF2 = students2.filter(s => s.sexe === 'F').length;
            const countM2 = students2.filter(s => s.sexe === 'M').length;
            
            const diffBefore = Math.abs(countF1 - countM1) + Math.abs(countF2 - countM2);
            
            const newCountF1 = countF1 + (s2.sexe === 'F' ? 1 : 0) - (s1.sexe === 'F' ? 1 : 0);
            const newCountM1 = countM1 + (s2.sexe === 'M' ? 1 : 0) - (s1.sexe === 'M' ? 1 : 0);
            const newCountF2 = countF2 + (s1.sexe === 'F' ? 1 : 0) - (s2.sexe === 'F' ? 1 : 0);
            const newCountM2 = countM2 + (s1.sexe === 'M' ? 1 : 0) - (s2.sexe === 'M' ? 1 : 0);
            
            const diffAfter = Math.abs(newCountF1 - newCountM1) + Math.abs(newCountF2 - newCountM2);
            
            if (diffAfter < diffBefore) {
              suggestions.push({
                student1: s1,
                student2: s2,
                classe1,
                classe2,
                improvement: diffBefore - diffAfter,
                reason: 'Équilibrage des sexes'
              });
            }
          });
        });
      }
    }
    
    // Trier par amélioration décroissante
    suggestions.sort((a, b) => b.improvement - a.improvement);
    
    return suggestions.slice(0, 10); // Top 10
  }
  
   
 
  
  // ========== GESTION UNDO/REDO ==========
// Fonctions déjà définies plus haut
  
  // ========== MODE ADMIN ==========
  function toggleAdminMode() {
    if (!STATE.adminMode) {
      // Demander le mot de passe
      const password = prompt('Entrez le mot de passe administrateur :');
      if (password === CONFIG.adminPassword) {
        STATE.adminMode = true;
        document.getElementById('btnAdmin').classList.add('active');
        document.getElementById('btnAdmin').innerHTML = '<i class="fas fa-lock"></i> Admin ON';
        toast('Mode administrateur activé - Toutes les règles sont désactivées', 'warning');
      } else {
        toast('Mot de passe incorrect', 'error');
      }
    } else {
      STATE.adminMode = false;
      document.getElementById('btnAdmin').classList.remove('active');
      document.getElementById('btnAdmin').innerHTML = '<i class="fas fa-unlock-alt"></i> Admin';
      toast('Mode administrateur désactivé', 'info');
    }
  }
  
  // ========== RECHERCHE ==========
  function setupSearch() {
    const searchInput = document.getElementById('search');
    
    if (!searchInput) return;
    
    searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      STATE.searchTerm = term;
      
      document.querySelectorAll('.student-card').forEach(card => {
        const nameEl = card.querySelector('.student-fullname, .student-simple-name');
        if (!nameEl) return;
        
        const fullName = nameEl.textContent.toLowerCase();
        const match = !term || fullName.includes(term);
        
        card.style.display = match ? '' : 'none';
        card.classList.toggle('search-highlight', match && term);
      });
    });
  }
  


// ========== FONCTIONS DE GESTION DES MODES ==========
function openStartupModal(opts = {}) {
  const modal = document.getElementById('startupModal');
  if (modal) {
    modal.classList.remove('hidden');
    checkCache();
  }
}



// ========== FONCTIONS DE GESTION DES VUES ==========
function toggleViewMode() {
  // Cycle: complete → essential → simple → complete
  const modes = ['complete', 'essential', 'simple'];
  const currentIndex = modes.indexOf(STATE.viewMode);
  const nextIndex = (currentIndex + 1) % modes.length;
  STATE.viewMode = modes[nextIndex];

  localStorage.setItem('viewMode', STATE.viewMode);

  // Mettre à jour les classes body
  document.body.classList.remove('simple-view', 'essential-view');
  if (STATE.viewMode === 'simple') {
    document.body.classList.add('simple-view');
  } else if (STATE.viewMode === 'essential') {
    document.body.classList.add('essential-view');
  }

  // Mettre à jour le texte du bouton et aria-pressed
  const btn = document.getElementById('btnSimpleView');
  const textSpan = document.getElementById('viewModeText');
  if (btn && textSpan) {
    const modeLabels = {
      'complete': 'Essentielle',
      'essential': 'Simple',
      'simple': 'Complète'
    };
    textSpan.textContent = modeLabels[STATE.viewMode];
    // Mettre à jour aria-pressed (true si mode différent de complete)
    btn.setAttribute('aria-pressed', STATE.viewMode !== 'complete');
  }

  // Recréer toutes les cartes pour appliquer la nouvelle vue
  document.querySelectorAll('.droppable-zone').forEach(zone => {
    const ids = Array.from(zone.querySelectorAll('.student-card')).map(c => c.dataset.id);
    zone.innerHTML = '';
    ids.forEach(id => {
      if (STATE.students && STATE.students[id]) {
        const card = createStudentCard(STATE.students[id]);
        if (card) zone.appendChild(card);
      }
    });
    setTimeout(() => adjustSimpleNamesFontSize(zone), 0);
  });
  if (window.applyLisibilitePreferences) {
    window.applyLisibilitePreferences();
  }
}

// Fonction adjustSimpleNamesFontSize déjà définie plus haut
  
  // ========== EXPORT DE LA DISPOSITION ==========
// Fonction déjà définie plus haut
  
  // ========== EXPORT EXCEL ==========
  window.exportExcel = function() {
    const wb = XLSX.utils.book_new();
    
    // Feuille de répartition
    const data = [];
    document.querySelectorAll('.class-column').forEach(column => {
      const classe = column.querySelector('.classe-name').textContent;
      const cards = Array.from(column.querySelectorAll('.student-card'));
      
      cards.forEach(card => {
        const eleve = STATE.students[card.dataset.id];
        data.push({
          Classe: classe,
          Nom: eleve.nom,
          Prénom: eleve.prenom,
          Sexe: eleve.sexe,
          LV2: eleve.lv2,
          Option: eleve.opt,
          Dissociation: eleve.disso ? `D${eleve.disso}` : '',
          Association: eleve.asso ? `A${eleve.asso}` : '',
          'Score COM': eleve.scores.COM,
          'Score TRA': eleve.scores.TRA,
          'Score PART': eleve.scores.PART,
          'Score ABS': eleve.scores.ABS,
          'Classe origine': eleve.source,
          Mobilité: eleve.mobilite
        });
      });
    });
    
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Répartition");
    
    // Feuille de statistiques
    const stats = [];
    document.querySelectorAll('.class-column').forEach(column => {
      const classe = column.querySelector('.classe-name').textContent;
      const count = column.querySelector('.count').textContent;
      const countF = column.querySelector('.count-f').textContent;
      const countM = column.querySelector('.count-m').textContent;
      
      stats.push({
        Classe: classe,
        'Total élèves': count,
        Filles: countF,
        Garçons: countM,
        'Ratio F/M': `${Math.round(countF/count*100)}% / ${Math.round(countM/count*100)}%`
      });
    });
    
    const wsStats = XLSX.utils.json_to_sheet(stats);
    XLSX.utils.book_append_sheet(wb, wsStats, "Statistiques");
    
    // Télécharger
    const niveau = STATE.niveau.replace('°', 'e') || 'classes';
    XLSX.writeFile(wb, `repartition_${niveau}_${new Date().toISOString().split('T')[0]}.xlsx`);
    
    toast('Export Excel généré avec succès', 'success');
    closeExportModal();
  }
  
  // ========== EXPORT PDF ==========
  window.exportPDF = async function() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Titre
    pdf.setFontSize(20);
    pdf.text(`Répartition des Classes - ${STATE.niveau}`, 105, 20, { align: 'center' });
    
    // Date
    pdf.setFontSize(12);
    pdf.text(new Date().toLocaleDateString('fr-FR'), 105, 30, { align: 'center' });
    
    let yPos = 50;
    
    // Pour chaque classe
    document.querySelectorAll('.class-column').forEach((column, index) => {
      if (yPos > 250) {
        pdf.addPage();
        yPos = 20;
      }
      
      const classe = column.querySelector('.classe-name').textContent;
      const count = column.querySelector('.count').textContent;
      const countF = column.querySelector('.count-f').textContent;
      const countM = column.querySelector('.count-m').textContent;
      
      // Titre de la classe
      pdf.setFontSize(16);
      pdf.setTextColor(91, 33, 182); // Primary color
      pdf.text(classe, 20, yPos);
      
      // Stats
      pdf.setFontSize(10);
      pdf.setTextColor(0, 0, 0);
      pdf.text(`Total: ${count} élèves (${countF} filles, ${countM} garçons)`, 60, yPos);
      
      yPos += 10;
      
      // Liste des élèves
      const cards = Array.from(column.querySelectorAll('.student-card'));
      cards.forEach((card, i) => {
        if (yPos > 270) {
          pdf.addPage();
          yPos = 20;
        }
        
        const eleve = STATE.students[card.dataset.id];
        const text = `${i + 1}. ${eleve.nom} ${eleve.prenom} - ${eleve.lv2}${eleve.opt ? '/' + eleve.opt : ''}`;
        pdf.text(text, 25, yPos);
        yPos += 5;
      });
      
      yPos += 10;
    }); // ← Fin de la boucle sur les colonnes

    // Ajouter les graphiques si le panel stats est ouvert
    if (!document.getElementById('statsPanel').classList.contains('translate-x-full')) {
      pdf.addPage();
      pdf.setFontSize(16);
      pdf.text('Statistiques', 105, 20, { align: 'center' });

      // Capturer les graphiques
      const canvas1 = document.getElementById('chartStacked');
      if (canvas1) {
        const imgData1 = canvas1.toDataURL('image/png');
        pdf.addImage(imgData1, 'PNG', 20, 40, 170, 80);
      }

      const canvas2 = document.getElementById('chartDetailed');
      if (canvas2) {
        const imgData2 = canvas2.toDataURL('image/png');
        pdf.addImage(imgData2, 'PNG', 20, 130, 170, 80);
      }
    }

    const niveau = STATE.niveau.replace('°', 'e') || 'classes';
    pdf.save(`repartition_${niveau}_${new Date().toISOString().split('T')[0]}.pdf`);

    toast('Export PDF généré avec succès', 'success');
    closeExportModal();
  } // ← Fin correcte de la fonction exportPDF
  
  // ========== COMPARAISON AVANT/APRÈS ==========
  window.showComparison = function() {
    if (!STATE.originalData) {
      toast('Aucune donnée de comparaison disponible', 'warning');
      return;a
    }
    
    // Créer une modal de comparaison
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
          <h2 class="text-xl font-bold">Comparaison avant/après répartition</h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="comparison-container">
            <div class="comparison-side">
              <h3>État initial</h3>
              <div id="comparisonBefore"></div>
            </div>
            <div class="comparison-side">
              <h3>État actuel</h3>
              <div id="comparisonAfter"></div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Remplir les données
    const beforeContainer = modal.querySelector('#comparisonBefore');
    const afterContainer = modal.querySelector('#comparisonAfter');
    
    // État initial
    STATE.originalData.forEach(group => {
      const div = document.createElement('div');
      div.className = 'mb-4';
      div.innerHTML = `
        <h4 class="font-bold">${group.classe}</h4>
        <p>Total: ${group.eleves.length} élèves</p>
        <p>F/M: ${group.eleves.filter(e => e.sexe === 'F').length}/${group.eleves.filter(e => e.sexe === 'M').length}</p>
      `;
      beforeContainer.appendChild(div);
    });
    
    // État actuel
    document.querySelectorAll('.class-column').forEach(column => {
      const classe = column.querySelector('.classe-name').textContent;
      const count = column.querySelector('.count').textContent;
      const countF = column.querySelector('.count-f').textContent;
      const countM = column.querySelector('.count-m').textContent;
      
      const div = document.createElement('div');
      div.className = 'mb-4';
      div.innerHTML = `
        <h4 class="font-bold">${classe}</h4>
        <p>Total: ${count} élèves</p>
        <p>F/M: ${countF}/${countM}</p>
      `;
      afterContainer.appendChild(div);
    });
    
    closeExportModal();
  }
  
  // ========== MODAL EXPORT ==========
  window.closeExportModal = function() {
    document.getElementById('exportModal').classList.add('hidden');
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('overlay').classList.remove('active');
  }
  
  // ========== ÉDITION DES RÈGLES ==========
  function openRulesModal() {
    const container = document.getElementById('rulesContainer');
    container.innerHTML = '';
    
    // Pour chaque classe
    Object.keys(STATE.rules).forEach(classe => {
      const rule = STATE.rules[classe];
      
      const div = document.createElement('div');
      div.className = 'mb-6 p-4 border rounded-lg';
      div.innerHTML = `
        <h3 class="font-bold text-lg mb-3">${classe}</h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Capacité maximale</label>
            <input type="number" class="form-control" 
              data-classe="${classe}" 
              data-field="capacity" 
              value="${rule.capacity || 28}" 
              min="1" max="35">
          </div>
          <div class="form-group">
            <label class="form-label">Quotas (format: OPT=nombre)</label>
            <textarea class="form-control" 
              data-classe="${classe}" 
              data-field="quotas" 
              rows="3">${Object.entries(rule.quotas || {}).map(([k, v]) => `${k}=${v}`).join(', ')}</textarea>
          </div>
        </div>
      `;
      
      container.appendChild(div);
    });
    
    document.getElementById('rulesModal').classList.remove('hidden');
    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('overlay').classList.add('active');
  }
  
  window.closeRulesModal = function() {
    document.getElementById('rulesModal').classList.add('hidden');
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('overlay').classList.remove('active');
  }
  
  window.saveRules = async function() {
    const newRules = {};
    
    // Collecter les nouvelles règles
    document.querySelectorAll('#rulesContainer input, #rulesContainer textarea').forEach(input => {
      const classe = input.dataset.classe;
      const field = input.dataset.field;
      
      if (!newRules[classe]) {
        newRules[classe] = { capacity: 28, quotas: {} };
      }
      
      if (field === 'capacity') {
        newRules[classe].capacity = parseInt(input.value) || 28;
      } else if (field === 'quotas') {
        // Parser les quotas
        const quotasStr = input.value;
        quotasStr.split(',').forEach(pair => {
          const [opt, val] = pair.split('=').map(s => s.trim());
          if (opt && val) {
            newRules[classe].quotas[opt.toUpperCase()] = parseInt(val) || 0;
          }
        });
      }
    });
    
    // Mettre à jour l'état
    STATE.rules = newRules;
    
    // Sauvegarder en backend
    try {
      const result = await gsRun('updateStructureRules', newRules);
      if (result.success) {
        toast('Règles mises à jour avec succès', 'success');
        closeRulesModal();
      } else {
        toast('Erreur lors de la mise à jour des règles', 'error');
      }
    } catch (error) {
      console.error('Erreur:', error);
      toast('Erreur lors de la mise à jour des règles', 'error');
    }
  }
  
  // ========== MISE À JOUR INTELLIGENTE DU PANEAU DES STATISTIQUES ==========
// (ANCIENNE VERSION SUPPRIMÉE - REMPLACÉE PAR LA VERSION PROTÉGÉE)

// ========== GRAPHIQUES ==========
function initCharts() {
    console.log('🎨 Initialisation des graphiques...');
    const statsContent = document.getElementById('statsContent');
    
    // HTML COMPLET avec tous les graphiques existants + nouveaux
    statsContent.innerHTML = `
      <div class="mb-2">
        <div class="flex gap-2 mb-2">
          <button onclick="switchChart('COM')" class="px-3 py-1 text-xs rounded font-semibold bg-green-500 text-white" id="btnCOM">COM</button>
          <button onclick="switchChart('TRA')" class="px-3 py-1 text-xs rounded font-semibold bg-gray-300" id="btnTRA">TRA</button>
          <button onclick="switchChart('PART')" class="px-3 py-1 text-xs rounded font-semibold bg-gray-300" id="btnPART">PART</button>
          <button onclick="switchChart('ABS')" class="px-3 py-1 text-xs rounded font-semibold bg-gray-300" id="btnABS">ABS</button>
        </div>
      </div>
      
      <div class="chart-container" style="padding: 10px; margin-bottom: 10px;">
        <h3 class="chart-title text-sm">Distribution - <span id="scoreType">Comportement</span></h3>
        <canvas id="chartStacked" style="max-height: 150px;"></canvas>
      </div>
      
      <div class="chart-container" style="padding: 10px; margin-bottom: 10px;">
        <h3 class="chart-title text-sm">Moyennes par classe</h3>
        <canvas id="chartDetailed" style="max-height: 150px;"></canvas>
      </div>
      
      <div class="grid grid-cols-2 gap-2">
        <div class="chart-container" style="padding: 10px;">
          <h3 class="chart-title text-sm">Répartition LV2</h3>
          <canvas id="chartLV2" style="max-height: 120px;"></canvas>
        </div>
        
        <div class="chart-container" style="padding: 10px;">
          <h3 class="chart-title text-sm">Options</h3>
          <canvas id="chartOptions" style="max-height: 120px;"></canvas>
        </div>
      </div>
      
      <div class="chart-container" style="padding: 10px; margin-top: 10px;">
        <h3 class="chart-title text-sm">Statistiques globales</h3>
        <div id="globalStats" class="text-xs"></div>
      </div>
      
      <!-- ========== NOUVEAUX AJOUTS EN BAS ========== -->
      
      <!-- Métriques globales -->
  <div class="grid grid-cols-4 gap-3 mb-4 mt-4">
    <div class="stats-metric">
      <div class="metric-value" id="totalStudentsMetric">0</div>
      <div class="metric-label">Élèves</div>
    </div>
    <div class="stats-metric">
      <div class="metric-value" id="genderBalanceMetric">50% F</div>
      <div class="metric-label">Ratio Filles</div>
    </div>
    <div class="stats-metric">
      <div class="metric-value" id="avgClassSizeMetric">0</div>
      <div class="metric-label">Moy/Classe</div>
    </div>
    <div class="stats-metric">
      <div class="metric-value" id="conformityScoreMetric">✅ OK</div>
      <div class="metric-label">Problèmes</div>
    </div>
  </div>
      
      <!-- Nouveau graphique LV2 détaillé -->
      <div class="chart-container" style="padding: 10px; margin-bottom: 10px;">
        <h3 class="chart-title text-sm">
          <i class="fas fa-language text-purple-500"></i>
          Répartition LV2 par Classe
        </h3>
        <canvas id="chartLV2Details" style="max-height: 180px;"></canvas>
      </div>
    `;
    
    // Chart 1 : Distribution empilée par classe
    const ctx1 = document.getElementById('chartStacked').getContext('2d');
    chartCommunication = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          { label: '1', data: [], backgroundColor: '#dc2626', stack: 'Stack 0' },
          { label: '2', data: [], backgroundColor: '#fbbf24', stack: 'Stack 0' },
          { label: '3', data: [], backgroundColor: '#22c55e', stack: 'Stack 0' },
          { label: '4', data: [], backgroundColor: '#15803d', stack: 'Stack 0' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { 
            stacked: true,
            ticks: { font: { size: 10 } }
          },
          y: { 
            stacked: true,
            beginAtZero: true,
            ticks: { font: { size: 10 } }
          }
        },
        plugins: {
          legend: { 
            display: true,
            position: 'right',
            labels: { 
              boxWidth: 12,
              font: { size: 10 }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Score ${context.datasetIndex + 1}: ${context.parsed.y}`;
              }
            }
          }
        }
      }
    });
    
    // Chart 2 : Distribution par critères
    const ctx2 = document.getElementById('chartDetailed').getContext('2d');
    chartDistribution = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          { label: 'COM', data: [], backgroundColor: '#10b981' },
          { label: 'TRA', data: [], backgroundColor: '#3b82f6' },
          { label: 'PART', data: [], backgroundColor: '#f59e0b' },
          { label: 'ABS', data: [], backgroundColor: '#ef4444' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { font: { size: 10 } } },
          y: { 
            beginAtZero: true,
            max: 4,
            ticks: { font: { size: 10 } }
          }
        },
        plugins: {
          legend: { 
            position: 'bottom',
            labels: { 
              boxWidth: 10,
              font: { size: 10 }
            }
          }
        }
      }
    });
    
    // Chart 3 : Distribution LV2
    const ctx3 = document.getElementById('chartLV2').getContext('2d');
    chartLV2 = new Chart(ctx3, {
      type: 'doughnut',
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: ['#dc2626', '#059669', '#2563eb', '#7c3aed', '#d97706']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'bottom',
            labels: { 
              boxWidth: 10,
              font: { size: 10 }
            }
          }
        }
      }
    });
    
    // Chart 4 : Distribution Options
    const ctx4 = document.getElementById('chartOptions').getContext('2d');
    chartOptions = new Chart(ctx4, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Élèves',
          data: [],
          backgroundColor: '#8b5cf6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
          x: { 
            beginAtZero: true,
            ticks: { font: { size: 10 } }
          },
          y: { ticks: { font: { size: 10 } } }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
    
    // ========== NOUVEAU GRAPHIQUE LV2 DÉTAILLÉ ==========
    window.chartLV2Details = null;
    const ctx5 = document.getElementById('chartLV2Details');
    if (ctx5) {
      window.chartLV2Details = new Chart(ctx5.getContext('2d'), {
        type: 'bar',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true,
              ticks: { font: { size: 10 } }
            },
            y: { 
              stacked: true,
              beginAtZero: true,
              ticks: { font: { size: 10 } }
            }
          },
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { 
                boxWidth: 12,
                font: { size: 10 }
              }
            }
          }
        }
      });
    }
    
    // Initialiser avec COM
    updateCharts('COM');
    console.log('✅ Graphiques initialisés avec succès');
  }
  
  // Variable locale pour le type de score actuel (comme dans la version qui fonctionne)
  let currentScoreType = 'COM';
  

  
  // Fonction pour changer de graphique
  window.switchChart = function(type) {
    currentScoreType = type;
    
    // Mettre à jour les boutons
    ['COM', 'TRA', 'PART', 'ABS'].forEach(t => {
      const btn = document.getElementById(`btn${t}`);
      if (t === type) {
        btn.classList.remove('bg-gray-300');
        btn.classList.add('bg-green-500', 'text-white');
      } else {
        btn.classList.remove('bg-green-500', 'text-white');
        btn.classList.add('bg-gray-300');
      }
    });
    
    // Mettre à jour le titre
    const titles = {
      'COM': 'Comportement',
      'TRA': 'Travail',
      'PART': 'Participation',
      'ABS': 'Absentéisme'
    };
    document.getElementById('scoreType').textContent = titles[type];
    
    // Mettre à jour les graphiques
    updateCharts(type);
  }
  
  function updateCharts(scoreType = null) {
    console.log('🚨 updateCharts DÉBUT - scoreType:', scoreType);
    try {
      console.log('📊 updateCharts appelée avec scoreType:', scoreType);
      if (!scoreType) scoreType = currentScoreType;
      console.log('📊 ScoreType final:', scoreType);
    
    // Collecter les données par classe
    const dataByClass = {};
    const classes = [];
    const lv2Count = {};
    const optionCount = {};
    
    document.querySelectorAll('.class-column').forEach(column => {
      const classe = column.querySelector('.classe-name').textContent;
      classes.push(classe);
      
      // IMPORTANT: Récupérer les cartes ACTUELLES de cette colonne
      const cards = Array.from(column.querySelectorAll('.student-card'));
      
      dataByClass[classe] = {
        total: cards.length,
        scores: { 
          COM: [0,0,0,0], 
          TRA: [0,0,0,0], 
          PART: [0,0,0,0],
          ABS: [0,0,0,0]
        },
        averages: { COM: 0, TRA: 0, PART: 0, ABS: 0 }
      };
      
      // Calculer les scores pour chaque élève ACTUELLEMENT dans cette classe
      cards.forEach(card => {
        const eleve = STATE.students[card.dataset.id];
        if (!eleve) return;
        
        // Compter les scores pour le graphique empilé
        const scoreMap = {
          'COM': eleve.scores.COM,
          'TRA': eleve.scores.TRA,
          'PART': eleve.scores.PART,
          'ABS': eleve.scores.ABS
        };
        
        const score = scoreMap[scoreType];
        if (score > 0) {
          dataByClass[classe].scores[scoreType][score - 1]++;
        }

        // Calculer les moyennes pour tous les critères
        if (eleve.scores.COM > 0) dataByClass[classe].averages.COM += eleve.scores.COM;
        if (eleve.scores.TRA > 0) dataByClass[classe].averages.TRA += eleve.scores.TRA;
        if (eleve.scores.PART > 0) dataByClass[classe].averages.PART += eleve.scores.PART;
        if (eleve.scores.ABS > 0) dataByClass[classe].averages.ABS += eleve.scores.ABS;
        
        // Compter LV2 et options
        if (eleve.lv2) {
          lv2Count[eleve.lv2] = (lv2Count[eleve.lv2] || 0) + 1;
        }
        if (eleve.opt) {
          optionCount[eleve.opt] = (optionCount[eleve.opt] || 0) + 1;
        }
      });
      
      // Calculer les moyennes
      const total = cards.length || 1;
      dataByClass[classe].averages.COM /= total;
      dataByClass[classe].averages.TRA /= total;
      dataByClass[classe].averages.PART /= total;
      dataByClass[classe].averages.ABS /= total;
    });
    
    // Vérifier que les graphiques existent
    if (!chartCommunication || !chartDistribution || !chartLV2 || !chartOptions) {
      console.warn('Graphiques non initialisés');
      return;
    }
    
    // Mettre à jour Chart 1 (Distribution empilée)
    const sortedClasses = classes.sort();
    chartCommunication.data.labels = sortedClasses;
    
    // Mettre à jour Chart 1 (Distribution empilée)
    chartCommunication.data.labels = sortedClasses;
    
    // Mettre à jour les datasets pour le score sélectionné
    for (let i = 0; i < 4; i++) {
      chartCommunication.data.datasets[i].data = sortedClasses.map(c => 
        dataByClass[c].scores[scoreType][i]
      );
    }
    
    // Vérification de cohérence des longueurs
    console.assert(
      sortedClasses.length === chartCommunication.data.datasets[0].data.length,
      '💥 Incohérence longueurs', sortedClasses.length, chartCommunication.data.datasets[0].data.length
    );
    
    // Mettre à jour Chart 2 (Moyennes par critère)
    chartDistribution.data.labels = sortedClasses;
    chartDistribution.data.datasets[0].data = sortedClasses.map(c => 
      Math.round(dataByClass[c].averages.COM * 100) / 100
    );
    chartDistribution.data.datasets[1].data = sortedClasses.map(c => 
      Math.round(dataByClass[c].averages.TRA * 100) / 100
    );
    chartDistribution.data.datasets[2].data = sortedClasses.map(c => 
      Math.round(dataByClass[c].averages.PART * 100) / 100
    );
    chartDistribution.data.datasets[3].data = sortedClasses.map(c => 
      Math.round(dataByClass[c].averages.ABS * 100) / 100
    );
    
    // Mettre à jour Chart 3 (LV2)
    chartLV2.data.labels = Object.keys(lv2Count);
    chartLV2.data.datasets[0].data = Object.values(lv2Count);
    
    // Mettre à jour Chart 4 (Options)
    chartOptions.data.labels = Object.keys(optionCount);
    chartOptions.data.datasets[0].data = Object.values(optionCount);
    
    // Statistiques globales
    let globalTotals = { eleves: 0, filles: 0, garcons: 0 };
    let globalScores = { COM: 0, TRA: 0, PART: 0, ABS: 0 };
    let scoreCounts = { COM: 0, TRA: 0, PART: 0, ABS: 0 };
    
    // Parcourir TOUTES les cartes actuellement affichées
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (eleve) {
        globalTotals.eleves++;
        if (eleve.sexe === 'F') globalTotals.filles++;
        else globalTotals.garcons++;

        if (eleve.scores.COM > 0) { globalScores.COM += eleve.scores.COM; scoreCounts.COM++; }
        if (eleve.scores.TRA > 0) { globalScores.TRA += eleve.scores.TRA; scoreCounts.TRA++; }
        if (eleve.scores.PART > 0) { globalScores.PART += eleve.scores.PART; scoreCounts.PART++; }
        if (eleve.scores.ABS > 0) { globalScores.ABS += eleve.scores.ABS; scoreCounts.ABS++; }
      }
    });
    
    const globalStatsHtml = `
      <p><strong>Total élèves :</strong> ${globalTotals.eleves}</p>
      <p><strong>Répartition :</strong> ${globalTotals.filles} filles (${Math.round(globalTotals.filles/globalTotals.eleves*100)}%) / ${globalTotals.garcons} garçons (${Math.round(globalTotals.garcons/globalTotals.eleves*100)}%)</p>
      <p class="mt-2"><strong>Moyennes globales :</strong></p>
      <ul>
        <li>Comportement : ${scoreCounts.COM > 0 ? (globalScores.COM / scoreCounts.COM).toFixed(2) : 'N/A'}</li>
        <li>Travail : ${scoreCounts.TRA > 0 ? (globalScores.TRA / scoreCounts.TRA).toFixed(2) : 'N/A'}</li>
        <li>Participation : ${scoreCounts.PART > 0 ? (globalScores.PART / scoreCounts.PART).toFixed(2) : 'N/A'}</li>
        <li>Absences : ${scoreCounts.ABS > 0 ? (globalScores.ABS / scoreCounts.ABS).toFixed(2) : 'N/A'}</li>
      </ul>
    `;
    
    const globalStatsElement = document.getElementById('globalStats');
    if (globalStatsElement) {
      globalStatsElement.innerHTML = globalStatsHtml;
    }
    
    chartCommunication.update();
    chartDistribution.update();
    chartLV2.update();
    chartOptions.update();
    
    // Mettre à jour les autres métriques
    updateNewMetrics();
    updateLV2Details();
    
    console.log('📊 Mise à jour des graphiques terminée');
  } catch (error) {
    console.error('❌ Erreur dans updateCharts:', error);
  }
  console.log('🚨 updateCharts FIN');
}

// --- PATCH unicité updateCharts ---------------------------------
if (typeof window.updateChartsRiche === 'undefined') {
  window.updateChartsRiche = updateCharts;   // on mémorise la vraie
}
window.updateCharts = window.updateChartsRiche; // on écrase l'ancienne
// ----------------------------------------------------------------

// Attacher updateCharts à window
window.updateCharts = updateCharts;
  
  // CORRECTION PROBLÈME 5 : MODE SOMBRE
  function toggleDarkMode() {
    STATE.darkMode = !STATE.darkMode;
    document.body.classList.toggle('dark-mode');
    
    const btnDarkMode = document.getElementById('btnDarkMode');
    if (STATE.darkMode) {
      btnDarkMode.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
      btnDarkMode.innerHTML = '<i class="fas fa-moon"></i>';
    }
    
    // Sauvegarder la préférence
    try {
      localStorage.setItem('darkMode', STATE.darkMode);
    } catch (e) {
      console.log('localStorage non disponible');
    }
    
    toast(STATE.darkMode ? 'Mode sombre activé' : 'Mode clair activé', 'info');
  }
  
  // CORRECTION PROBLÈME 6 : MODE ZOOM
  function toggleZoom() {
    STATE.zoomMode = !STATE.zoomMode;
    document.body.classList.toggle('zoom-cards');
    
    const btnZoom = document.getElementById('btnZoom');
    if (STATE.zoomMode) {
      btnZoom.innerHTML = '<i class="fas fa-search-minus"></i>';
      toast('Mode zoom activé', 'info');
    } else {
      btnZoom.innerHTML = '<i class="fas fa-search-plus"></i>';
      toast('Mode zoom désactivé', 'info');
    }
  }
  
  // ========== PLEIN ÉCRAN STATS ==========
  window.toggleFullscreenStats = function() {
    STATE.fullscreenStats = !STATE.fullscreenStats;
    const statsPanel = document.getElementById('statsPanel');
    
    if (STATE.fullscreenStats) {
      document.body.classList.add('fullscreen-stats');
      statsPanel.classList.remove('translate-x-full');
      
      // Optionnel : demander le plein écran natif
      if (statsPanel.requestFullscreen) {
        statsPanel.requestFullscreen();
      }
      
      const btnFullscreen = document.getElementById('btnFullscreen');
      if (btnFullscreen) btnFullscreen.innerHTML = '<i class="fas fa-compress"></i>';
    } else {
      document.body.classList.remove('fullscreen-stats');
      
      // Optionnel : sortir du plein écran natif
      if (document.fullscreenElement) {
        document.exitFullscreen();
      }
      
      const btnFullscreen = document.getElementById('btnFullscreen');
      if (btnFullscreen) btnFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
    }
    
    // Forcer la mise à jour des graphiques
    setTimeout(() => {
      if (chartCommunication) chartCommunication.resize();
      if (chartDistribution) chartDistribution.resize();
      if (chartLV2) chartLV2.resize();
      if (chartOptions) chartOptions.resize();
    }, 300);
  }
  
  // ========== MODE ANCRÉ ==========
  function toggleAnchoredStats() {
    STATE.anchoredStats = !STATE.anchoredStats;
    const statsPanel = document.getElementById('statsPanel');
    
    if (STATE.anchoredStats) {
      statsPanel.classList.add('anchored');
      document.getElementById('btnAnchor').classList.add('active');
      toast('Panel statistiques ancré', 'info');
    } else {
      statsPanel.classList.remove('anchored');
      document.getElementById('btnAnchor').classList.remove('active');
      toast('Panel statistiques flottant', 'info');
    }
  }
  
  // ========== RACCOURCIS CLAVIER ==========
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      // Ignorer si on est dans un input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      // Ctrl+Z : Annuler
      if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        undo();
      }
      
      // Ctrl+Y : Refaire
      if (e.ctrlKey && e.key === 'y') {
        e.preventDefault();
        redo();
      }
      
      // S : Mode swap
      if (e.key === 's' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        toggleSwapMode();
      }
      
      // T : Statistiques
      if (e.key === 't' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        document.getElementById('btnStats').click();
      }
      
      // D : Mode sombre
      if (e.key === 'd' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        toggleDarkMode();
      }
      
      // F : Plein écran stats (si panel ouvert)
      if (e.key === 'f' && !e.ctrlKey && !e.altKey) {
        if (!document.getElementById('statsPanel').classList.contains('translate-x-full')) {
          e.preventDefault();
          toggleFullscreenStats();
        }
      }
      
      // Ctrl+F : Recherche
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('search').focus();
      }
      
      // ? : Aide
      if (e.key === '?' || (e.shiftKey && e.key === '/')) {
        e.preventDefault();
        toggleKeyboardHelp();
      }
      
      // M : Ouvrir le modal de sélection de mode
      if (e.key === 'm' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        openStartupModal();
      }
      
      // Échap : Fermer les modals
      if (e.key === 'Escape') {
        // Fermer stats si ouvert
        if (!document.getElementById('statsPanel').classList.contains('translate-x-full')) {
          const panel = document.getElementById('statsPanel');
          panel.classList.add('translate-x-full');
          
          setTimeout(() => {
            document.body.classList.remove('stats-open');
          }, 300);
        }
        
        // Fermer autres modals
        document.querySelectorAll('.modal:not(.hidden)').forEach(modal => {
          modal.classList.add('hidden');
        });
        
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('overlay').classList.remove('active');
      }
    });
  }
  
  // CORRECTION PROBLÈME 7 : RACCOURCIS CLAVIER
  function toggleKeyboardHelp() {
    const help = document.getElementById('keyboardShortcuts');
    help.classList.toggle('hidden');
    
    if (!help.classList.contains('hidden')) {
      toast('Raccourcis clavier affichés', 'info');
    }
  }
  
  // ========== MAPPAGE DES BOUTONS ==========
  function setupEventListeners() {
    // Sécuriser tous les addEventListener avec des vérifications
    const btnRefresh = document.getElementById('btnRefresh');
    const btnSwap = document.getElementById('btnSwap');
    const btnUndo = document.getElementById('btnUndo');
    const btnRedo = document.getElementById('btnRedo');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnSimpleView = document.getElementById('btnSimpleView');
    const btnStats = document.getElementById('btnStats');
    const btnExport = document.getElementById('btnExport');
    const btnSave = document.getElementById('btnSave');
    const btnEditRules = document.getElementById('btnEditRules');
    const btnDarkMode = document.getElementById('btnDarkMode');
    const btnZoom = document.getElementById('btnZoom');
    const btnHelp = document.getElementById('btnHelp');
    const closeStats = document.getElementById('closeStats');
    const btnFullscreen = document.getElementById('btnFullscreenMode');
    const btnAnchor = document.getElementById('btnAnchor');
  
    // Bouton rafraîchir
    if (btnRefresh) btnRefresh.addEventListener('click', attemptRefresh);
    if (btnSwap) btnSwap.addEventListener('click', toggleSwapMode);
    if (btnUndo) btnUndo.addEventListener('click', undo);
    if (btnRedo) btnRedo.addEventListener('click', redo);
    if (btnAdmin) btnAdmin.addEventListener('click', toggleAdminMode);

    // Dropdown sélecteur de vue
    const viewModeSelect = document.getElementById('viewModeSelect');
    if (viewModeSelect) {
      // Initialiser la valeur du select selon le mode actuel
      viewModeSelect.value = STATE.viewMode;

      // Event listener pour changement de vue
      viewModeSelect.addEventListener('change', (e) => {
        STATE.viewMode = e.target.value;
        localStorage.setItem('viewMode', STATE.viewMode);

        // Mettre à jour les classes body
        document.body.classList.remove('simple-view', 'essential-view');
        if (STATE.viewMode === 'simple') {
          document.body.classList.add('simple-view');
        } else if (STATE.viewMode === 'essential') {
          document.body.classList.add('essential-view');
        }

        // Recréer toutes les cartes pour appliquer la nouvelle vue
        document.querySelectorAll('.droppable-zone').forEach(zone => {
          const ids = Array.from(zone.querySelectorAll('.student-card')).map(c => c.dataset.id);
          zone.innerHTML = '';
          ids.forEach(id => {
            const eleve = STATE.students[id];
            if (eleve) {
              zone.appendChild(createStudentCard(eleve));
            }
          });
        });

        // Ajuster tailles si mode simple
        if (STATE.viewMode === 'simple') {
          setTimeout(() => {
            document.querySelectorAll('.droppable-zone').forEach(zone => {
              adjustSimpleNamesFontSize(zone);
            });
          }, 50);
        }

        toast(`Mode ${e.target.options[e.target.selectedIndex].text}`, 'info');
      });

      // Appliquer la classe body appropriée au chargement
      if (STATE.viewMode === 'simple') {
        document.body.classList.add('simple-view');
      } else if (STATE.viewMode === 'essential') {
        document.body.classList.add('essential-view');
      }
    }

    // CORRECTION PROBLÈME 4 : Stats sans overlay bloquant
    if (btnStats) btnStats.addEventListener('click', () => {
      const panel = document.getElementById('statsPanel');

      // Animation synchronisée
      requestAnimationFrame(() => {
        // 1. Définir la largeur du panneau AVANT de l'afficher
        const panelWidth = 600; // Largeur par défaut
        document.documentElement.style.setProperty('--stats-width', panelWidth + 'px');

        // 2. Ajouter la classe pour préparer la grille
        document.body.classList.add('stats-open');

        // 3. Afficher le panneau avec animation
        setTimeout(() => {
          panel.classList.remove('translate-x-full');
          // Mettre à jour aria-expanded
          btnStats.setAttribute('aria-expanded', 'true');

          // Initialiser les graphiques si pas encore fait
          if (!chartCommunication || !chartDistribution || !chartLV2 || !chartOptions) {
            if (typeof initCharts === 'function') {
              initCharts();
            }
          }

          updateCharts();
        }, 50);
      });
    });
    
    // Export
    if (btnExport) btnExport.addEventListener('click', () => {
      document.getElementById('exportModal').classList.remove('hidden');
      document.getElementById('overlay').classList.remove('hidden');
      document.getElementById('overlay').classList.add('active');
    });
    
      // Sauvegarde
  if (btnSave) btnSave.addEventListener('click', async () => {
    try {
      const disposition = exportDisposition();
      const res = await gsRun('saveElevesSnapshot', disposition);
      if (res?.success) {
        toast('Disposition sauvegardée', 'success');
        // Sauvegarder aussi en cache si on est en mode CACHE
        if (STATE.currentMode === 'CACHE') {
          await saveImmediateCache();
        }
      } else {
        toast('Erreur sauvegarde', 'error');
      }
    } catch (error) {
      console.error('Erreur sauvegarde:', error);
      toast('Erreur lors de la sauvegarde', 'error');
    }
  });
    
    // Édition des règles
    if (btnEditRules) btnEditRules.addEventListener('click', openRulesModal);
    
    // Mode sombre
    if (btnDarkMode) btnDarkMode.addEventListener('click', toggleDarkMode);
    
    // Zoom
    if (btnZoom) btnZoom.addEventListener('click', toggleZoom);
    
    // Aide
    if (btnHelp) btnHelp.addEventListener('click', toggleKeyboardHelp);
  
    // Fermeture du panneau statistiques
    if (closeStats) closeStats.addEventListener('click', () => {
      const panel = document.getElementById('statsPanel');
      panel.classList.add('translate-x-full');
      // Mettre à jour aria-expanded
      const btnStats = document.getElementById('btnStats');
      if (btnStats) btnStats.setAttribute('aria-expanded', 'false');

      // Attendre la fin de l'animation avant de restaurer la grille
      setTimeout(() => {
        document.body.classList.remove('stats-open');
      }, 300);
    });
  
    // Boutons statistiques avancées
    if (btnFullscreen) btnFullscreen.addEventListener('click', toggleFullscreenStats);
    if (btnAnchor) btnAnchor.addEventListener('click', toggleAnchoredStats);
    
    // Rendre le panel stats redimensionnable
    makeResizable(document.getElementById('statsPanel'));
    
    // Configurer la recherche
    setupSearch();
  }
  
  // ========== PANEL REDIMENSIONNABLE ==========
  function makeResizable(element) {
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;
    
    const handle = document.createElement('div');
    handle.style.cssText = `
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: ew-resize;
      background: transparent;
    `;
    
    element.appendChild(handle);
    
    handle.addEventListener('mousedown', (e) => {
      isResizing = true;
      startX = e.clientX;
      startWidth = element.offsetWidth;
      document.body.style.cursor = 'ew-resize';
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      
      const diff = startX - e.clientX;
      const newWidth = Math.min(Math.max(400, startWidth + diff), window.innerWidth * 0.8);
      element.style.width = newWidth + 'px';
      
      // Mettre à jour la variable CSS pour adapter la grille
      if (document.body.classList.contains('stats-open')) {
        document.documentElement.style.setProperty('--stats-width', newWidth + 'px');
      }
    });
    
    document.addEventListener('mouseup', () => {
      isResizing = false;
      document.body.style.cursor = '';
    });
  }
  
    
// ========== FONCTION D'INITIALISATION UNIVERSELLE ==========
async function initRepartitionApp() {
  console.log('🚀 Init universelle...');
  let mode = localStorage.getItem('mode-selection');
  
  if (!mode) {
    openStartupModal();
    return;
  }
  
  STATE.currentMode = mode;
  showModeBadge(mode);
  
  // Auto-save dans tous les modes pour éviter la perte de données
  stopAutoSave();
  if (mode === 'TEST' || mode === 'CACHE' || mode === 'INT') {
    startAutoSave();
  }
  
  const ok = await loadDataForMode(mode);
  if (!ok) {
    showErrorState('Aucune donnée trouvée pour le mode ' + mode);
    return;
  }
}

// Attacher les fonctions globales à window
window.initRepartitionApp = initRepartitionApp;
window.openStartupModal = openStartupModal;
window.restoreCache = restoreCache;
window.checkCache = checkCache;
window.showModeBadge = showModeBadge;
window.stopAutoSave = stopAutoSave;
window.startAutoSave = startAutoSave;
window.showErrorState = showErrorState;
window.setupEventListeners = setupEventListeners;
window.setupKeyboardShortcuts = setupKeyboardShortcuts;
window.updateAllColumnStats = updateAllColumnStats;
window.updateAdvancedStats = updateAdvancedStats;
window.toast = toast;
window.gsRun = gsRun;
  
  // =======================================================
  // 3. DÉMARRAGE FINAL
  // =======================================================
  
  // --- Event listeners pour le modal de démarrage ---
  const modal = document.getElementById('startupModal');
  const badge = document.getElementById('modeBadge');
  const closeBtn = document.getElementById('closeStartupModal');
  const btnRestore = document.getElementById('btnRestoreCache');
  
  if (closeBtn) {
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
  }
  
  if (badge) {
    badge.addEventListener('dblclick', () => openStartupModal({ force: true }));
  }
  
  if (modal) {
    modal.querySelectorAll('button[data-mode]').forEach(btn => {
      btn.addEventListener('click', e => {
        const mode = e.currentTarget.dataset.mode;
        localStorage.setItem('mode-selection', mode);
        modal.classList.add('hidden');
        initRepartitionApp() // On relance l'initialisation complète avec le bon mode
        
        // Initialiser les groupes après fermeture du modal
        setTimeout(() => {
          if (window.initializeGroupsAfterModal) {
            window.initializeGroupsAfterModal();
          }
        }, 1000);
      });
    });
  }
  
  if(btnRestore) {
    btnRestore.addEventListener('click', () => {
        restoreCache();
        modal.classList.add('hidden');
    });
  }
  
  // Branche les écouteurs d'événements principaux
  setupEventListeners(); 
  setupKeyboardShortcuts();
  
  // ========== NOUVELLES FONCTIONNALITÉS ==========
  
  // Variable globale pour le filtre actif
  let activeFilter = 'all';
  let focusedColumn = null;

  // Fonction de filtrage rapide
  function applyQuickFilter(filter) {
    activeFilter = filter;

    // Mettre à jour les boutons
    document.querySelectorAll('.filter-btn, .filter-btn-compact').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.filter === filter);
    });

    // Appliquer le filtre
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (!eleve) return;

      let match = false;

      switch (filter) {
        case 'all':
          match = true;
          break;
        case 'PERMUT':
        case 'FIXE':
          match = eleve.mobilite === filter;
          break;
        case 'ESP':
        case 'ITA':
        case 'ALL':
          match = eleve.lv2 === filter;
          break;
        case 'D':
          match = !!eleve.disso;
          break;
        case 'A':
          match = !!eleve.asso;
          break;
      }

      card.classList.toggle('filtered-out', !match);
    });

    // Afficher un message
    if (filter === 'all') {
      toast('Tous les élèves affichés', 'info');
    } else {
      const filtered = document.querySelectorAll('.student-card:not(.filtered-out)').length;
      toast(`${filtered} élève(s) avec filtre ${filter}`, 'info');
    }
  }

  // Fonction d'export image
  window.exportAsImage = async function() {
    toast('Génération de l\'image en cours...', 'info');
    
    try {
      const board = document.getElementById('board');
      const originalStyle = board.style.cssText;
      
      board.style.width = '1920px';
      board.style.padding = '20px';
      board.style.background = '#ffffff';
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const canvas = await html2canvas(board, {
        backgroundColor: '#ffffff',
        scale: 2,
        logging: false,
        useCORS: true,
        width: 1920,
        height: board.scrollHeight
      });
      
      board.style.cssText = originalStyle;
      
      const link = document.createElement('a');
      const niveau = STATE.niveau?.replace('°', 'e') || 'classes';
      link.download = `repartition_${niveau}_${new Date().toISOString().split('T')[0]}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      toast('Image exportée avec succès', 'success');
    } catch (error) {
      console.error('Erreur export image:', error);
      toast('Erreur lors de l\'export de l\'image', 'error');
    }
  };

  // Améliorer le système d'historique existant
  function addToHistory(action) {
    action.timestamp = new Date().toISOString();
    
    if (action.eleveId) {
      const eleve = STATE.students[action.eleveId];
      action.eleveName = eleve ? `${eleve.nom} ${eleve.prenom}` : 'Inconnu';
    }
    
    STATE.history.push(action);
    updateHistoryPanel();
  }

  window.toggleHistoryPanel = function() {
    const panel = document.getElementById('historyPanel');
    panel.classList.toggle('open');
  };

  // SUPPRIMÉ - Première version de updateHistoryPanel
  // Remplacée par la version complète plus bas

  function revertToPoint(index) {
    if (confirm(`Revenir à cet état ? (${STATE.history.length - index - 1} actions seront annulées)`)) {
      while (STATE.history.length > index + 1) {
        undo();
      }
      updateHistoryPanel();
    }
  }

  // Mode focus
  function enableFocusMode() {
    document.querySelectorAll('.class-column').forEach(column => {
      column.addEventListener('dblclick', () => {
        focusOnClass(column);
      });
    });
  }

  function focusOnClass(column) {
    if (focusedColumn) return;
    
    focusedColumn = column;
    
    const overlay = document.createElement('div');
    overlay.className = 'focus-overlay';
    document.body.appendChild(overlay);
    
    const hint = document.createElement('div');
    hint.className = 'exit-focus-hint';
    hint.innerHTML = 'Appuyez sur ESC pour sortir';
    document.body.appendChild(hint);
    
    column.classList.add('focused-column');
    document.body.style.overflow = 'hidden';
    
    function exitFocus(e) {
      if (e.key === 'Escape') {
        column.classList.remove('focused-column');
        overlay.remove();
        hint.remove();
        document.body.style.overflow = '';
        focusedColumn = null;
        document.removeEventListener('keydown', exitFocus);
      }
    }
    
    document.addEventListener('keydown', exitFocus);
    
    overlay.onclick = () => {
      const event = new KeyboardEvent('keydown', { key: 'Escape' });
      document.dispatchEvent(event);
    };
  }

  // Système de bookmarks
  window.toggleBookmarksMenu = function() {
    const menu = document.getElementById('bookmarksMenu');
    menu.classList.toggle('open');
    updateBookmarksMenu();
  };

  window.saveAsBookmark = function() {
    const name = prompt('Nom du favori :');
    if (!name) return;
    
    const bookmarks = JSON.parse(localStorage.getItem('repartition-bookmarks') || '{}');
    bookmarks[name] = {
      date: new Date().toISOString(),
      disposition: exportDisposition(),
      mode: STATE.currentMode,
      stats: {
        total: Object.keys(STATE.students).length,
        classes: document.querySelectorAll('.class-column').length,
        niveau: STATE.niveau
      }
    };
    
    localStorage.setItem('repartition-bookmarks', JSON.stringify(bookmarks));
    updateBookmarksMenu();
    toast(`Favori "${name}" sauvegardé`, 'success');
  };

  window.loadBookmark = function(name) {
    const bookmarks = JSON.parse(localStorage.getItem('repartition-bookmarks') || '{}');
    const bookmark = bookmarks[name];
    
    if (!bookmark) return;
    
    if (!confirm(`Charger le favori "${name}" ? Cela remplacera la disposition actuelle.`)) {
      return;
    }
    
    Object.entries(bookmark.disposition).forEach(([classe, ids]) => {
      const zone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
      if (!zone) return;
      
      zone.innerHTML = '';
      
      ids.forEach(id => {
        const card = document.querySelector(`.student-card[data-id="${id}"]`);
        if (card) zone.appendChild(card);
      });
    });
    
    updateAllColumnStats();
    toast(`Favori "${name}" chargé`, 'success');
  };

  window.deleteBookmark = function(name) {
    if (!confirm(`Supprimer le favori "${name}" ?`)) return;
    
    const bookmarks = JSON.parse(localStorage.getItem('repartition-bookmarks') || '{}');
    delete bookmarks[name];
    localStorage.setItem('repartition-bookmarks', JSON.stringify(bookmarks));
    
    updateBookmarksMenu();
    toast(`Favori "${name}" supprimé`, 'info');
  };

  function updateBookmarksMenu() {
    const container = document.getElementById('bookmarksList');
    if (!container) return;
    
    const bookmarks = JSON.parse(localStorage.getItem('repartition-bookmarks') || '{}');
    container.innerHTML = '';
    
    if (Object.keys(bookmarks).length === 0) {
      container.innerHTML = '<div class="p-4 text-center text-gray-500">Aucun favori enregistré</div>';
      return;
    }
    
    Object.entries(bookmarks).forEach(([name, data]) => {
      const item = document.createElement('div');
      item.className = 'bookmark-item';
      item.innerHTML = `
        <div class="bookmark-name">${name}</div>
        <div class="bookmark-meta">
          Sauvegardé le ${new Date(data.date).toLocaleDateString('fr-FR')}
          - ${data.stats.total} élèves
        </div>
        <div class="bookmark-actions">
          <button class="btn btn-sm btn-primary" onclick="loadBookmark('${name}')">
            <i class="fas fa-download"></i> Charger
          </button>
          <button class="btn btn-sm btn-secondary" onclick="deleteBookmark('${name}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      container.appendChild(item);
    });
  }

  // Initialiser les nouvelles fonctionnalités
  enableFocusMode();
  updateHistoryPanel();

  // Fermer les menus au clic externe
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#btnBookmarks') && !e.target.closest('#bookmarksMenu')) {
      document.getElementById('bookmarksMenu')?.classList.remove('open');
    }
  });

  // Ajouter les event listeners pour les nouveaux boutons
  const btnHistory = document.getElementById('btnHistory');
  const btnBookmarks = document.getElementById('btnBookmarks');
  
  if (btnHistory) btnHistory.addEventListener('click', toggleHistoryPanel);
  if (btnBookmarks) btnBookmarks.addEventListener('click', toggleBookmarksMenu);

  // Initialiser les filtres
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => applyQuickFilter(btn.dataset.filter));
  });
  
  // CORRECTION : TOUJOURS afficher le modal au démarrage
  // L'utilisateur doit pouvoir choisir à chaque fois
  openStartupModal();

  // Gestion des menus déroulants fixes au clic
  (function() {
    function setupDropdown(wrapperId, btnId, dropdownId) {
      const wrapper = document.getElementById(wrapperId);
      const btn = document.getElementById(btnId);
      const dropdown = document.getElementById(dropdownId);
      if (!wrapper || !btn || !dropdown) return;
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Fermer tous les autres dropdowns
        document.querySelectorAll('.app-header .absolute').forEach(d => {
          if (d !== dropdown) {
            d.classList.add('hidden');
            d.setAttribute('aria-hidden', 'true');
            // Trouver le bouton associé et mettre à jour aria-expanded
            const otherBtns = document.querySelectorAll('[aria-haspopup="menu"]');
            otherBtns.forEach(otherBtn => {
              if (otherBtn.nextElementSibling === d || (otherBtn.parentElement && otherBtn.parentElement.contains(d))) {
                otherBtn.setAttribute('aria-expanded', 'false');
              }
            });
          }
        });
        const isHidden = dropdown.classList.toggle('hidden');
        // Mettre à jour les attributs ARIA
        btn.setAttribute('aria-expanded', !isHidden);
        dropdown.setAttribute('aria-hidden', isHidden);
      });
      // Empêcher la fermeture si on clique dans le menu
      dropdown.addEventListener('click', e => e.stopPropagation());
    }
    setupDropdown('settingsMenuWrapper', 'btnSettings', 'settingsDropdown');

    // Mapper les nouveaux boutons du menu Paramètres aux fonctions existantes
    const settingsDropdown = document.getElementById('settingsDropdown');
    if (settingsDropdown) {
      // Section Affichage
      const menuDarkMode = document.getElementById('menuDarkMode');
      if (menuDarkMode) {
        menuDarkMode.addEventListener('click', () => {
          toggleDarkMode();
          settingsDropdown.classList.add('hidden');
        });
      }

      const menuZoom = document.getElementById('menuZoom');
      if (menuZoom) {
        menuZoom.addEventListener('click', () => {
          toggleZoom();
          settingsDropdown.classList.add('hidden');
        });
      }

      const menuFullscreen = document.getElementById('menuFullscreen');
      if (menuFullscreen) {
        menuFullscreen.addEventListener('click', () => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
          } else {
            document.exitFullscreen();
          }
          settingsDropdown.classList.add('hidden');
        });
      }

      // Section Actions - Annuler/Refaire déjà gérés par leurs ID existants (btnUndo, btnRedo)
      const menuBookmarks = document.getElementById('menuBookmarks');
      const btnBookmarks = document.getElementById('btnBookmarks');
      if (menuBookmarks && btnBookmarks) {
        menuBookmarks.addEventListener('click', () => {
          btnBookmarks.click();
          settingsDropdown.classList.add('hidden');
        });
      }

      const menuOptimize = document.getElementById('menuOptimize');
      if (menuOptimize) {
        menuOptimize.addEventListener('click', () => {
          OptimizerV2.applyOptimization();
          settingsDropdown.classList.add('hidden');
        });
      }

      const menuConstraints = document.getElementById('menuConstraints');
      if (menuConstraints) {
        menuConstraints.addEventListener('click', () => {
          ConstraintManager.showConstraintsPanel();
          settingsDropdown.classList.add('hidden');
        });
      }

      const menuFilters = document.getElementById('menuFilters');
      if (menuFilters) {
        menuFilters.addEventListener('click', () => {
          FilterManager.showFiltersPanel();
          settingsDropdown.classList.add('hidden');
        });
      }

      // Section Données
      const menuImportScores = document.getElementById('menuImportScores');
      const btnImportScores = document.getElementById('btnImportScores');
      if (menuImportScores && btnImportScores) {
        menuImportScores.addEventListener('click', () => {
          btnImportScores.click();
          settingsDropdown.classList.add('hidden');
        });
      }

      const menuRules = document.getElementById('menuRules');
      const btnEditRules = document.getElementById('btnEditRules');
      if (menuRules && btnEditRules) {
        menuRules.addEventListener('click', () => {
          btnEditRules.click();
          settingsDropdown.classList.add('hidden');
        });
      }

      // Section Filtres
      const filterBtnsCompact = settingsDropdown.querySelectorAll('.filter-btn-compact');
      filterBtnsCompact.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;
          // Retirer la classe active de tous les boutons
          filterBtnsCompact.forEach(b => b.classList.remove('active'));
          // Ajouter la classe active au bouton cliqué
          btn.classList.add('active');
          // Appliquer le filtre en utilisant la fonction existante
          applyQuickFilter(filter);
          // Fermer le menu
          settingsDropdown.classList.add('hidden');
        });
      });

      // Section Aide - btnHelp et btnTutorial déjà gérés par leurs ID existants
    }

    // Fermer tous les menus au clic extérieur
    document.addEventListener('click', () => {
      document.querySelectorAll('.app-header .absolute').forEach(d => {
        d.classList.add('hidden');
        d.setAttribute('aria-hidden', 'true');
      });
      // Mettre à jour aria-expanded pour tous les boutons de menu
      document.querySelectorAll('[aria-haspopup="menu"]').forEach(btn => {
        btn.setAttribute('aria-expanded', 'false');
      });
    });
  })();

}); // Fin du DOMContentLoaded

// =======================================================
// FONCTIONS GLOBALES SUPPLEMENTAIRES
// =======================================================

// ========== FONCTIONS POUR LES NOUVELLES MÉTRIQUES ==========
function updateNewMetrics() {
  // Vérifier que les métriques sont prêtes dans le DOM
  const metricsReady = document.getElementById('totalStudentsMetric');
  if (!metricsReady) return; // panneau pas encore injecté
  
  console.log('🔢 Recalcul metrics - début');
  
  // Total élèves (uniquement dans les vraies classes)
  let totalStudents = 0;
  let filles = 0;
  let totalClasses = 0;
  
  document.querySelectorAll('.class-column').forEach(column => {
    const className = column.querySelector('.classe-name').textContent;
    if (!isRealClass(className)) return;
    
    totalClasses++;
    column.querySelectorAll('.student-card').forEach(card => {
      const student = STATE.students[card.dataset.id];
      if (student) {
        totalStudents++;
        if (student.sexe === 'F') filles++;
      }
    });
  });
  
  console.log('🔢 Recalcul metrics', {totalStudents, filles, totalClasses});
  
  const totalElement = document.getElementById('totalStudentsMetric');
  if (totalElement) {
    totalElement.textContent = totalStudents;
    console.log('🔢 totalStudentsMetric mis à jour:', totalStudents);
  } else {
    console.warn('❓ métrique manquante dans le DOM : totalStudentsMetric');
  }
  
  // Ratio filles
  const ratio = totalStudents > 0 ? Math.round((filles / totalStudents) * 100) : 0;
  const ratioElement = document.getElementById('genderBalanceMetric');
  if (ratioElement) {
    ratioElement.textContent = `${ratio}% F`;
    console.log('🔢 genderBalanceMetric mis à jour:', `${ratio}% F`);
  } else {
    console.warn('❓ métrique manquante dans le DOM : genderBalanceMetric');
  }
  
  // Moyenne par classe
  const avgClass = totalClasses > 0 ? Math.round(totalStudents / totalClasses) : 0;
  const avgElement = document.getElementById('avgClassSizeMetric');
  if (avgElement) {
    avgElement.textContent = avgClass;
    console.log('🔢 avgClassSizeMetric mis à jour:', avgClass);
  } else {
    console.warn('❓ métrique manquante dans le DOM : avgClassSizeMetric');
  }
  
  // Score de conformité
  const conformityElement = document.getElementById('conformityScoreMetric');
  if (conformityElement) {
    conformityElement.textContent = '✅ OK';
    console.log('🔢 conformityScoreMetric mis à jour: ✅ OK');
  } else {
    console.warn('❓ métrique manquante dans le DOM : conformityScoreMetric');
  }
  
  console.log('🔢 Recalcul metrics - terminé');
}

function updateLV2Details() {
  if (!window.chartLV2Details) return;
  
  const classes = Array.from(document.querySelectorAll('.class-column')).map(col => 
    col.querySelector('.classe-name').textContent
  ).sort();
  
  const lv2Types = ['ESP', 'ITA', 'ALL', 'LATIN', 'GRECO'];
  const colors = ['#dc2626', '#059669', '#2563eb', '#7c3aed', '#d97706'];
  
  window.chartLV2Details.data.labels = classes;
  window.chartLV2Details.data.datasets = lv2Types.map((lv2, index) => ({
    label: lv2,
    data: classes.map(classe => {
      const zone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
      if (!zone) return 0;
      return Array.from(zone.querySelectorAll('.student-card')).filter(card => {
        const eleve = STATE.students[card.dataset.id];
        return eleve && eleve.lv2 && eleve.lv2.toUpperCase() === lv2;
      }).length;
    }),
    backgroundColor: colors[index],
    stack: 'Stack 0'
  }));
  
  window.chartLV2Details.update();
}

function updateConformityGrid() {
  const grid = document.getElementById('conformityGrid');
  if (!grid) return;
  
  const classes = Array.from(document.querySelectorAll('.class-column')).map(col => 
    col.querySelector('.classe-name').textContent
  ).sort();
  
  let html = '';
  classes.forEach(classe => {
    const zone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
    if (!zone) return;
    
    const cards = Array.from(zone.querySelectorAll('.student-card'));
    const total = cards.length;
    const filles = cards.filter(card => {
      const eleve = STATE.students[card.dataset.id];
      return eleve && eleve.sexe === 'F';
    }).length;
    
    const ratio = total > 0 ? Math.round((filles / total) * 100) : 0;
    let status = 'conformity-undefined';
    let text = '?';
    
    if (ratio >= 40 && ratio <= 60) {
      status = 'conformity-ok';
      text = 'OK';
    } else if (ratio >= 30 && ratio <= 70) {
      status = 'conformity-warning';
      text = '!';
    } else {
      status = 'conformity-error';
      text = '✗';
    }
    
    html += `<div class="conformity-cell ${status}" title="${classe}: ${ratio}% filles">${text}</div>`;
  });
  
  grid.innerHTML = html;
}

function updateBalanceIndicators() {
  const container = document.getElementById('balanceIndicators');
  if (!container) return;
  
  const suggestions = [];
  
  // Analyser l'équilibre des sexes
  document.querySelectorAll('.class-column').forEach(column => {
    const classe = column.querySelector('.classe-name').textContent;
    const cards = Array.from(column.querySelectorAll('.student-card'));
    const total = cards.length;
    const filles = cards.filter(card => {
      const eleve = STATE.students[card.dataset.id];
      return eleve && eleve.sexe === 'F';
    }).length;
    
    const ratio = total > 0 ? Math.round((filles / total) * 100) : 0;
    
    if (ratio < 30) {
      suggestions.push({
        type: 'warning',
        message: `${classe}: Trop peu de filles (${ratio}%)`,
        icon: 'fa-exclamation-triangle'
      });
    } else if (ratio > 70) {
      suggestions.push({
        type: 'warning',
        message: `${classe}: Trop peu de garçons (${100-ratio}%)`,
        icon: 'fa-exclamation-triangle'
      });
    }
  });
  
  if (suggestions.length === 0) {
    suggestions.push({
      type: 'success',
      message: 'Équilibre des sexes satisfaisant',
      icon: 'fa-check-circle'
    });
  }
  
  const html = suggestions.map(s => `
    <div class="indicator-card indicator-${s.type === 'success' ? 'good' : 'warning'}">
      <i class="fas ${s.icon} mr-2"></i>
      ${s.message}
    </div>
  `).join('');
  
  container.innerHTML = html;
}

// --- Responsive : recalculer à chaque resize de la fenêtre (avec debounce) ---
let resizeTimeout = null;
window.addEventListener('resize', () => {
  if (STATE.viewMode !== 'simple') return;
  if (resizeTimeout) clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    document.querySelectorAll('.droppable-zone').forEach(zone => adjustSimpleNamesFontSize(zone));
  }, 100);
});

// (FONCTION openStartupModal SUPPRIMÉE - DOUBLON)

// FONCTIONS MANQUANTES - À ajouter dans le script principal

// 1. Gestion du mode sombre depuis localStorage
function initDarkMode() {
  const savedDarkMode = localStorage.getItem('darkMode') === 'true';
  if (savedDarkMode) {
    STATE.darkMode = true;
    document.body.classList.add('dark-mode');
    const btnDarkMode = document.getElementById('btnDarkMode');
    if (btnDarkMode) btnDarkMode.innerHTML = '<i class="fas fa-sun"></i>';
  }
}

// 2. Tutoriel interactif
function showTutorial() {
  const steps = [
    { element: '#search', title: 'Recherche', text: 'Utilisez cette barre pour trouver rapidement un élève par son nom.' },
    { element: '#btnFilters', title: 'Filtres', text: 'Filtrez les élèves par type (PERMUT, FIXE, LV2, etc.)' },
    { element: '.class-column:first-child', title: 'Classes', text: 'Glissez-déposez les élèves entre les classes. Double-clic pour mode focus.' },
    { element: '#btnSwap', title: 'Mode Swap', text: 'Utilisez ce mode pour échanger facilement deux élèves.' },
    { element: '#btnStats', title: 'Statistiques', text: 'Consultez les graphiques et analyses détaillées.' }
  ];
  let currentStep = 0;
  function showStep(index) {
    if (index >= steps.length) { hideTutorial(); toast('Tutoriel terminé ! Vous êtes prêt à utiliser l\'application.', 'success'); return; }
    const step = steps[index];
    const element = document.querySelector(step.element);
    if (!element) { currentStep++; showStep(currentStep); return; }
    const overlay = document.createElement('div');
    overlay.id = 'tutorialOverlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-70 z-50';
    const bubble = document.createElement('div');
    bubble.className = 'absolute bg-white rounded-lg p-4 shadow-xl max-w-sm z-60';
    bubble.innerHTML = `<h3 class="font-bold text-lg mb-2">${step.title}</h3><p class="mb-4">${step.text}</p><div class="flex justify-between items-center"><span class="text-sm text-gray-500">${index + 1}/${steps.length}</span><div class="space-x-2"><button onclick="hideTutorial()" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">Passer</button><button onclick="nextTutorialStep()" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">${index === steps.length - 1 ? 'Terminer' : 'Suivant'}</button></div></div>`;
    const rect = element.getBoundingClientRect();
    bubble.style.top = (rect.bottom + 20) + 'px';
    bubble.style.left = Math.max(20, rect.left - 100) + 'px';
    element.style.position = 'relative';
    element.style.zIndex = '55';
    element.style.boxShadow = '0 0 0 4px #3b82f6, 0 0 0 8px rgba(59, 130, 246, 0.3)';
    element.style.borderRadius = '8px';
    overlay.appendChild(bubble);
    document.body.appendChild(overlay);
  }
  window.nextTutorialStep = function() { currentStep++; hideTutorial(); setTimeout(() => showStep(currentStep), 300); };
  window.hideTutorial = function() {
    document.getElementById('tutorialOverlay')?.remove();
    document.querySelectorAll('[style*="z-index"]').forEach(el => {
      el.style.position = '';
      el.style.zIndex = '';
      el.style.boxShadow = '';
      el.style.borderRadius = '';
    });
  };
  showStep(0);
}

// 3. Actualisation intelligente (déjà présente mais toast amélioré)
window.attemptRefresh = async function() {
  showSpinner();
  try {
    const currentMode = localStorage.getItem('mode-selection') || 'TEST';
    const success = await loadDataForMode(currentMode);
    if (success) {
      toast('Données actualisées avec succès', 'success');
    } else {
      toast('Échec de l\'actualisation', 'error');
    }
  } catch (error) {
    console.error('Erreur actualisation:', error);
    toast('Erreur lors de l\'actualisation', 'error');
  } finally {
    hideSpinner();
  }
}

// 4. Amélioration de la fonction de recherche
function enhanceSearch() {
  const searchInput = document.getElementById('search');
  let searchTimeout;
  if (!searchInput) return;
  searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const term = e.target.value.toLowerCase().trim();
      STATE.searchTerm = term;
      let matchCount = 0;
      document.querySelectorAll('.student-card').forEach(card => {
        const nameEl = card.querySelector('.student-fullname, .student-simple-name');
        if (!nameEl) return;
        const fullName = nameEl.textContent.toLowerCase();
        const eleve = STATE.students[card.dataset.id];
        const searchText = [fullName, eleve?.lv2?.toLowerCase() || '', eleve?.opt?.toLowerCase() || '', eleve?.mobilite?.toLowerCase() || ''].join(' ');
        const match = !term || searchText.includes(term);
        card.style.display = match ? '' : 'none';
        card.classList.toggle('search-highlight', match && term);
        if (match) matchCount++;
      });
      if (term) {
        toast(`${matchCount} élève(s) trouvé(s)`, 'info');
      }
    }, 300);
  });
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      searchInput.focus();
      searchInput.select();
    }
  });
}

// 5. Système de notifications persistantes
function createNotificationSystem() {
  if (!document.getElementById('notificationContainer')) {
    const container = document.createElement('div');
    container.id = 'notificationContainer';
    container.className = 'fixed top-20 right-4 z-50 space-y-2 max-w-sm';
    document.body.appendChild(container);
  }
}
function showPersistentNotification(message, type = 'info', duration = 5000) {
  createNotificationSystem();
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  const bgColors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
  const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
  notification.className = `${bgColors[type]} text-white p-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center gap-2`;
  notification.innerHTML = `<i class="fas ${icons[type]}"></i><span class="flex-1">${message}</span><button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>`;
  container.appendChild(notification);
  setTimeout(() => { notification.classList.remove('translate-x-full'); }, 100);
  if (duration > 0) {
    setTimeout(() => { notification.classList.add('translate-x-full'); setTimeout(() => notification.remove(), 300); }, duration);
  }
}

// 6. Amélioration du système d'aide
function createContextualHelp() {
  const helpButton = document.getElementById('btnTutorial');
  if (helpButton) {
    helpButton.addEventListener('click', () => {
      const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
      if (!hasSeenTutorial) {
        localStorage.setItem('hasSeenTutorial', 'true');
      }
      showTutorial();
    });
  }
}

// 7. Gestion des préférences utilisateur
function saveUserPreferences() {
  const preferences = {
    viewMode: STATE.viewMode,
    darkMode: STATE.darkMode,
    lastFilter: activeFilter || 'all'
  };
  localStorage.setItem('userPreferences', JSON.stringify(preferences));
}
function loadUserPreferences() {
  try {
    const saved = localStorage.getItem('userPreferences');
    if (saved) {
      const prefs = JSON.parse(saved);
      // Gérer l'ancienne propriété simpleView pour la compatibilité
      if (prefs.simpleView !== undefined && prefs.viewMode === undefined) {
        STATE.viewMode = prefs.simpleView ? 'simple' : 'complete';
        localStorage.setItem('viewMode', STATE.viewMode);
      }
      if (prefs.darkMode && !STATE.darkMode) { toggleDarkMode(); }
      if (prefs.lastFilter && prefs.lastFilter !== 'all') { setTimeout(() => applyQuickFilter(prefs.lastFilter), 1000); }
    }
  } catch (e) { console.warn('Erreur chargement préférences:', e); }
}

// 8. Fonction d'initialisation globale améliorée
function initializeEnhancements() {
  loadUserPreferences();
  initDarkMode();
  enhanceSearch();
  createContextualHelp();
  createNotificationSystem();
  window.addEventListener('beforeunload', saveUserPreferences);
  if (!localStorage.getItem('hasSeenTutorial')) {
    setTimeout(() => {
      if (confirm('Première visite ? Voulez-vous voir le tutoriel interactif ?')) {
        showTutorial();
      }
      localStorage.setItem('hasSeenTutorial', 'true');
    }, 2000);
  }
}
// ... existing code ...
// À la fin du DOMContentLoaded, après setupEventListeners() et openStartupModal();
initializeEnhancements();
// ... existing code ...

// ========== PATCH DE CORRECTIONS CRITIQUES ==========

// 1. FIX: Historique timeline qui ne s'affiche pas
function addToHistory(action) {
  action.timestamp = new Date().toISOString();
  
  if (action.eleveId) {
    const eleve = STATE.students[action.eleveId];
    action.eleveName = eleve ? `${eleve.nom} ${eleve.prenom || ''}` : 'Inconnu';
  }
  
  // Ajouter l'action à l'historique global
  if (!STATE.historyTimeline) STATE.historyTimeline = [];
  STATE.historyTimeline.push(action);
  
  // Mettre à jour le panneau
  updateHistoryPanel();
}

function updateHistoryPanel() {
  const container = document.getElementById('historyTimeline');
  if (!container) return;
  
  container.innerHTML = '';
  
  // Utiliser historyTimeline au lieu de history
  const timeline = STATE.historyTimeline || [];
  
  timeline.slice().reverse().forEach((action, idx) => {
    const item = document.createElement('div');
    item.className = 'timeline-item';
    
    let actionText = '';
    let details = '';
    let icon = 'fa-question';
    let color = '#6b7280';
    
    switch (action.type) {
      case 'move':
        actionText = `Déplacement: ${action.eleveName || 'Élève'}`;
        details = `${action.oldClasse} → ${action.newClasse}`;
        icon = 'fa-arrow-right';
        color = '#3b82f6';
        break;
      case 'swap':
        const eleve1 = STATE.students[action.id1];
        const eleve2 = STATE.students[action.id2];
        actionText = `Échange effectué`;
        details = `${eleve1?.nom || 'Élève 1'} ↔ ${eleve2?.nom || 'Élève 2'}`;
        icon = 'fa-exchange-alt';
        color = '#f59e0b';
        break;
    }
    
    item.innerHTML = `
      <div class="timeline-dot" style="background: ${color};">
        <i class="fas ${icon} text-xs"></i>
      </div>
      <div class="timeline-content">
        <div class="timeline-time">${new Date(action.timestamp).toLocaleTimeString('fr-FR')}</div>
        <div class="timeline-action">${actionText}</div>
        <div class="timeline-details">${details}</div>
      </div>
    `;
    
    container.appendChild(item);
  });
  
  // Afficher un message si vide
  if (timeline.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 p-4">Aucune action enregistrée</div>';
  }
}

// Attacher updateHistoryPanel à window
window.updateHistoryPanel = updateHistoryPanel;

// FIX 1: Historique qui ne persiste pas correctement
if (!STATE.historyTimeline) {
  STATE.historyTimeline = [];
}



// 4. FIX: Styles manquants pour la timeline
const timelineStyles = document.createElement('style');
timelineStyles.textContent = `
  .timeline-item {
    position: relative;
    padding-left: 2.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .timeline-item:hover {
    background: #f8fafc;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: 1.25rem;
    top: 2rem;
    bottom: -1rem;
    width: 2px;
    background: #e5e7eb;
  }
  
  .timeline-item:last-child::before {
    display: none;
  }
  
  .timeline-dot {
    position: absolute;
    left: 0.75rem;
    top: 0.75rem;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .timeline-content {
    padding: 0.5rem 0;
  }
  
  .timeline-time {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }
  
  .timeline-action {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
  }
  
  .timeline-details {
    font-size: 0.875rem;
    color: #4b5563;
  }
`;
document.head.appendChild(timelineStyles);

// 5. FIX: Variable activeFilter non définie globalement
window.activeFilter = 'all';

// 6. FIX: Fonction applyQuickFilter améliorée
window.applyQuickFilter = function(filter) {
  window.activeFilter = filter;
  
  // Mettre à jour les boutons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });
  
  // Appliquer le filtre
  let visibleCount = 0;
  document.querySelectorAll('.student-card').forEach(card => {
    const eleve = STATE.students[card.dataset.id];
    if (!eleve) return;
    
    let match = false;
    
    switch (filter) {
      case 'all':
        match = true;
        break;
      case 'PERMUT':
      case 'FIXE':
        match = eleve.mobilite === filter;
        break;
      case 'ESP':
      case 'ITA':
      case 'ALL':
        match = eleve.lv2 === filter;
        break;
      case 'D':
        match = !!eleve.disso;
        break;
      case 'A':
        match = !!eleve.asso;
        break;
    }
    
    card.classList.toggle('filtered-out', !match);
    if (match) visibleCount++;
  });
  
  // Notification du résultat
  if (filter !== 'all') {
    toast(`${visibleCount} élève(s) avec filtre "${filter}"`, 'info');
  }
};

// 7. FIX: Meilleure gestion des tooltips
document.addEventListener('DOMContentLoaded', () => {
  // Ajouter des tooltips riches sur les badges
  document.addEventListener('mouseover', (e) => {
    if (e.target.classList.contains('mini-badge')) {
      const title = e.target.getAttribute('title');
      if (!title) return;
      
      // Créer un tooltip personnalisé si nécessaire
      const existingTooltip = document.querySelector('.custom-tooltip');
      if (existingTooltip) existingTooltip.remove();
      
      const tooltip = document.createElement('div');
      tooltip.className = 'custom-tooltip';
      tooltip.textContent = title;
      tooltip.style.cssText = `
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        z-index: 9999;
        pointer-events: none;
        white-space: nowrap;
      `;
      
      const rect = e.target.getBoundingClientRect();
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.bottom + 5) + 'px';
      
      document.body.appendChild(tooltip);
    }
  });
  
  document.addEventListener('mouseout', (e) => {
    if (e.target.classList.contains('mini-badge')) {
      document.querySelector('.custom-tooltip')?.remove();
    }
  });
});

// 8. FIX: Amélioration de la sauvegarde immédiate
window.saveImmediateCache = async function() {
  try {
    const disposition = exportDisposition();
    const cacheData = {
      date: new Date().toISOString(),
      disposition: disposition,
      mode: STATE.currentMode,
      filters: window.activeFilter,
      stats: {
        total: Object.keys(STATE.students).length,
        classes: document.querySelectorAll('.class-column').length
      }
    };
    
    // Sauvegarde locale avec compression
    localStorage.setItem('cache-data', JSON.stringify(cacheData));
    localStorage.setItem('cache-timestamp', new Date().toISOString());
    
    // Indicateur visuel de sauvegarde
    const saveIndicator = document.createElement('div');
    saveIndicator.className = 'fixed top-20 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm';
    saveIndicator.innerHTML = '<i class="fas fa-check mr-1"></i> Sauvegardé';
    document.body.appendChild(saveIndicator);
    
    setTimeout(() => saveIndicator.remove(), 2000);
    
    // Sauvegarde distante si disponible
    if (typeof gsRun === 'function') {
      gsRun('saveCacheData', cacheData).catch(console.error);
    }
  } catch (error) {
    console.error('Erreur sauvegarde cache:', error);
  }
};

// 9. FIX: Indicateur de connexion Google Apps Script
function checkGoogleAppsConnection() {
  const indicator = document.createElement('div');
  indicator.className = 'fixed bottom-4 right-4 text-xs';
  
  if (typeof google !== 'undefined' && google.script) {
    indicator.innerHTML = '<i class="fas fa-cloud text-green-500"></i> Connecté à Google';
  } else {
    indicator.innerHTML = '<i class="fas fa-cloud-slash text-gray-400"></i> Mode local';
  }
  
  document.body.appendChild(indicator);
  setTimeout(() => indicator.remove(), 3000);
}

// Appeler au chargement
setTimeout(checkGoogleAppsConnection, 1000);

// 10. FIX: Amélioration du tri des colonnes
window.sortColumn = function(classe, sortType, direction = 'asc') {
  const dropZone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
  if (!dropZone) return;

  const cards = Array.from(dropZone.querySelectorAll('.student-card'));
  const students = cards.map(card => ({
    card,
    data: STATE.students[card.dataset.id]
  })).filter(item => item.data); // Filtrer les éléments invalides

  const f = direction === 'asc' ? 1 : -1;

  switch (sortType) {
    case 'name':
      students.sort((a, b) => {
        const nameA = `${a.data.nom} ${a.data.prenom || ''}`.trim();
        const nameB = `${b.data.nom} ${b.data.prenom || ''}`.trim();
        return f * nameA.localeCompare(nameB, 'fr');
      });
      break;

    case 'lv2':
      students.sort((a, b) => {
        const ordre = ['ESP', 'ITA', 'ALL', 'LATIN', 'GRECO'];
        const lv2A = (a.data.lv2 || '').toUpperCase();
        const lv2B = (b.data.lv2 || '').toUpperCase();
        const iA = ordre.indexOf(lv2A);
        const iB = ordre.indexOf(lv2B);
        return f * ((iA === -1 ? 999 : iA) - (iB === -1 ? 999 : iB));
      });
      break;

    case 'option':
      students.sort((a, b) => {
        const optA = a.data.opt || 'ZZZZ';
        const optB = b.data.opt || 'ZZZZ';
        return f * optA.localeCompare(optB);
      });
      break;

    case 'score':
      students.sort((a, b) => {
        const scoreA = a.data.scores?.C || 0;
        const scoreB = b.data.scores?.C || 0;
        // Pour les scores, inverser la logique (meilleurs en haut)
        return -f * (scoreB - scoreA);
      });
      break;
  }

  // Réinjecter dans le DOM avec animation
  dropZone.style.opacity = '0.5';
  dropZone.innerHTML = '';
  students.forEach(({ card }, index) => {
    setTimeout(() => {
      dropZone.appendChild(card);
      if (index === students.length - 1) {
        dropZone.style.opacity = '1';
      }
    }, index * 10);
  });

  STATE.sortOrder[classe] = { type: sortType, dir: direction };
  
  // Notification
  toast(`Classe ${classe} triée par ${sortType}`, 'info');
};

console.log('✅ Patch de corrections appliqué');

// ========== MODULE DE GROUPES V2 - INTERFACE CLARIFIÉE ==========

// FIX: Ajout d'un bouton Groupes dans le header - Version modulaire
function addGroupsButton() {
  const nav = document.querySelector('.app-header nav');
  if (!nav || document.getElementById('btnGroups')) return;
  
  // Créer un wrapper pour le bouton et son menu
  const groupsWrapper = document.createElement('div');
  groupsWrapper.className = 'relative';
  groupsWrapper.id = 'groupsMenuWrapper';
  
  // Bouton principal avec flèche
  const btnGroups = document.createElement('button');
  btnGroups.id = 'btnGroups';
  btnGroups.className = 'btn btn-primary flex items-center gap-1';
  btnGroups.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
  
  // Menu déroulant
  const dropdown = document.createElement('div');
  dropdown.id = 'groupsDropdown';
  dropdown.className = 'absolute right-0 mt-2 w-64 bg-white rounded shadow-lg z-50 hidden p-2';
  dropdown.innerHTML = `
    <button onclick="openGroupsInterface()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-plus-circle text-green-600"></i> Créer des groupes
    </button>
    <button onclick="openGroupsInterface('manager')" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-cog text-blue-600"></i> Gérer les groupes
    </button>
    <button onclick="openGroupsInterface('templates')" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-layer-group text-purple-600"></i> Modèles de groupes
    </button>
    <hr class="my-2 border-gray-200">
    <button onclick="exportGroupsData()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
      <i class="fas fa-download text-purple-600"></i> Exporter tous les groupes
    </button>
    <button onclick="confirmDeleteAllGroups()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-red-600">
      <i class="fas fa-trash"></i> Supprimer tous les groupes
    </button>
  `;
  
  groupsWrapper.appendChild(btnGroups);
  groupsWrapper.appendChild(dropdown);
  
  // Gérer l'ouverture/fermeture du menu
  btnGroups.addEventListener('click', (e) => {
    e.stopPropagation();
    // Fermer tous les autres dropdowns
    document.querySelectorAll('.app-header .absolute').forEach(d => {
      if (d !== dropdown) d.classList.add('hidden');
    });
    dropdown.classList.toggle('hidden');
  });
  
  // Fermer le menu si on clique ailleurs
  document.addEventListener('click', () => {
    dropdown.classList.add('hidden');
  });
  
  dropdown.addEventListener('click', e => e.stopPropagation());
  
  nav.insertBefore(groupsWrapper, nav.firstChild);
}

// Mettre à jour le bouton pour afficher le nombre de groupes - Version modulaire
function updateGroupsButton() {
  const btn = document.getElementById('btnGroups');
  if (btn) {
    // Récupérer le nombre de groupes depuis le serveur
    google.script.run
      .withSuccessHandler(function(count) {
        if (count > 0) {
          btn.innerHTML = `<i class="fas fa-layer-group"></i> Groupes <span class="bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full text-xs ml-1">${count}</span> <i class="fas fa-caret-down"></i>`;
        } else {
          btn.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
        }
      })
      .getGroupsCount();
  }
}

// Fonction pour notifier les changements de groupes
function notifyGroupsChanged() {
  updateGroupsButton();
  // Autres actions à effectuer quand les groupes changent
  console.log('📊 Groupes mis à jour');
}


    
    document.body.appendChild(modal);
    this.currentStep = 1;
    this.selectedStudents = [];
    this.generatedGroups = [];

  

  // ========== CODE À AJOUTER/MODIFIER DANS INTERFACEV2.HTML ==========

// 1. Corriger la fonction openGroupsInterface pour éviter l'erreur de syntaxe
function openGroupsInterface(tab = 'creator') {
  console.log('🚀 Ouverture de l\'interface des groupes...');
  
  // Utiliser google.script.run pour récupérer l'interface
  google.script.run
    .withSuccessHandler(function(html) {
      try {
        // Créer une nouvelle fenêtre avec vérification
        const groupsWindow = window.open('', 'GroupsManager', 'width=1400,height=900,menubar=no,toolbar=no,scrollbars=yes,resizable=yes');
        
        // Vérifier que la fenêtre s'est bien ouverte
        if (!groupsWindow || groupsWindow.closed || typeof groupsWindow.closed === 'undefined') {
          console.error('❌ Impossible d\'ouvrir la fenêtre popup - bloquée par le navigateur');
          
          // Essayer d'ouvrir dans un nouvel onglet comme alternative
          try {
            const newTab = window.open('', '_blank');
            if (newTab) {
              newTab.document.open();
              newTab.document.write(html);
              newTab.document.close();
              console.log('✅ Interface ouverte dans un nouvel onglet');
              return;
            }
          } catch (tabError) {
            console.error('❌ Impossible d\'ouvrir dans un nouvel onglet:', tabError);
          }
          
          alert('⚠️ Impossible d\'ouvrir l\'interface des groupes. Veuillez autoriser les popups pour ce site et réessayer.');
          return;
        }
        
        // Écrire le HTML dans la nouvelle fenêtre avec gestion d'erreur
        try {
          groupsWindow.document.open();
          groupsWindow.document.write(html);
          groupsWindow.document.close();
        } catch (docError) {
          console.error('❌ Erreur lors de l\'écriture du document:', docError);
          groupsWindow.close();
          alert('Erreur lors du chargement de l\'interface des groupes');
          return;
        }
        
        // Attendre que GroupsUI soit chargé avant de changer d'onglet
        const checkInterval = setInterval(() => {
          try {
            if (groupsWindow.GroupsUI && typeof groupsWindow.GroupsUI.switchTab === 'function') {
              clearInterval(checkInterval);
              groupsWindow.GroupsUI.switchTab(tab);
              console.log('✅ Interface des groupes ouverte avec succès');
            }
          } catch (uiError) {
            console.error('❌ Erreur lors de l\'initialisation de GroupsUI:', uiError);
            clearInterval(checkInterval);
          }
        }, 100);
        
        // Timeout de sécurité
        setTimeout(() => {
          clearInterval(checkInterval);
        }, 5000);
        
      } catch (error) {
        console.error('❌ Erreur lors de l\'ouverture de l\'interface:', error);
        alert('Erreur lors de l\'ouverture de l\'interface des groupes: ' + error.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error('❌ Erreur serveur:', error);
      alert('Impossible de charger l\'interface des groupes: ' + error.message);
    })
    .getGroupsInterface();
}

// 2. Fonction pour notifier les changements de groupes
window.notifyGroupsChanged = function() {
  console.log('📢 Notification de changement de groupes reçue');
  updateGroupsButton();
  
  // Afficher un message de confirmation
  if (typeof toast === 'function') {
    toast('Groupes mis à jour avec succès', 'success');
  }
};

// 3. Fonction d'export améliorée
function exportGroupsData() {
  console.log('📤 Export des groupes...');
  
  google.script.run
    .withSuccessHandler(function(groupsData) {
      if (!groupsData || Object.keys(groupsData).length === 0) {
        alert('Aucun groupe à exporter');
        return;
      }
      
      // Créer le CSV avec point-virgule comme séparateur (compatible Excel FR)
      let csv = 'Type;Groupe;Nom;Prénom;Sexe;Classe d\'origine;Langue;Score COM;Score TRA;Score PART;Score ABS;Score Maths;Score Français\n';
      
      Object.entries(groupsData).forEach(([groupName, groupData]) => {
        groupData.students.forEach(student => {
          // Construire la ligne sans guillemets inutiles
          const line = [
            groupData.type || 'N/A',
            groupName,
            student.nom || '',
            student.prenom || '',
            student.sexe || '',
            student.classe || '',
            student.lv1Badge || student.lv1 || '', // Badge de langue ou valeur brute
            student.com || 0,
            student.tra || 0,
            student.part || 0,
            student.abs || 0,
            student.scores?.M || 0,
            student.scores?.F || 0
          ];
          
          csv += line.join(';') + '\n';
        });
      });
      
      // Télécharger le fichier
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `export_groupes_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast('Export CSV généré avec succès', 'success');
    })
    .withFailureHandler(function(error) {
      console.error('Erreur export:', error);
      alert('Erreur lors de l\'export: ' + error.message);
    })
    .getAllGroups();
}

// 4. Fonction de suppression avec confirmation améliorée
function confirmDeleteAllGroups() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md">
      <h3 class="text-lg font-bold mb-4 text-red-600">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        Suppression de tous les groupes
      </h3>
      <p class="text-gray-700 mb-6">
        Cette action supprimera définitivement tous les groupes créés. 
        Cette opération est irréversible.
      </p>
      <div class="flex justify-end gap-3">
        <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
          Annuler
        </button>
        <button onclick="deleteAllGroups(); this.closest('.fixed').remove();" class="btn btn-danger">
          <i class="fas fa-trash mr-2"></i>
          Supprimer tout
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function deleteAllGroups() {
  google.script.run
    .withSuccessHandler(function(success) {
      if (success) {
        updateGroupsButton();
        toast('Tous les groupes ont été supprimés', 'success');
      } else {
        toast('Erreur lors de la suppression', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Erreur suppression:', error);
      toast('Erreur: ' + error.message, 'error');
    })
    .deleteAllGroups();
}

// 5. Amélioration du menu dropdown des groupes
function createGroupsMenu() {
  const nav = document.querySelector('.app-header nav');
  if (!nav) return;
  
  // Créer le conteneur pour le bouton et le dropdown
  const groupsWrapper = document.createElement('div');
  groupsWrapper.className = 'relative';
  
  // Créer le bouton principal
  const btnGroups = document.createElement('button');
  btnGroups.id = 'btnGroups';
  btnGroups.className = 'nav-button relative';
  btnGroups.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
  
  // Créer le menu dropdown avec des animations
  const dropdown = document.createElement('div');
  dropdown.id = 'groupsDropdown';
  dropdown.className = 'absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-50 hidden opacity-0 transform scale-95 transition-all duration-200';
  dropdown.innerHTML = `
    <div class="py-2">
      <button onclick="openGroupsInterface('creator')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
        <i class="fas fa-plus-circle text-green-600"></i>
        <div>
          <div class="font-medium">Créer des groupes</div>
          <div class="text-xs text-gray-500">Langues ou besoins</div>
        </div>
      </button>
      
      <button onclick="openGroupsInterface('manager')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
        <i class="fas fa-cog text-blue-600"></i>
        <div>
          <div class="font-medium">Gérer les groupes</div>
          <div class="text-xs text-gray-500">Modifier ou supprimer</div>
        </div>
      </button>
      
      <button onclick="openGroupsInterface('templates')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
        <i class="fas fa-layer-group text-purple-600"></i>
        <div>
          <div class="font-medium">Modèles de groupes</div>
          <div class="text-xs text-gray-500">Configurations prédéfinies</div>
        </div>
      </button>
      
      <hr class="my-2 border-gray-200">
      
      <button onclick="exportGroupsData()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
        <i class="fas fa-download text-purple-600"></i>
        <div>
          <div class="font-medium">Exporter tous les groupes</div>
          <div class="text-xs text-gray-500">Format CSV</div>
        </div>
      </button>
      
      <button onclick="confirmDeleteAllGroups()" class="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-3 transition-colors text-red-600">
        <i class="fas fa-trash"></i>
        <div>
          <div class="font-medium">Supprimer tous les groupes</div>
          <div class="text-xs text-red-500">Action irréversible</div>
        </div>
      </button>
    </div>
  `;
  
  groupsWrapper.appendChild(btnGroups);
  groupsWrapper.appendChild(dropdown);
  
  // Gérer l'ouverture/fermeture avec animation
  btnGroups.addEventListener('click', (e) => {
    e.stopPropagation();
    
    // Fermer tous les autres dropdowns
    document.querySelectorAll('.app-header .absolute').forEach(d => {
      if (d !== dropdown && !d.classList.contains('hidden')) {
        d.classList.add('hidden', 'opacity-0', 'scale-95');
        d.classList.remove('opacity-100', 'scale-100');
      }
    });
    
    // Toggle ce dropdown avec animation
    if (dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('hidden');
      setTimeout(() => {
        dropdown.classList.remove('opacity-0', 'scale-95');
        dropdown.classList.add('opacity-100', 'scale-100');
      }, 10);
    } else {
      dropdown.classList.remove('opacity-100', 'scale-100');
      dropdown.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  });
  
  // Fermer le menu si on clique ailleurs
  document.addEventListener('click', () => {
    if (!dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('opacity-100', 'scale-100');
      dropdown.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  });
  
  dropdown.addEventListener('click', e => e.stopPropagation());
  
  // Insérer dans la navigation
  nav.insertBefore(groupsWrapper, nav.firstChild);
  
  // Mettre à jour le compteur
  updateGroupsButton();
}

// 6. Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
  // Créer le menu des groupes
  createGroupsMenu();
  
  // Autres initialisations...
});


// ========== FONCTIONS SUPPLÉMENTAIRES ==========

// Fonction pour ajouter des scores de matières
window.addSubjectScores = function() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="text-xl font-bold">Ajouter des scores de matières</h2>
        <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="bg-blue-50 p-3 rounded mb-4">
          <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle mr-1"></i>
            Importez un fichier Excel avec les colonnes : ID, MATH, FR
            ou saisissez manuellement les scores.
          </p>
        </div>
        
        <div class="mb-4">
          <button onclick="importSubjectScores()" class="btn btn-primary w-full">
            <i class="fas fa-upload"></i> Importer depuis Excel
          </button>
        </div>
        
        <div class="text-center text-gray-500 my-4">ou</div>
        
        <div>
          <h3 class="font-bold mb-2">Saisie manuelle rapide</h3>
          <div class="text-xs text-gray-600 mb-2">
            Sélectionnez une classe et attribuez des scores aléatoires pour tester
          </div>
          <select id="classForScores" class="form-control mb-2">
            <option value="">-- Sélectionner une classe --</option>
            ${Array.from(document.querySelectorAll('.classe-name'))
              .map(el => `<option value="${el.textContent}">${el.textContent}</option>`)
              .join('')}
          </select>
          <button onclick="generateRandomScores()" class="btn btn-secondary w-full">
            <i class="fas fa-dice"></i> Générer des scores aléatoires
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

// Générer des scores aléatoires pour tester
window.generateRandomScores = function() {
  const classe = document.getElementById('classForScores').value;
  if (!classe) {
    toast('Sélectionnez une classe', 'warning');
    return;
  }
  
  const zone = document.querySelector(`.droppable-zone[data-classe="${classe}"]`);
  if (!zone) return;
  
  let count = 0;
  zone.querySelectorAll('.student-card').forEach(card => {
    const eleve = STATE.students[card.dataset.id];
    if (eleve) {
      // Générer des scores cohérents avec le comportement
      const baseScore = eleve.scores?.C || 2.5;
      const variance = 0.5;
      
      eleve.scores.MATH = Math.max(1, Math.min(4, 
        baseScore + (Math.random() - 0.5) * 2 * variance
      ));
      
      eleve.scores.FR = Math.max(1, Math.min(4, 
        baseScore + (Math.random() - 0.5) * 2 * variance
      ));
      
      count++;
    }
  });
  
  toast(`${count} scores générés pour ${classe}`, 'success');
  document.querySelector('.modal').remove();
};

// ========== AMÉLIORATIONS PRIORITAIRES V2 ==========

// 0. FEEDBACK EN TEMPS RÉEL
window.RealTimeFeedback = {
  previousMetrics: null,
  isMinimized: false,
  
  // Initialiser le système de feedback
  init() {
    this.setupEventListeners();
    // Ne pas afficher automatiquement - seulement quand on est dans le menu des groupes
    this.updateMetrics();
  },
  
  // Configurer les événements
  setupEventListeners() {
    // Minimiser/maximiser le panneau
    document.getElementById('minimizeFeedback')?.addEventListener('click', () => {
      this.toggleMinimize();
    });
    
    // Fermer le panneau
    document.getElementById('closeFeedback')?.addEventListener('click', () => {
      this.hide();
    });
    
    // Rendre le panneau déplaçable
    this.makeDraggable();
  },
  
  // Rendre le panneau déplaçable
  makeDraggable() {
    const panel = document.getElementById('feedbackPanel');
    const header = panel?.querySelector('.feedback-header');
    
    if (!panel || !header) return;
    
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    
    header.addEventListener('mousedown', (e) => {
      if (e.target.tagName === 'BUTTON') return;
      
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      startLeft = parseInt(panel.style.left) || 0;
      startTop = parseInt(panel.style.top) || 0;
      
      panel.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;
      
      panel.style.left = (startLeft + deltaX) + 'px';
      panel.style.top = (startTop + deltaY) + 'px';
    });
    
    document.addEventListener('mouseup', () => {
      isDragging = false;
      panel.style.cursor = 'grab';
    });
  },
  
  // Afficher le panneau
  show() {
    const panel = document.getElementById('feedbackPanel');
    if (panel) {
      panel.style.display = 'block';
    }
  },
  
  // Masquer le panneau
  hide() {
    const panel = document.getElementById('feedbackPanel');
    if (panel) {
      panel.style.display = 'none';
    }
  },
  
  // Basculer minimisation
  toggleMinimize() {
    const panel = document.getElementById('feedbackPanel');
    if (!panel) return;
    
    this.isMinimized = !this.isMinimized;
    panel.classList.toggle('minimized', this.isMinimized);
    
    const icon = document.querySelector('#minimizeFeedback i');
    if (icon) {
      icon.className = this.isMinimized ? 'fas fa-expand' : 'fas fa-minus';
    }
  },
  
  // Calculer les métriques actuelles
  calculateMetrics() {
    const metrics = {
      balance: this.calculateBalance(),
      constraints: this.calculateConstraints(),
      diversity: this.calculateDiversity(),
      size: this.calculateSizeBalance(),
      scores: this.calculateScoreBalance(),
      mobility: this.calculateMobilityBalance(),
      globalScore: this.calculateGlobalScore()
    };
    
    return metrics;
  },
  
  // Calculer l'équilibre F/M
  calculateBalance() {
    let totalImbalance = 0;
    let classCount = 0;
    
    document.querySelectorAll('.class-column').forEach(col => {
      const students = col.querySelectorAll('.student-card');
      const fCount = Array.from(students).filter(card => 
        STATE.students[card.dataset.id]?.sexe === 'F'
      ).length;
      const mCount = Array.from(students).filter(card => 
        STATE.students[card.dataset.id]?.sexe === 'M'
      ).length;
      
      const imbalance = Math.abs(fCount - mCount);
      totalImbalance += imbalance;
      classCount++;
    });
    
    return classCount > 0 ? totalImbalance / classCount : 0;
  },
  
  // Calculer les violations de contraintes
  calculateConstraints() {
    return ConstraintManager ? ConstraintManager.validateAllConstraints().length : 0;
  },
  
  // Calculer la diversité des scores
  calculateDiversity() {
    let totalDiversity = 0;
    let classCount = 0;
    
    document.querySelectorAll('.class-column').forEach(col => {
      const students = col.querySelectorAll('.student-card');
      const scores = Array.from(students).map(card => {
        const student = STATE.students[card.dataset.id];
        return (student?.scores?.M || 0) + (student?.scores?.F || 0);
      }).filter(score => score > 0);
      
      if (scores.length > 1) {
        const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
        const variance = scores.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / scores.length;
        totalDiversity += Math.sqrt(variance);
      }
      classCount++;
    });
    
    return classCount > 0 ? totalDiversity / classCount : 0;
  },
  
  // Calculer l'équilibre des tailles
  calculateSizeBalance() {
    const sizes = Array.from(document.querySelectorAll('.class-column')).map(col => 
      col.querySelectorAll('.student-card').length
    );
    
    if (sizes.length === 0) return 0;
    
    const mean = sizes.reduce((a, b) => a + b, 0) / sizes.length;
    const variance = sizes.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / sizes.length;
    
    return Math.sqrt(variance);
  },
  
  // Calculer l'équilibre des scores
  calculateScoreBalance() {
    let totalImbalance = 0;
    let classCount = 0;
    
    document.querySelectorAll('.class-column').forEach(col => {
      const students = col.querySelectorAll('.student-card');
      const scores = Array.from(students).map(card => {
        const student = STATE.students[card.dataset.id];
        return (student?.scores?.M || 0) + (student?.scores?.F || 0);
      }).filter(score => score > 0);
      
      if (scores.length > 1) {
        const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
        const variance = scores.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / scores.length;
        totalImbalance += Math.sqrt(variance);
      }
      classCount++;
    });
    
    return classCount > 0 ? totalImbalance / classCount : 0;
  },
  
  // Calculer l'équilibre de mobilité
  calculateMobilityBalance() {
    let totalImbalance = 0;
    let classCount = 0;
    
    document.querySelectorAll('.class-column').forEach(col => {
      const students = col.querySelectorAll('.student-card');
      const permutCount = Array.from(students).filter(card => 
        STATE.students[card.dataset.id]?.mobilite === 'PERMUT'
      ).length;
      const fixeCount = Array.from(students).filter(card => 
        STATE.students[card.dataset.id]?.mobilite === 'FIXE'
      ).length;
      
      const imbalance = Math.abs(permutCount - fixeCount);
      totalImbalance += imbalance;
      classCount++;
    });
    
    return classCount > 0 ? totalImbalance / classCount : 0;
  },
  
  // Calculer le score global
  calculateGlobalScore() {
    const balance = this.calculateBalance();
    const constraints = this.calculateConstraints();
    const diversity = this.calculateDiversity();
    const size = this.calculateSizeBalance();
    const scores = this.calculateScoreBalance();
    const mobility = this.calculateMobilityBalance();
    
    // Score inversé (plus c'est bas, mieux c'est)
    const balanceScore = Math.max(0, 10 - balance * 2);
    const constraintScore = Math.max(0, 10 - constraints * 2);
    const diversityScore = Math.min(10, diversity);
    const sizeScore = Math.max(0, 10 - size);
    const scoreBalance = Math.min(10, scores);
    const mobilityScore = Math.max(0, 10 - mobility);
    
    return (balanceScore + constraintScore + diversityScore + sizeScore + scoreBalance + mobilityScore) / 6;
  },
  
  // Mettre à jour l'affichage des métriques
  updateMetrics() {
    const currentMetrics = this.calculateMetrics();
    
    // Mettre à jour les valeurs
    this.updateMetricValue('balanceValue', currentMetrics.balance.toFixed(1));
    this.updateMetricValue('constraintsValue', currentMetrics.constraints);
    this.updateMetricValue('diversityValue', currentMetrics.diversity.toFixed(1));
    this.updateMetricValue('sizeValue', currentMetrics.size.toFixed(1));
    this.updateMetricValue('scoresValue', currentMetrics.scores.toFixed(1));
    this.updateMetricValue('mobilityValue', currentMetrics.mobility.toFixed(1));
    this.updateMetricValue('globalScoreValue', currentMetrics.globalScore.toFixed(1));
    
    // Calculer et afficher les changements
    if (this.previousMetrics) {
      this.updateMetricChange('balanceChange', currentMetrics.balance, this.previousMetrics.balance);
      this.updateMetricChange('constraintsChange', currentMetrics.constraints, this.previousMetrics.constraints, true);
      this.updateMetricChange('diversityChange', currentMetrics.diversity, this.previousMetrics.diversity);
      this.updateMetricChange('sizeChange', currentMetrics.size, this.previousMetrics.size, true);
      this.updateMetricChange('scoresChange', currentMetrics.scores, this.previousMetrics.scores);
      this.updateMetricChange('mobilityChange', currentMetrics.mobility, this.previousMetrics.mobility);
      this.updateMetricChange('globalScoreChange', currentMetrics.globalScore, this.previousMetrics.globalScore);
    }
    
    this.previousMetrics = { ...currentMetrics };
  },
  
  // Mettre à jour une valeur de métrique
  updateMetricValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = value;
    }
  },
  
  // Mettre à jour l'indicateur de changement
  updateMetricChange(elementId, currentValue, previousValue, inverted = false) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const change = currentValue - previousValue;
    const changeElement = element.querySelector('span');
    const iconElement = element.querySelector('i');
    
    if (Math.abs(change) < 0.01) {
      // Pas de changement
      element.className = 'metric-change neutral';
      iconElement.className = 'fas fa-minus';
      changeElement.textContent = '0';
    } else {
      const isImprovement = inverted ? change < 0 : change > 0;
      
      element.className = `metric-change ${isImprovement ? 'improved' : 'degraded'}`;
      iconElement.className = isImprovement ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
      changeElement.textContent = Math.abs(change).toFixed(1);
      
      // Animation de pulse
      const metricValue = element.closest('.metric-value');
      metricValue.classList.add('changed');
      setTimeout(() => metricValue.classList.remove('changed'), 600);
    }
  },
  
  // Prévisualiser l'impact d'un déplacement
  previewMove(studentId, targetGroup) {
    if (!this.previousMetrics) return;
    
    // Simuler le déplacement
    const originalGroup = this.findStudentGroup(studentId);
    if (!originalGroup || originalGroup === targetGroup) return;
    
    // Calculer les nouvelles métriques
    const newMetrics = this.calculateMetricsWithMove(studentId, targetGroup);
    
    // Afficher les changements prévisionnels
    this.updateMetricChange('balanceChange', newMetrics.balance, this.previousMetrics.balance);
    this.updateMetricChange('constraintsChange', newMetrics.constraints, this.previousMetrics.constraints, true);
    this.updateMetricChange('diversityChange', newMetrics.diversity, this.previousMetrics.diversity);
    this.updateMetricChange('sizeChange', newMetrics.size, this.previousMetrics.size, true);
    this.updateMetricChange('globalScoreChange', newMetrics.globalScore, this.previousMetrics.globalScore);
  },
  
  // Trouver le groupe d'un élève
  findStudentGroup(studentId) {
    const card = document.querySelector(`[data-id="${studentId}"]`);
    return card?.closest('.class-column')?.querySelector('.classe-name')?.textContent;
  },
  
  // Calculer les métriques avec un déplacement simulé
  calculateMetricsWithMove(studentId, targetGroup) {
    // Implémentation simplifiée - en réalité, il faudrait simuler le déplacement
    // Pour l'instant, on retourne les métriques actuelles
    return this.calculateMetrics();
  },
  
  // Réinitialiser les changements
  resetChanges() {
    const changes = ['balanceChange', 'constraintsChange', 'diversityChange', 'sizeChange', 'scoresChange', 'mobilityChange', 'globalScoreChange'];
    changes.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.className = 'metric-change neutral';
        const icon = element.querySelector('i');
        const span = element.querySelector('span');
        if (icon) icon.className = 'fas fa-minus';
        if (span) span.textContent = '0';
      }
    });
  }
};

// 1. IMPORT DES SCORES INT
const ScoreImporter = {
  // Importer les scores depuis les fichiers INT
  async importScoresFromINT() {
    try {
      const result = await gsRun('getINTScores');
      if (result.success) {
        // Mapper les scores sur les élèves existants
        let importedCount = 0;
        result.scores.forEach(score => {
          if (STATE.students[score.id]) {
            STATE.students[score.id].scores.M = score.MATH;
            STATE.students[score.id].scores.F = score.FR;
            importedCount++;
          }
        });
        
        // Rafraîchir l'affichage
        this.refreshScoreDisplay();
        
        toast(`${importedCount} scores importés avec succès`, 'success');
        return { success: true, count: importedCount };
      } else {
        toast('Erreur lors de l\'import des scores', 'error');
        return { success: false, error: result.error };
      }
    } catch (error) {
      console.error('Erreur import scores:', error);
      toast('Erreur lors de l\'import des scores', 'error');
      return { success: false, error: error.message };
    }
  },

  // Rafraîchir l'affichage des scores
  refreshScoreDisplay() {
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (eleve && eleve.scores) {
        const scoresContainer = card.querySelector('.scores');
        if (scoresContainer) {
          scoresContainer.innerHTML = this.generateScoreBadges(eleve.scores);
        }
      }
    });
  },

  // Générer les badges de scores
  generateScoreBadges(scores) {
    const badges = [];

    // Scores existants (COM, TRA, PART, ABS) avec 4 couleurs distinctes
    const scoreMap = [
      { key: 'COM', label: 'Comportement', letter: 'C' },
      { key: 'TRA', label: 'Travail', letter: 'T' },
      { key: 'PART', label: 'Participation', letter: 'P' },
      { key: 'ABS', label: 'Absences', letter: 'A' }
    ];

    scoreMap.forEach(({ key, label, letter }) => {
      if (scores[key] !== undefined && scores[key] !== '' && scores[key] > 0) {
        const score = scores[key];
        // Utiliser les classes score-pill existantes pour avoir 4 couleurs distinctes :
        // score-1 = ROUGE, score-2 = JAUNE, score-3 = VERT CLAIR, score-4 = VERT FONCÉ
        badges.push(`<div class="score-pill score-${score}" title="${label}: ${score}/4">${letter}</div>`);
      }
    });

    // Nouveaux scores (MATH, FR) - garder l'ancien système
    ['M', 'F'].forEach(key => {
      if (scores[key] !== undefined && scores[key] !== '') {
        const score = scores[key];
        const color = score >= 3 ? 'bg-blue-100 text-blue-800' :
                     score >= 2 ? 'bg-orange-100 text-orange-800' :
                     'bg-red-100 text-red-800';
        const label = key === 'M' ? 'MATH' : 'FR';
        badges.push(`<span class="score-badge ${color} text-xs px-1 rounded">${label}:${score}</span>`);
      }
    });

    return badges.join('');
  },

  // Afficher les groupes existants
  showGroups() {
    const section = document.getElementById('groupsSection');
    if (section) {
      section.style.display = 'block';
      // Rafraîchir l'affichage si nécessaire
      if (Object.keys(this.groups).length > 0) {
        this.displaySavedGroups(true);
      }
    } else if (Object.keys(this.groups).length > 0) {
      // Si la section n'existe pas mais qu'il y a des groupes, la créer
      this.displaySavedGroups(true);
    } else {
      toast('Aucun groupe créé', 'info');
    }
  },

  // Masquer les groupes
  hideGroups() {
    const section = document.getElementById('groupsSection');
    if (section) {
      section.style.display = 'none';
    }
    toast('Groupes masqués', 'info');
  },

  // Basculer l'affichage des groupes
  toggleGroups() {
    const section = document.getElementById('groupsSection');
    if (section && section.style.display !== 'none') {
      this.hideGroups();
    } else {
      this.showGroups();
    }
  },

  // Supprimer tous les groupes
  deleteAllGroups() {
    if (!confirm('Supprimer TOUS les groupes créés ? Cette action est irréversible.')) return;
    
    this.groups = {};
    this.saveGroups();
    
    // Retirer la section
    const section = document.getElementById('groupsSection');
    if (section) section.remove();
    
    toast('Tous les groupes ont été supprimés', 'info');
  },

  // Mettre à jour le bouton pour afficher le nombre de groupes
  updateGroupsButton() {
    const btn = document.getElementById('btnGroups');
    if (btn && this.groups) {
      const count = Object.keys(this.groups).length;
      if (count > 0) {
        btn.innerHTML = `<i class="fas fa-layer-group"></i> Groupes <span class="bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full text-xs ml-1">${count}</span> <i class="fas fa-caret-down"></i>`;
      } else {
        btn.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
      }
    }
  }
};

// 2. ALGORITHME D'OPTIMISATION AMÉLIORÉ
const OptimizerV2 = {
  // Algorithme génétique simple pour optimiser l'équilibre
  optimizeGroupsGenetic(students, numGroups, iterations = 100) {
    // Créer population initiale
    let bestSolution = this.createInitialGroups(students, numGroups);
    let bestScore = this.evaluateSolution(bestSolution);
    
    for (let i = 0; i < iterations; i++) {
      // Mutation : échanger 2 élèves aléatoires
      const mutated = this.mutateSolution(bestSolution);
      const score = this.evaluateSolution(mutated);
      
      if (score > bestScore) {
        bestSolution = mutated;
        bestScore = score;
      }
    }
    
    return bestSolution;
  },

  // Créer des groupes initiaux
  createInitialGroups(students, numGroups) {
    const groups = Array(numGroups).fill(null).map(() => []);
    
    // Distribution aléatoire initiale
    students.forEach((student, index) => {
      const groupIndex = index % numGroups;
      groups[groupIndex].push(student);
    });
    
    return groups;
  },

  // Évaluer la qualité d'une solution
  evaluateSolution(groups) {
    let score = 100;
    
    // Pénalité pour déséquilibre de taille
    const avgSize = groups.reduce((sum, g) => sum + g.length, 0) / groups.length;
    groups.forEach(g => {
      score -= Math.abs(g.length - avgSize) * 5;
    });
    
    // Pénalité pour déséquilibre F/M
    groups.forEach(g => {
      const ratio = g.filter(s => s.sexe === 'F').length / g.length;
      score -= Math.abs(ratio - 0.5) * 50;
    });
    
    // Bonus pour hétérogénéité des scores
    groups.forEach(g => {
      const scores = g.map(s => (s.scores?.M || 0) + (s.scores?.F || 0));
      const variance = this.calculateVariance(scores);
      score += variance * 10; // Plus de variance = mieux
    });
    
    return score;
  },

  // Calculer la variance
  calculateVariance(scores) {
    if (scores.length === 0) return 0;
    const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
    return variance;
  },

  // Mutation d'une solution
  mutateSolution(groups) {
    const mutated = groups.map(g => [...g]); // Copie profonde
    
    // Sélectionner deux groupes aléatoires
    const group1Index = Math.floor(Math.random() * mutated.length);
    const group2Index = Math.floor(Math.random() * mutated.length);
    
    if (group1Index !== group2Index && mutated[group1Index].length > 0 && mutated[group2Index].length > 0) {
      // Sélectionner deux élèves aléatoires
      const student1Index = Math.floor(Math.random() * mutated[group1Index].length);
      const student2Index = Math.floor(Math.random() * mutated[group2Index].length);
      
      // Échanger les élèves
      const temp = mutated[group1Index][student1Index];
      mutated[group1Index][student1Index] = mutated[group2Index][student2Index];
      mutated[group2Index][student2Index] = temp;
    }
    
    return mutated;
  },

  // Appliquer l'optimisation ClaudeMotor depuis le backend
  applyOptimization() {
    // Afficher un loader
    const loadingToast = document.createElement('div');
    loadingToast.className = 'fixed top-4 right-4 bg-purple-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
    loadingToast.innerHTML = `
      <div class="flex items-center gap-3">
        <i class="fas fa-spinner fa-spin"></i>
        <div>
          <div class="font-bold">Optimisation en cours...</div>
          <div class="text-sm opacity-90">ClaudeMotor analyse vos classes</div>
        </div>
      </div>
    `;
    document.body.appendChild(loadingToast);

    // Appeler le backend
    google.script.run
      .withSuccessHandler((response) => {
        loadingToast.remove();

        if (response.success) {
          toast(`Optimisation terminée ! ${response.results.totalSwaps} échanges suggérés`, 'success');
          this.displayClaudeMotorResults(response.results);
        } else {
          toast(`Erreur: ${response.error}`, 'error');
          console.error('Erreur optimisation:', response);
        }
      })
      .withFailureHandler((error) => {
        loadingToast.remove();
        toast(`Erreur technique: ${error.message}`, 'error');
        console.error('Erreur appel backend:', error);
      })
      .lancerOptimisationClaudeMotor({
        maxIterations: 50,
        enableMultiSwap: true
      });
  },

  // Afficher les résultats ClaudeMotor
  displayClaudeMotorResults(results) {
    const modal = document.createElement('div');
    modal.className = 'modal';

    // Formater les swaps par phase
    let swapsHTML = '';
    if (results.swaps && results.swaps.length > 0) {
      swapsHTML = `
        <div class="mb-4">
          <h3 class="font-bold text-lg mb-2">📝 Échanges suggérés (${results.swaps.length})</h3>
          <div class="max-h-60 overflow-y-auto border rounded p-2">
            ${results.swaps.map((swap, i) => `
              <div class="text-sm p-2 bg-gray-50 rounded mb-2">
                <strong>#${i+1}</strong>:
                ${swap.student1?.nom || swap.studentSource?.nom || 'Élève 1'}
                (${swap.class1 || swap.sourceClass || '?'})
                ↔
                ${swap.student2?.nom || swap.studentTarget?.nom || 'Élève 2'}
                (${swap.class2 || swap.targetClass || '?'})
              </div>
            `).join('')}
          </div>
        </div>
      `;
    } else {
      swapsHTML = `
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded">
          <p class="text-green-800">✅ Aucun échange nécessaire - La répartition est déjà optimale !</p>
        </div>
      `;
    }

    modal.innerHTML = `
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h2 class="text-xl font-bold">🚀 Résultats ClaudeMotor</h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Scores -->
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="border rounded p-3 text-center">
              <div class="text-sm text-gray-600">Score initial</div>
              <div class="text-2xl font-bold text-gray-800">${results.scoreInitial.toFixed(1)}/100</div>
            </div>
            <div class="border rounded p-3 text-center">
              <div class="text-sm text-gray-600">Score final</div>
              <div class="text-2xl font-bold text-green-600">${results.scoreFinal.toFixed(1)}/100</div>
            </div>
            <div class="border rounded p-3 text-center">
              <div class="text-sm text-gray-600">Amélioration</div>
              <div class="text-2xl font-bold ${results.improvement >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${results.improvement >= 0 ? '+' : ''}${results.improvement.toFixed(1)}
              </div>
            </div>
          </div>

          <!-- Phases -->
          ${results.phases ? `
            <div class="mb-4">
              <h3 class="font-bold mb-2">📊 Détails des phases</h3>
              <div class="grid grid-cols-3 gap-2">
                <div class="text-xs border rounded p-2">
                  <strong>Phase 1 (Scores)</strong><br>
                  ${results.phases.phase1?.swaps?.length || 0} échanges
                </div>
                <div class="text-xs border rounded p-2">
                  <strong>Phase 2 (Parité)</strong><br>
                  ${results.phases.phase2?.corrections?.length || 0} corrections
                </div>
                <div class="text-xs border rounded p-2">
                  <strong>Phase 3 (MultiSwap)</strong><br>
                  ${results.phases.phase3?.cycles?.length || 0} cycles
                </div>
              </div>
            </div>
          ` : ''}

          ${swapsHTML}

          <!-- Boutons -->
          <div class="mt-4 flex gap-2">
            <button onclick="OptimizerV2.applyClaudeMotorSwaps()" class="btn btn-primary">
              <i class="fas fa-check"></i> Appliquer les échanges
            </button>
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Fermer
            </button>
          </div>

          <div class="mt-4 text-xs text-gray-500">
            ⏱️ Durée: ${results.duration}ms |
            🔄 ${results.totalSwaps} échanges au total
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // Sauvegarder les swaps pour application ultérieure
    window._claudeMotorSwaps = results.swaps;
  },

  // Appliquer les swaps ClaudeMotor
  applyClaudeMotorSwaps() {
    const swaps = window._claudeMotorSwaps;
    if (!swaps || swaps.length === 0) {
      toast('Aucun échange à appliquer', 'info');
      document.querySelector('.modal')?.remove();
      return;
    }

    // TODO: Implémenter l'application réelle des swaps dans l'interface
    // Pour l'instant, juste recharger les données
    toast(`Application de ${swaps.length} échanges...`, 'info');

    setTimeout(() => {
      toast('Échanges appliqués ! Rechargez les données pour voir les changements.', 'success');
      document.querySelector('.modal')?.remove();
    }, 1000);
  },

  // Afficher les résultats d'optimisation (ancien algorithme - conservé pour compatibilité)
  displayOptimizationResults(groups) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h2 class="text-xl font-bold">Résultats de l'optimisation</h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="grid grid-cols-2 gap-4">
            ${groups.map((group, index) => `
              <div class="border rounded p-3">
                <h4 class="font-bold mb-2">Groupe ${index + 1} (${group.length} élèves)</h4>
                <div class="text-sm text-gray-600 mb-2">
                  F: ${group.filter(s => s.sexe === 'F').length} | 
                  M: ${group.filter(s => s.sexe === 'M').length}
                </div>
                <div class="max-h-32 overflow-y-auto">
                  ${group.slice(0, 10).map(s => `
                    <div class="text-xs p-1 bg-gray-50 rounded mb-1">
                      ${s.nom} ${s.prenom || ''} (${s.sexe})
                    </div>
                  `).join('')}
                  ${group.length > 10 ? `<div class="text-xs text-gray-500">... et ${group.length - 10} autres</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
          <div class="mt-4 flex gap-2">
            <button onclick="OptimizerV2.applyOptimizationResults()" class="btn btn-primary">
              <i class="fas fa-check"></i> Appliquer cette répartition
            </button>
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Annuler
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },

  // Appliquer les résultats d'optimisation
  applyOptimizationResults() {
    // Cette fonction serait appelée pour appliquer réellement les changements
    toast('Optimisation appliquée', 'success');
    document.querySelector('.modal').remove();
  }
};

// 3. GESTION DES CONTRAINTES ASSO/DISSO AMÉLIORÉE
const ConstraintManager = {
  // Vérifier les contraintes avant tout déplacement
  checkGroupConstraints(studentId, targetGroup) {
    const student = STATE.students[studentId];
    if (!student) return { valid: false, reason: 'Élève non trouvé' };
    
    // Vérifier dissociation
    if (student.disso) {
      const conflictExists = targetGroup.some(s => 
        STATE.students[s.id] && STATE.students[s.id].disso === student.disso
      );
      if (conflictExists) {
        return { valid: false, reason: `Conflit dissociation D${student.disso}` };
      }
    }
    
    // Vérifier association
    if (student.asso) {
      const assoGroup = STATE.aGroups[`A${student.asso}`];
      if (assoGroup) {
        const allInSameGroup = assoGroup.every(id => 
          targetGroup.some(s => s.id === id) || id === studentId
        );
        if (!allInSameGroup) {
          return { valid: false, reason: `Groupe A${student.asso} doit rester ensemble` };
        }
      }
    }
    
    return { valid: true };
  },

  // Afficher visuellement les contraintes
  showConstraintsOverlay() {
    // Colorer les élèves avec le même code disso
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (eleve && eleve.disso) {
        card.style.border = '2px solid #ef4444';
        card.style.backgroundColor = '#fef2f2';
        
        // Ajouter un badge de contrainte
        let badge = card.querySelector('.constraint-badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'constraint-badge absolute -top-1 -right-1 bg-red-500 text-white text-xs px-1 rounded-full';
          badge.textContent = `D${eleve.disso}`;
          card.style.position = 'relative';
          card.appendChild(badge);
        }
      }
      
      // Relier visuellement les élèves avec le même code asso
      if (eleve && eleve.asso) {
        card.style.border = '2px solid #3b82f6';
        card.style.backgroundColor = '#eff6ff';
        
        let badge = card.querySelector('.constraint-badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'constraint-badge absolute -top-1 -right-1 bg-blue-500 text-white text-xs px-1 rounded-full';
          badge.textContent = `A${eleve.asso}`;
          card.style.position = 'relative';
          card.appendChild(badge);
        }
      }
    });
  },

  // Masquer les contraintes
  hideConstraintsOverlay() {
    document.querySelectorAll('.student-card').forEach(card => {
      card.style.border = '';
      card.style.backgroundColor = '';
      card.style.position = '';
      
      const badge = card.querySelector('.constraint-badge');
      if (badge) badge.remove();
    });
  },

  // Vérifier toutes les contraintes dans l'interface
  validateAllConstraints() {
    const violations = [];
    
    // Vérifier les dissociations
    const dissoGroups = {};
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (eleve && eleve.disso) {
        const classe = card.closest('.droppable-zone').dataset.classe;
        if (!dissoGroups[eleve.disso]) dissoGroups[eleve.disso] = [];
        dissoGroups[eleve.disso].push({ eleve, classe });
      }
    });
    
    Object.entries(dissoGroups).forEach(([code, eleves]) => {
      const classes = [...new Set(eleves.map(e => e.classe))];
      if (classes.length > 1) {
        violations.push({
          type: 'DISSO',
          code,
          message: `Code D${code} réparti sur ${classes.length} classes: ${classes.join(', ')}`
        });
      }
    });
    
    // Vérifier les associations
    const assoGroups = {};
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (eleve && eleve.asso) {
        const classe = card.closest('.droppable-zone').dataset.classe;
        if (!assoGroups[eleve.asso]) assoGroups[eleve.asso] = [];
        assoGroups[eleve.asso].push({ eleve, classe });
      }
    });
    
    Object.entries(assoGroups).forEach(([code, eleves]) => {
      const classes = [...new Set(eleves.map(e => e.classe))];
      if (classes.length > 1) {
        violations.push({
          type: 'ASSO',
          code,
          message: `Groupe A${code} séparé sur ${classes.length} classes: ${classes.join(', ')}`
        });
      }
    });
    
    return violations;
  },

  // Afficher les violations de contraintes
  showConstraintViolations() {
    const violations = this.validateAllConstraints();

    if (violations.length === 0) {
      toast('✅ Aucune violation de contrainte détectée', 'success');
      // Proposer d'ouvrir le panneau des contraintes
      this.showConstraintsPanel();
      return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2 class="text-xl font-bold text-red-600">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            ${violations.length} Violation(s) de contraintes
          </h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="space-y-3">
            ${violations.map(v => `
              <div class="p-3 border-l-4 ${v.type === 'DISSO' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'}">
                <div class="font-semibold ${v.type === 'DISSO' ? 'text-red-800' : 'text-blue-800'}">
                  ${v.type === 'DISSO' ? 'Dissociation' : 'Association'} ${v.code}
                </div>
                <div class="text-sm ${v.type === 'DISSO' ? 'text-red-700' : 'text-blue-700'}">
                  ${v.message}
                </div>
              </div>
            `).join('')}
          </div>
          <div class="mt-4 flex gap-2">
            <button onclick="ConstraintManager.showConstraintsOverlay()" class="btn btn-secondary">
              <i class="fas fa-eye"></i> Voir les contraintes
            </button>
            <button onclick="ConstraintManager.showConstraintsPanel(); this.closest('.modal').remove();" class="btn btn-secondary">
              <i class="fas fa-cog"></i> Gérer les contraintes
            </button>
            <button onclick="this.closest('.modal').remove()" class="btn btn-primary">
              <i class="fas fa-check"></i> Compris
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },

  // Afficher le panneau complet de gestion des contraintes
  showConstraintsPanel() {
    // Charger depuis le backend
    const loadingToast = document.createElement('div');
    loadingToast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg z-50';
    loadingToast.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Chargement des contraintes...';
    document.body.appendChild(loadingToast);

    google.script.run
      .withSuccessHandler((response) => {
        loadingToast.remove();
        if (response.success) {
          this.displayConstraintsPanel(response.constraints);
        } else {
          toast(`Erreur: ${response.error}`, 'error');
        }
      })
      .withFailureHandler((error) => {
        loadingToast.remove();
        toast(`Erreur: ${error.message}`, 'error');
      })
      .chargerContraintes();
  },

  // Afficher le panneau des contraintes
  displayConstraintsPanel(constraints) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'constraintsModal';

    // Analyser les contraintes actuelles de l'interface
    const currentDisso = {};
    const currentAsso = {};
    const currentFixe = [];

    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (!eleve) return;

      if (eleve.disso) {
        if (!currentDisso[eleve.disso]) currentDisso[eleve.disso] = [];
        currentDisso[eleve.disso].push(`${eleve.nom} ${eleve.prenom || ''}`);
      }
      if (eleve.asso) {
        if (!currentAsso[eleve.asso]) currentAsso[eleve.asso] = [];
        currentAsso[eleve.asso].push(`${eleve.nom} ${eleve.prenom || ''}`);
      }
      if (eleve.mobilite === 'FIXE') {
        const classe = card.closest('.droppable-zone')?.dataset.classe;
        currentFixe.push(`${eleve.nom} ${eleve.prenom || ''} (${classe || '?'})`);
      }
    });

    modal.innerHTML = `
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h2 class="text-2xl font-bold">
            <i class="fas fa-link mr-2"></i>
            Gestion des Contraintes
          </h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Structure from _STRUCTURE -->
          <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
            <h3 class="font-bold text-lg mb-2">
              <i class="fas fa-sitemap mr-2"></i>Structure (_STRUCTURE)
            </h3>
            <div class="text-sm space-y-2">
              ${constraints.structure && constraints.structure.length > 0 ? `
                <table class="w-full text-sm">
                  <thead class="bg-blue-100">
                    <tr>
                      <th class="p-2 text-left">Origine</th>
                      <th class="p-2 text-left">Destination</th>
                      <th class="p-2 text-center">Effectif</th>
                      <th class="p-2 text-left">Options</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${constraints.structure.map(s => `
                      <tr class="border-b">
                        <td class="p-2">${s.origine || '-'}</td>
                        <td class="p-2">${s.destination || '-'}</td>
                        <td class="p-2 text-center">${s.effectif || 28}</td>
                        <td class="p-2 text-xs">${s.options || '-'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              ` : '<p class="text-gray-600">Aucune structure définie dans _STRUCTURE</p>'}
            </div>
          </div>

          <!-- FIXE -->
          <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded">
            <h3 class="font-bold text-lg mb-2">
              <i class="fas fa-lock mr-2"></i>Élèves FIXE (${currentFixe.length})
            </h3>
            <p class="text-sm text-gray-600 mb-2">Ces élèves ne peuvent pas changer de classe</p>
            ${currentFixe.length > 0 ? `
              <div class="max-h-32 overflow-y-auto">
                ${currentFixe.map(e => `
                  <div class="text-sm p-1 bg-white rounded mb-1">${e}</div>
                `).join('')}
              </div>
            ` : '<p class="text-sm text-gray-500">Aucun élève fixé</p>'}
          </div>

          <!-- DISSO -->
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded">
            <h3 class="font-bold text-lg mb-2">
              <i class="fas fa-ban mr-2"></i>Codes DISSO (${Object.keys(currentDisso).length})
            </h3>
            <p class="text-sm text-gray-600 mb-2">Ces élèves NE DOIVENT PAS être dans la même classe</p>
            ${Object.keys(currentDisso).length > 0 ? `
              <div class="space-y-2">
                ${Object.entries(currentDisso).map(([code, eleves]) => `
                  <div class="p-2 bg-white rounded border border-red-300">
                    <div class="font-bold text-red-700">D${code} (${eleves.length} élèves)</div>
                    <div class="text-xs text-gray-700">${eleves.join(', ')}</div>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="text-sm text-gray-500">Aucune dissociation définie</p>'}
          </div>

          <!-- ASSO -->
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded">
            <h3 class="font-bold text-lg mb-2">
              <i class="fas fa-users mr-2"></i>Codes ASSO (${Object.keys(currentAsso).length})
            </h3>
            <p class="text-sm text-gray-600 mb-2">Ces élèves DOIVENT rester ensemble</p>
            ${Object.keys(currentAsso).length > 0 ? `
              <div class="space-y-2">
                ${Object.entries(currentAsso).map(([code, eleves]) => `
                  <div class="p-2 bg-white rounded border border-green-300">
                    <div class="font-bold text-green-700">A${code} (${eleves.length} élèves)</div>
                    <div class="text-xs text-gray-700">${eleves.join(', ')}</div>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="text-sm text-gray-500">Aucune association définie</p>'}
          </div>

          <!-- Options et LV2 -->
          <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <h3 class="font-bold text-lg mb-2">
              <i class="fas fa-star mr-2"></i>Contraintes OPT et LV2
            </h3>
            <p class="text-sm text-gray-600 mb-2">Vérification des quotas d'options par classe</p>
            <div class="text-sm">
              <p class="text-gray-700">✅ Les contraintes d'options sont vérifiées automatiquement lors des déplacements</p>
              <p class="text-gray-700 mt-1">ℹ️ Voir _STRUCTURE pour les quotas définis par classe</p>
            </div>
          </div>

          <!-- Boutons -->
          <div class="mt-4 flex gap-2">
            <button onclick="ConstraintManager.showConstraintsOverlay()" class="btn btn-secondary">
              <i class="fas fa-eye"></i> Visualiser sur les cartes
            </button>
            <button onclick="window.open('https://docs.google.com/spreadsheets/d/' + google.script.host.origin.split('/')[2] + '/edit#gid=SHEET_ID_STRUCTURE', '_blank')" class="btn btn-secondary">
              <i class="fas fa-external-link-alt"></i> Ouvrir _STRUCTURE
            </button>
            <button onclick="this.closest('.modal').remove()" class="btn btn-primary">
              <i class="fas fa-check"></i> Fermer
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
};

// 4. GESTIONNAIRE DE FILTRES
const FilterManager = {
  activeFilters: {},

  // Afficher le panneau de filtres
  showFiltersPanel() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'filtersModal';

    // Collecter les valeurs uniques pour chaque filtre
    const lv2Set = new Set();
    const optSet = new Set();
    const dissoSet = new Set();
    const assoSet = new Set();
    const mobiliteSet = new Set();
    const scoresCOM = new Set();

    Object.values(STATE.students || {}).forEach(eleve => {
      if (eleve.lv2) lv2Set.add(eleve.lv2);
      if (eleve.opt) optSet.add(eleve.opt);
      if (eleve.disso) dissoSet.add(eleve.disso);
      if (eleve.asso) assoSet.add(eleve.asso);
      if (eleve.mobilite) mobiliteSet.add(eleve.mobilite);
      if (eleve.scores && eleve.scores.COM) scoresCOM.add(eleve.scores.COM);
    });

    modal.innerHTML = `
      <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h2 class="text-2xl font-bold">
            <i class="fas fa-filter mr-2"></i>
            Filtres
          </h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p class="text-sm text-gray-600 mb-4">
            Filtrez les élèves affichés selon leurs caractéristiques. Les élèves non filtrés seront grisés.
          </p>

          <!-- Filtres actifs -->
          <div id="activeFiltersDisplay" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded ${Object.keys(this.activeFilters).length === 0 ? 'hidden' : ''}">
            <h4 class="font-bold text-sm mb-2">Filtres actifs :</h4>
            <div id="activeFiltersList" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- LV2 -->
          <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">
              <i class="fas fa-language mr-2"></i>LV2
            </h3>
            <div class="flex flex-wrap gap-2">
              ${Array.from(lv2Set).sort().map(lv2 => `
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="filter-checkbox mr-2" data-filter-type="lv2" data-filter-value="${lv2}">
                  <span class="text-sm px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">${lv2}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- OPT -->
          <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">
              <i class="fas fa-star mr-2"></i>Options
            </h3>
            <div class="flex flex-wrap gap-2">
              ${Array.from(optSet).sort().map(opt => `
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="filter-checkbox mr-2" data-filter-type="opt" data-filter-value="${opt}">
                  <span class="text-sm px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">${opt}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- DISSO -->
          <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">
              <i class="fas fa-ban mr-2 text-red-600"></i>Codes DISSO
            </h3>
            <div class="flex flex-wrap gap-2">
              ${Array.from(dissoSet).sort().map(disso => `
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="filter-checkbox mr-2" data-filter-type="disso" data-filter-value="${disso}">
                  <span class="text-sm px-3 py-1 bg-red-100 rounded hover:bg-red-200">D${disso}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- ASSO -->
          <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">
              <i class="fas fa-users mr-2 text-green-600"></i>Codes ASSO
            </h3>
            <div class="flex flex-wrap gap-2">
              ${Array.from(assoSet).sort().map(asso => `
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="filter-checkbox mr-2" data-filter-type="asso" data-filter-value="${asso}">
                  <span class="text-sm px-3 py-1 bg-green-100 rounded hover:bg-green-200">A${asso}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- Mobilité -->
          <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">
              <i class="fas fa-exchange-alt mr-2"></i>Mobilité
            </h3>
            <div class="flex flex-wrap gap-2">
              ${Array.from(mobiliteSet).sort().map(mob => `
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="filter-checkbox mr-2" data-filter-type="mobilite" data-filter-value="${mob}">
                  <span class="text-sm px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">${mob}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- Score COM -->
          <div class="mb-4 p-4 border rounded">
            <h3 class="font-bold mb-2">
              <i class="fas fa-chart-bar mr-2"></i>Score Comportement
            </h3>
            <div class="flex gap-2">
              ${Array.from(scoresCOM).sort().map(score => `
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="filter-checkbox mr-2" data-filter-type="scoreCOM" data-filter-value="${score}">
                  <span class="text-sm px-3 py-1 rounded ${
                    score == 1 ? 'bg-red-500 text-white' :
                    score == 2 ? 'bg-yellow-400 text-gray-800' :
                    score == 3 ? 'bg-green-400 text-white' :
                    'bg-green-600 text-white'
                  }">${score}</span>
                </label>
              `).join('')}
            </div>
          </div>

          <!-- Boutons -->
          <div class="mt-4 flex gap-2">
            <button onclick="FilterManager.applyFilters()" class="btn btn-primary">
              <i class="fas fa-check"></i> Appliquer les filtres
            </button>
            <button onclick="FilterManager.clearAllFilters()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Effacer tous les filtres
            </button>
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Fermer
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Restaurer les filtres actifs
    Object.keys(this.activeFilters).forEach(key => {
      const [type, value] = key.split(':');
      const checkbox = modal.querySelector(`[data-filter-type="${type}"][data-filter-value="${value}"]`);
      if (checkbox) checkbox.checked = true;
    });

    // Gérer les changements de checkbox
    modal.querySelectorAll('.filter-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        this.updateActiveFiltersDisplay(modal);
      });
    });

    this.updateActiveFiltersDisplay(modal);
  },

  // Mettre à jour l'affichage des filtres actifs
  updateActiveFiltersDisplay(modal) {
    const checkedBoxes = modal.querySelectorAll('.filter-checkbox:checked');
    const display = modal.querySelector('#activeFiltersDisplay');
    const list = modal.querySelector('#activeFiltersList');

    if (checkedBoxes.length === 0) {
      display.classList.add('hidden');
      return;
    }

    display.classList.remove('hidden');
    list.innerHTML = Array.from(checkedBoxes).map(checkbox => {
      const type = checkbox.dataset.filterType;
      const value = checkbox.dataset.filterValue;
      return `
        <span class="px-2 py-1 bg-blue-500 text-white text-xs rounded">
          ${type}: ${value}
        </span>
      `;
    }).join('');
  },

  // Appliquer les filtres
  applyFilters() {
    const modal = document.getElementById('filtersModal');
    if (!modal) return;

    const checkedBoxes = modal.querySelectorAll('.filter-checkbox:checked');

    // Sauvegarder les filtres actifs
    this.activeFilters = {};
    checkedBoxes.forEach(checkbox => {
      const type = checkbox.dataset.filterType;
      const value = checkbox.dataset.filterValue;
      this.activeFilters[`${type}:${value}`] = { type, value };
    });

    // Appliquer le filtre sur toutes les cartes
    document.querySelectorAll('.student-card').forEach(card => {
      const eleve = STATE.students[card.dataset.id];
      if (!eleve) return;

      let match = true;

      if (checkedBoxes.length > 0) {
        match = Array.from(checkedBoxes).some(checkbox => {
          const type = checkbox.dataset.filterType;
          const value = checkbox.dataset.filterValue;

          switch(type) {
            case 'lv2': return eleve.lv2 === value;
            case 'opt': return eleve.opt === value;
            case 'disso': return eleve.disso === value;
            case 'asso': return eleve.asso === value;
            case 'mobilite': return eleve.mobilite === value;
            case 'scoreCOM': return eleve.scores && eleve.scores.COM == value;
            default: return false;
          }
        });
      }

      if (match) {
        card.style.opacity = '1';
        card.style.filter = 'none';
      } else {
        card.style.opacity = '0.3';
        card.style.filter = 'grayscale(1)';
      }
    });

    modal.remove();

    if (checkedBoxes.length > 0) {
      toast(`${checkedBoxes.length} filtre(s) appliqué(s)`, 'success');
    } else {
      toast('Tous les filtres effacés', 'info');
    }
  },

  // Effacer tous les filtres
  clearAllFilters() {
    this.activeFilters = {};

    document.querySelectorAll('.student-card').forEach(card => {
      card.style.opacity = '1';
      card.style.filter = 'none';
    });

    const modal = document.getElementById('filtersModal');
    if (modal) {
      modal.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
      this.updateActiveFiltersDisplay(modal);
    }

    toast('Tous les filtres effacés', 'info');
  }
};

// 5. TEMPLATES DE GROUPES RÉUTILISABLES
// 6. HISTORIQUE DÉTAILLÉ AVEC DIFF
const HistoryManager = {
  history: [],
  maxHistory: 50,

  // Sauvegarder l'état actuel
  saveState() {
    const state = this.captureCurrentState();
    this.history.push({
      timestamp: new Date(),
      state: state
    });
    
    // Limiter la taille de l'historique
    if (this.history.length > this.maxHistory) {
      this.history.shift();
    }
  },

  // Capturer l'état actuel
  captureCurrentState() {
    const state = {};
    
    document.querySelectorAll('.class-column').forEach(col => {
      const classe = col.querySelector('.classe-name').textContent;
      state[classe] = [];
      
      col.querySelectorAll('.student-card').forEach(card => {
        const eleve = STATE.students[card.dataset.id];
        if (eleve) {
          state[classe].push(eleve.id);
        }
      });
    });
    
    return state;
  },

  // Comparer deux états
  compareStates(before, after) {
    const changes = [];
    
    // Trouver les classes communes
    const allClasses = new Set([...Object.keys(before), ...Object.keys(after)]);
    
    allClasses.forEach(classe => {
      const beforeStudents = before[classe] || [];
      const afterStudents = after[classe] || [];
      
      // Élèves ajoutés
      const added = afterStudents.filter(id => !beforeStudents.includes(id));
      
      // Élèves retirés
      const removed = beforeStudents.filter(id => !afterStudents.includes(id));
      
      if (added.length || removed.length) {
        changes.push({
          classe,
          added: added.map(id => STATE.students[id]?.nom || id),
          removed: removed.map(id => STATE.students[id]?.nom || id),
          timestamp: new Date()
        });
      }
    });
    
    return changes;
  },

  // Afficher l'historique des changements
  showHistory() {
    if (this.history.length < 2) {
      toast('Pas assez d\'historique pour comparer', 'warning');
    return;
    }
    
    const recent = this.history.slice(-5); // 5 derniers états
    const changes = [];
    
    for (let i = 1; i < recent.length; i++) {
      const stateChanges = this.compareStates(recent[i-1].state, recent[i].state);
      if (stateChanges.length > 0) {
        changes.push({
          timestamp: recent[i].timestamp,
          changes: stateChanges
        });
      }
    }
    
    if (changes.length === 0) {
      toast('Aucun changement détecté', 'info');
      return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h2 class="text-xl font-bold">Historique des changements</h2>
          <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="space-y-4">
            ${changes.map(change => `
              <div class="border rounded p-3">
                <div class="font-semibold text-sm text-gray-600 mb-2">
                  ${change.timestamp.toLocaleString()}
                </div>
                ${change.changes.map(c => `
                  <div class="ml-4 mb-2">
                    <div class="font-medium">${c.classe}</div>
                    ${c.added.length > 0 ? `
                      <div class="text-green-600 text-sm">
                        <i class="fas fa-plus"></i> Ajoutés: ${c.added.join(', ')}
                      </div>
                    ` : ''}
                    ${c.removed.length > 0 ? `
                      <div class="text-red-600 text-sm">
                        <i class="fas fa-minus"></i> Retirés: ${c.removed.join(', ')}
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },

  // Annuler le dernier changement
  undo() {
    if (this.history.length < 2) {
      toast('Rien à annuler', 'warning');
      return;
    }
    
    const previousState = this.history[this.history.length - 2].state;
    this.restoreState(previousState);
    this.history.pop(); // Retirer l'état actuel
    
    toast('Changement annulé', 'success');
  },

  // Restaurer un état
  restoreState(state) {
    // Cette fonction restaurerait l'état précédent
    // Implémentation complexe qui nécessiterait de modifier l'interface
    console.log('Restauration de l\'état:', state);
  }
};

// 7. MODE SIMULATION
// ========== INTÉGRATION DES NOUVELLES FONCTIONS ==========

// Ajouter les boutons dans l'interface
// ========== CONFIGURATION DES BOUTONS AVANCÉS DANS LE MENU ACTIONS ==========
function configureAdvancedFeaturesButtons() {
  // Bouton Import Scores
  const importBtn = document.getElementById('btnImportScores');
  if (importBtn) {
    importBtn.onclick = () => {
      ScoreImporter.importScoresFromINT();
      // Fermer le menu après clic
      document.getElementById('actionsDropdown').classList.add('hidden');
    };
  }
  
  // Bouton Optimisation
  const optimizeBtn = document.getElementById('btnOptimize');
  if (optimizeBtn) {
    optimizeBtn.onclick = () => {
      OptimizerV2.applyOptimization();
      document.getElementById('actionsDropdown').classList.add('hidden');
    };
  }
  
  // Bouton Contraintes
  const constraintsBtn = document.getElementById('btnConstraints');
  if (constraintsBtn) {
    constraintsBtn.onclick = () => {
      ConstraintManager.showConstraintViolations();
      document.getElementById('actionsDropdown').classList.add('hidden');
    };
  }
  
  // Bouton Feedback en temps réel (dans le menu des groupes)
  document.addEventListener('click', (e) => {
    if (e.target.closest('#btnGroupFeedback')) {
      if (RealTimeFeedback) {
        const panel = document.getElementById('feedbackPanel');
        if (panel && panel.style.display === 'none') {
          RealTimeFeedback.show();
          e.target.closest('#btnGroupFeedback').innerHTML = '<i class="fas fa-chart-line"></i> Masquer';
        } else {
          RealTimeFeedback.hide();
          e.target.closest('#btnGroupFeedback').innerHTML = '<i class="fas fa-chart-line"></i> Indicateurs';
        }
      }
    }
    
    // Bouton Statistiques des groupes
    if (e.target.closest('#btnGroupStats')) {
      const statsPanel = document.getElementById('statsPanel');
      if (statsPanel) {
        // Basculer l'affichage du panneau de statistiques
        if (statsPanel.classList.contains('translate-x-full')) {
          statsPanel.classList.remove('translate-x-full');
          
          // Initialiser le contenu seulement si pas encore fait
          const statsContent = document.getElementById('statsContent');
          if (!statsContent.innerHTML.trim()) {
            console.log('📊 Première ouverture - initialisation du contenu');
            if (typeof initCharts === 'function') {
              initCharts();
            }
          }
          
          // MISE À JOUR INTELLIGENTE DES STATISTIQUES
          if (typeof updateStatsPanel === 'function') {
            updateStatsPanel();
          }
          
          // Changer le titre pour indiquer qu'on affiche les stats des groupes
          const title = statsPanel.querySelector('h2');
          if (title) {
            title.textContent = 'Statistiques des Groupes';
          }
        } else {
          statsPanel.classList.add('translate-x-full');
        }
      }
    }
  });
}

// ========== INITIALISATION AU CHARGEMENT ==========

// Ajouter au DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Initialiser le feedback en temps réel (mais ne pas l'afficher automatiquement)
  setTimeout(() => {
    if (RealTimeFeedback) {
      RealTimeFeedback.init();
    }
  }, 500);
  
  // Configurer les boutons avancés dans le menu Actions après un délai
  setTimeout(() => {
    configureAdvancedFeaturesButtons();
  }, 2000);
  
  // Configurer le bouton de fermeture du panneau des statistiques
  const closeStatsBtn = document.getElementById('closeStats');
  if (closeStatsBtn) {
    closeStatsBtn.addEventListener('click', () => {
      const statsPanel = document.getElementById('statsPanel');
      if (statsPanel) {
        statsPanel.classList.add('translate-x-full');
        // Mettre à jour aria-expanded
        const btnStats = document.getElementById('btnStats');
        if (btnStats) btnStats.setAttribute('aria-expanded', 'false');
        console.log('📊 Panneau des statistiques fermé manuellement');

      }
    });
  }

  // Sauvegarder l'état initial
  setTimeout(() => {
    HistoryManager.saveState();
  }, 3000);
});

// Fonction pour initialiser les groupes après fermeture du modal
window.initializeGroupsAfterModal = function() {
  // Ajouter le bouton Groupes
  addGroupsButton();
  
  // Charger les groupes sauvegardés SANS les afficher
  if (GroupManager && GroupManager.loadGroups) {
    GroupManager.loadGroups();
    
    // Mettre à jour le bouton pour afficher le nombre
    if (GroupManager.updateGroupsButton) {
      GroupManager.updateGroupsButton();
    }
  }
};

console.log('✅ Module de groupes et améliorations V2 appliqués');

// ========== PATCH CORRECTIF POUR STATISTIQUES FLUIDES ==========
// (ANCIENNE VERSION SUPPRIMÉE - REMPLACÉE PAR LA VERSION PROTÉGÉE)

// 2. ANCIENNE VERSION DE updateAllColumnStats SUPPRIMÉE - REMPLACÉE PAR LA VERSION PROPRE

// 3. SUPPRIMÉ - Redéfinition problématique de updateCharts
// La vraie fonction updateCharts est maintenant utilisée directement

// 4. Améliorer le feedback en temps réel avec throttle
if (window.RealTimeFeedback) {
  const originalUpdateMetrics = RealTimeFeedback.updateMetrics;
  let lastUpdate = 0;
  const THROTTLE_DELAY = 500; // Mise à jour max toutes les 500ms
  
  RealTimeFeedback.updateMetrics = function() {
    const now = Date.now();
    if (now - lastUpdate < THROTTLE_DELAY) {
      return;
    }
    lastUpdate = now;
    
    if (originalUpdateMetrics) {
      originalUpdateMetrics.call(this);
    }
  };
}

// 5. ANCIENNE VERSION DE handleSortEnd SUPPRIMÉE - REMPLACÉE PAR LA VERSION PROPRE

// 6. CSS pour animations fluides (à ajouter dans une balise style)
const fluidStyles = document.createElement('style');
fluidStyles.textContent = `
  /* Animation fluide pour le panneau stats */
  #statsPanel {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease;
  }
  
  #statsPanel.updating {
    opacity: 0.95;
  }
  
  /* Transition fluide pour les graphiques */
  .chart-container {
    transition: opacity 0.2s ease;
  }
  
  .stats-panel.updating .chart-container {
    opacity: 0.8;
  }
  
  /* Empêcher le scintillement des métriques */
  .metric-value {
    transition: color 0.2s ease, transform 0.2s ease;
  }
  
  .metric-value.changed {
    transform: scale(1.05);
  }
  
  /* Animation subtile pour les mises à jour */
  @keyframes gentlePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.9; }
  }
  
  .stats-panel.updating {
    animation: gentlePulse 0.6s ease-in-out;
  }
`;
document.head.appendChild(fluidStyles);

// 7. Fonction utilitaire pour vérifier l'état des graphiques
window.areChartsReady = function() {
  return window.chartCommunication && 
         window.chartDistribution && 
         window.chartLV2 && 
         window.chartOptions &&
         typeof window.chartCommunication.update === 'function';
};

// 8. Optimiser le rendu des cartes élèves
window.optimizeCardRendering = function() {
  // Utiliser requestAnimationFrame pour les mises à jour visuelles
  const cards = document.querySelectorAll('.student-card');
  let index = 0;
  
  function processNextBatch() {
    const batchSize = 10;
    const batch = Array.from(cards).slice(index, index + batchSize);
    
    batch.forEach(card => {
      // Appliquer les optimisations de rendu
      card.style.willChange = 'transform';
      card.style.backfaceVisibility = 'hidden';
    });
    
    index += batchSize;
    
    if (index < cards.length) {
      requestAnimationFrame(processNextBatch);
    }
  }
  
  requestAnimationFrame(processNextBatch);
};

// 9. Nettoyer les fonctions dupliquées au chargement
document.addEventListener('DOMContentLoaded', () => {
  // Supprimer les event listeners dupliqués
  const processedElements = new Set();
  
  document.querySelectorAll('[id]').forEach(element => {
    if (processedElements.has(element.id)) {
      console.warn(`Élément dupliqué détecté: ${element.id}`);
      return;
    }
    processedElements.add(element.id);
  });
  
  // Optimiser le rendu initial
  setTimeout(optimizeCardRendering, 1000);
});

console.log('✅ Patch de fluidité des statistiques appliqué');

// ========== CORRECTIONS FINALES SUPPLÉMENTAIRES ==========

// 1. Initialisation sécurisée des variables globales manquantes
if (typeof window.chartLV2Details === 'undefined') {
  window.chartLV2Details = null;
}

// 2. Fonction utilitaire pour mise à jour sécurisée des graphiques
window.safeUpdateChart = function(chart) {
  if (chart && typeof chart.update === 'function') {
    try {
      chart.update('none'); // Mise à jour sans animation pour plus de fluidité
    } catch (error) {
      console.warn('Erreur mise à jour graphique:', error);
    }
  }
};

// 3. Système de gestion des event listeners pour éviter les doublons
window.EventManager = {
  listeners: [],
  
  add: function(element, event, handler, options = {}) {
    // Vérifier si le listener existe déjà
    const existing = this.listeners.find(l => 
      l.element === element && l.event === event && l.handler === handler
    );
    
    if (!existing) {
      element.addEventListener(event, handler, options);
      this.listeners.push({element, event, handler, options});
    }
  },
  
  remove: function(element, event, handler) {
    element.removeEventListener(event, handler);
    this.listeners = this.listeners.filter(l => 
      !(l.element === element && l.event === event && l.handler === handler)
    );
  },
  
  clear: function() {
    this.listeners.forEach(({element, event, handler}) => {
      element.removeEventListener(event, handler);
    });
    this.listeners = [];
  }
};

// 4. Initialisation unique de l'application
window.addEventListener('DOMContentLoaded', () => {
  // Éviter les initialisations multiples
  if (window._initialized) {
    console.log('⚠️ Application déjà initialisée, skip');
    return;
  }
  window._initialized = true;
  
  console.log('🚀 Initialisation unique de l\'application');
  
  // Nettoyer les anciens event listeners
  if (window.EventManager) {
    window.EventManager.clear();
  }
  
  // Attendre que tout soit chargé
  setTimeout(() => {
    if (typeof initRepartitionApp === 'function') {
      initRepartitionApp();
    }
  }, 100);
});

// 5. CSS pour transitions fluides (si pas déjà présent)
if (!document.getElementById('fluid-animations-style')) {
  const style = document.createElement('style');
  style.id = 'fluid-animations-style';
  style.textContent = `
    .stats-panel {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .student-card {
      transition: all 0.2s ease;
      will-change: transform;
    }
    
    .chart-container {
      transition: opacity 0.3s ease;
    }
    
    /* Amélioration des animations de drag & drop */
    .sortable-ghost {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .sortable-chosen {
      transform: scale(1.05);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    /* Animation pour les mises à jour de statistiques */
    .stats-updating {
      animation: gentlePulse 0.6s ease-in-out;
    }
    
    @keyframes gentlePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.9; }
    }
  `;
  document.head.appendChild(style);
}

// ========== ANCIENNES VERSIONS SUPPRIMÉES - REMPLACÉES PAR LA VERSION PROPRE ==========
// Toutes les anciennes versions de updateStatsPanel et les protections excessives ont été supprimées
// et remplacées par la version propre ajoutée à la fin du fichier
</script>

<!-- TEMPLATES - À PLACER JUSTE AVANT LA FIN DU BODY -->
<template id="tpl-carte-eleve">
  <div class="student-card" draggable="true" data-id="">
    <div class="card-line card-line-1">
      <div class="student-fullname"></div>
      <div class="badge-dispo-container"></div>
    </div>
    <div class="card-line card-line-2 justify-center">
      <div class="all-badges flex gap-1 flex-wrap"></div>
    </div>
    <div class="card-line card-line-3">
      <div class="source-class text-xs font-medium text-gray-700"></div>
      <div class="scores flex gap-1"></div>
    </div>
  </div>
</template>

<template id="tpl-classe-col">
  <div class="class-column fade-in">
    <div class="class-header">
      <div class="class-title-line">
        <h2 class="classe-name"></h2>
        <div class="class-counts">
          <span><i class="fas fa-users opacity-75"></i> <span class="count font-bold">0</span></span>
          <span class="text-pink-200"><i class="fas fa-venus"></i> <span class="count-f font-bold">0</span></span>
          <span class="text-blue-200"><i class="fas fa-mars"></i> <span class="count-m font-bold">0</span></span>
        </div>
      </div>
      <div class="sort-buttons">
        <button class="sort-btn" data-sort="name" title="Trier par nom"><i class="fas fa-sort-alpha-down"></i></button>
        <button class="sort-btn" data-sort="lv2" title="Trier par LV2"><i class="fas fa-language"></i></button>
        <button class="sort-btn" data-sort="option" title="Trier par option"><i class="fas fa-cogs"></i></button>
        <button class="sort-btn" data-sort="score" title="Trier par score COMPORTEMENT"><i class="fas fa-star"></i></button>
      </div>
    </div>
    <div class="droppable-zone" data-classe=""></div>
  </div>
</template>

<!-- OVERLAY et MODALES (si absents, à compléter selon besoin) -->
<div id="overlay" class="overlay hidden"></div>

<!-- Modal Export -->
<div id="exportModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-xl font-bold">Exporter la répartition</h2>
      <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-4">
        <button onclick="exportExcel()" class="btn btn-primary">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button onclick="exportPDF()" class="btn btn-primary">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button onclick="exportAsImage()" class="btn btn-primary">
          <i class="fas fa-camera"></i> Export Image (PNG)
        </button>
        <button onclick="showComparison()" class="btn btn-secondary">
          <i class="fas fa-exchange-alt"></i> Comparer avant/après
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Règles -->
<div id="rulesModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-xl font-bold">Éditer les règles de répartition</h2>
      <button onclick="closeRulesModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="rulesContainer"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeRulesModal()" class="btn btn-secondary">Annuler</button>
      <button onclick="saveRules()" class="btn btn-primary">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Panneau Statistiques -->
<div id="statsPanel" class="fixed top-0 right-0 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 stats-panel">
  <div class="stats-panel-header">
    <h2 class="text-lg font-bold">Statistiques détaillées</h2>
    <div class="flex gap-2">
      <button id="btnFullscreen" class="btn btn-sm" onclick="toggleFullscreenStats()">
        <i class="fas fa-expand"></i>
      </button>
      <button id="btnAnchor" class="btn btn-sm" onclick="toggleAnchoredStats()">
        <i class="fas fa-thumbtack"></i>
      </button>
      <button id="closeStats" class="btn btn-sm">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div id="statsContent" class="p-4 overflow-y-auto" style="height: calc(100% - 60px);">
    <!-- Le contenu sera généré dynamiquement -->
  </div>
</div>

<!-- Aide clavier -->
<div id="keyboardShortcuts" class="keyboard-shortcuts hidden">
  <h4>Raccourcis clavier</h4>
  <div class="grid grid-cols-2 gap-2 text-xs">
    <div class="shortcut-item"><span>Recherche</span><span class="shortcut-key">Ctrl+F</span></div>
    <div class="shortcut-item"><span>Actualiser</span><span class="shortcut-key">F5</span></div>
    <div class="shortcut-item"><span>Annuler</span><span class="shortcut-key">Ctrl+Z</span></div>
    <div class="shortcut-item"><span>Refaire</span><span class="shortcut-key">Ctrl+Y</span></div>
    <div class="shortcut-item"><span>Mode swap</span><span class="shortcut-key">S</span></div>
    <div class="shortcut-item"><span>Statistiques</span><span class="shortcut-key">T</span></div>
    <div class="shortcut-item"><span>Mode sombre</span><span class="shortcut-key">D</span></div>
    <div class="shortcut-item"><span>Vue simple</span><span class="shortcut-key">V</span></div>
    <div class="shortcut-item"><span>Tutoriel</span><span class="shortcut-key">H</span></div>
    <div class="shortcut-item"><span>Fermer modals</span><span class="shortcut-key">Échap</span></div>
  </div>
</div>

    <!-- Script à ajouter APRÈS tous les autres scripts, juste avant la fermeture du body -->
<script>
// ========== NETTOYAGE ET CORRECTION DÉFINITIVE DU PANNEAU STATS ==========
console.log('🧹 Début du nettoyage du code statistiques...');

// 1. Supprimer TOUTES les protections précédentes qui causent des conflits
if (window.statsPanelProtection && window.statsPanelProtection.observer) {
  window.statsPanelProtection.observer.disconnect();
  window.statsPanelProtection = null;
  console.log('✅ Protection MutationObserver supprimée');
}

// 2. Restaurer les méthodes classList originales du panneau
const statsPanelClean = document.getElementById('statsPanel');
if (statsPanelClean && statsPanelClean.classList._originalAdd) {
  // Si on a modifié les méthodes, les restaurer
  statsPanelClean.classList.add = statsPanelClean.classList._originalAdd;
  statsPanelClean.classList.remove = statsPanelClean.classList._originalRemove;
  statsPanelClean.classList.toggle = statsPanelClean.classList._originalToggle;
  console.log('✅ Méthodes classList restaurées');
}


// 4. Nettoyer updateAllColumnStats pour éviter les appels multiples
let updateStatsTimeout = null;
const originalUpdateAllColumnStats = window.updateAllColumnStats;

window.updateAllColumnStats = function() {
  // Appel immédiat de la fonction originale pour les stats des colonnes
  document.querySelectorAll('.class-column').forEach(column => {
    const className = column.querySelector('.classe-name').textContent;
    
    if (!isRealClass(className)) return;
    
    const dropZone = column.querySelector('.droppable-zone');
    const cards = Array.from(dropZone.querySelectorAll('.student-card'));
    const eleves = cards.map(card => STATE.students[card.dataset.id]).filter(Boolean);
    
    updateColumnStats(column, eleves);
  });
  
  // Mise à jour des métriques
  if (typeof updateNewMetrics === 'function') {
    updateNewMetrics();
  }
  
  // Debounce pour la mise à jour du panneau stats
  clearTimeout(updateStatsTimeout);
  updateStatsTimeout = setTimeout(() => {
    const panel = document.getElementById('statsPanel');
    if (panel && !panel.classList.contains('translate-x-full')) {
      console.log('📊 Déclenchement mise à jour panneau stats (debounced)');
      updateStatsPanel();
    }
  }, 100);
};

// 5. Gestionnaire d'ouverture/fermeture propre
window.toggleStatsPanel = function() {
  const panel = document.getElementById('statsPanel');
  if (!panel) return;
  
  const isOpen = !panel.classList.contains('translate-x-full');
  
  if (isOpen) {
    // Fermer
    panel.classList.add('translate-x-full');
    document.body.classList.remove('stats-open');
    console.log('📊 Panneau fermé manuellement');
  } else {
    // Ouvrir
    panel.classList.remove('translate-x-full');
    document.body.classList.add('stats-open');
    
    // Initialiser les graphiques si nécessaire
    if (!window.areChartsReady()) {
      console.log('📊 Initialisation des graphiques...');
      if (typeof initCharts === 'function') {
        initCharts();
      }
    }
    
    // Mise à jour après ouverture
    setTimeout(() => {
      updateStatsPanel();
    }, 100);
    
    console.log('📊 Panneau ouvert manuellement');
  }
};

// 6. Remplacer TOUS les event listeners existants
document.addEventListener('DOMContentLoaded', () => {
  // Supprimer les anciens listeners
  const oldBtnStats = document.getElementById('btnStats');
  if (oldBtnStats) {
    const newBtnStats = oldBtnStats.cloneNode(true);
    oldBtnStats.parentNode.replaceChild(newBtnStats, oldBtnStats);
    
    // Nouveau listener propre
    newBtnStats.addEventListener('click', () => {
      toggleStatsPanel();
    });
  }
  
  // Bouton de fermeture
  const oldCloseStats = document.getElementById('closeStats');
  if (oldCloseStats) {
    const newCloseStats = oldCloseStats.cloneNode(true);
    oldCloseStats.parentNode.replaceChild(newCloseStats, oldCloseStats);

    newCloseStats.addEventListener('click', () => {
      const panel = document.getElementById('statsPanel');
      if (panel) {
        panel.classList.add('translate-x-full');
        document.body.classList.remove('stats-open');
        // Mettre à jour aria-expanded
        const btnStats = document.getElementById('btnStats');
        if (btnStats) btnStats.setAttribute('aria-expanded', 'false');
        console.log('📊 Panneau fermé par bouton X');
      }
    });
  }
  
  // Raccourci Échap (remplacer l'ancien)
  const handleEscape = (e) => {
    if (e.key === 'Escape') {
      const panel = document.getElementById('statsPanel');
      if (panel && !panel.classList.contains('translate-x-full')) {
        panel.classList.add('translate-x-full');
        document.body.classList.remove('stats-open');
        // Mettre à jour aria-expanded
        const btnStats = document.getElementById('btnStats');
        if (btnStats) btnStats.setAttribute('aria-expanded', 'false');
        console.log('📊 Panneau fermé par Échap');
      }
    }
  };
  
  // Retirer l'ancien listener et ajouter le nouveau
  document.removeEventListener('keydown', handleEscape);
  document.addEventListener('keydown', handleEscape);
});

// 7. CSS pour des transitions douces
if (!document.getElementById('stats-panel-clean-styles')) {
  const cleanStyles = document.createElement('style');
  cleanStyles.id = 'stats-panel-clean-styles';
  cleanStyles.textContent = `
    /* Transition douce pour le panneau */
    #statsPanel {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    /* Classe de mise à jour - légère opacité */
    #statsPanel.updating {
      opacity: 0.95;
      transition: opacity 0.1s ease;
    }
    
    /* Empêcher le scintillement des graphiques */
    #statsPanel .chart-container {
      transition: none !important;
    }
    
    /* Animation subtile pour les valeurs qui changent */
    .metric-value {
      transition: color 0.2s ease, transform 0.2s ease;
    }
    
    .metric-value.changed {
      transform: scale(1.02);
    }
  `;
  document.head.appendChild(cleanStyles);
}


// 9. Protection contre les initialisations multiples des graphiques
let chartsInitialized = false;
const originalInitCharts = window.initCharts;

window.initCharts = function() {
  if (chartsInitialized) {
    console.log('⚠️ Graphiques déjà initialisés, skip');
    return;
  }
  
  if (originalInitCharts) {
    originalInitCharts.call(this);
    chartsInitialized = true;
    console.log('✅ Graphiques initialisés une seule fois');
  }
};

// 10. Nettoyer les fonctions de swap pour éviter les doubles mises à jour
const originalPerformSwapClean = window.performSwap;
window.performSwap = function(id1, id2) {
  // Appeler la fonction originale sans les mises à jour supplémentaires
  const card1 = document.querySelector(`.student-card[data-id="${id1}"]`);
  const card2 = document.querySelector(`.student-card[data-id="${id2}"]`);
  
  if (!card1 || !card2) {
    console.error('Cartes non trouvées pour le swap');
    return;
  }
  
  const zone1 = card1.closest('.droppable-zone');
  const zone2 = card2.closest('.droppable-zone');
  
  if (!zone1 || !zone2) {
    console.error('Zones non trouvées pour le swap');
    return;
  }
  
  // Animation de swap
  card1.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  card2.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  
  // Échanger les cartes
  zone2.appendChild(card1);
  zone1.appendChild(card2);
  
  // Ajouter à l'historique
  STATE.history.push({
    type: 'swap',
    id1,
    id2,
    classe1: zone1.dataset.classe,
    classe2: zone2.dataset.classe
  });
  STATE.future = [];
  updateUndoRedoButtons();
  
  // UNE SEULE mise à jour des stats
  updateAllColumnStats();
  
  // Sauvegarde
  if (STATE.currentMode === 'CACHE') {
    setTimeout(() => saveImmediateCache(), 100);
  }
  
  const eleve1 = STATE.students[id1];
  const eleve2 = STATE.students[id2];
  toast(`Swap réussi entre ${eleve1.nom} et ${eleve2.nom}`, 'success');
};

console.log('✅ Nettoyage terminé - Le panneau stats devrait maintenant rester stable');

// ===== LOGIQUE SIMPLE DE LA VERSION QUI FONCTIONNE =====
console.log('✅ Application de la logique simple qui fonctionne...');

// Fonctions de mise à jour simplifiées utilisant la variable locale currentScoreType
window.updateStatsPanel = function() {
  try {
    console.log('📊 updateStatsPanel - version simple');
    
    const panel = document.getElementById('statsPanel');
    if (!panel || panel.classList.contains('translate-x-full')) {
      console.log('📊 Panneau fermé, skip');
      return;
    }
    
    // Utiliser directement updateCharts qui gère currentScoreType
    if (typeof updateCharts === 'function') {
      console.log('📊 Appel de updateCharts...');
      try {
        updateCharts();
        console.log('📊 updateCharts terminé');
      } catch (error) {
        console.error('❌ Erreur dans updateCharts:', error);
      }
    } else {
      console.error('❌ updateCharts non définie');
    }
    
  } catch (error) {
    console.error('❌ Erreur dans updateStatsPanel:', error);
  }
};

window.updateAdvancedStats = function() {
  try {
    console.log('📊 updateAdvancedStats - version simple');
    
    const panel = document.getElementById('statsPanel');
    if (!panel || panel.classList.contains('translate-x-full')) {
      return;
    }
    
    // Mise à jour des métriques
    if (typeof updateNewMetrics === 'function') {
      updateNewMetrics();
    }
    
    // Mise à jour des graphiques
    if (typeof updateCharts === 'function') {
      updateCharts();
    }
    
    // Mise à jour LV2
    if (typeof updateLV2Details === 'function') {
      updateLV2Details();
    }
    
  } catch (error) {
    console.error('❌ Erreur dans updateAdvancedStats:', error);
  }
};

console.log('✅ Logique simple appliquée avec succès');
// ===== FIN DE LA LOGIQUE SIMPLE =====
</script>

<!-- ========== INCLUSION DU MODULE DE GROUPES (GOOGLE APPS SCRIPT) ========== -->
<?!= include('groupsModuleV2.html'); ?>

<script>
// ========== INITIALISATION SIMPLE DU MODULE DE GROUPES ==========
function initGroupsModule() {
  console.log('🚀 Initialisation du module de groupes...');
  
  // Vérification de sécurité pour l'environnement
  if (typeof window === 'undefined') {
    console.log('🚫 Window non défini, arrêt de l\'initialisation');
    return;
  }
  
  // Ajouter le bouton des groupes
  const toolbar = document.querySelector('.toolbar-buttons') || document.querySelector('.flex.gap-2');
  if (toolbar && !document.getElementById('btnGroups')) {
    const btn = document.createElement('button');
    btn.id = 'btnGroups';
    btn.className = 'btn btn-primary';
    btn.innerHTML = '<i class="fas fa-layer-group"></i> Groupes';
    btn.onclick = () => {
      // Ouvrir l'interface groupes dans une nouvelle fenêtre
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(html) {
            const groupsWindow = window.open('', 'GroupsManager', 'width=1400,height=900,menubar=no,toolbar=no,scrollbars=yes,resizable=yes');
            if (groupsWindow) {
              groupsWindow.document.open();
              groupsWindow.document.write(html);
              groupsWindow.document.close();
            }
          })
          .withFailureHandler(function(error) {
            console.error('❌ Erreur ouverture interface groupes:', error);
            alert('Erreur lors de l\'ouverture de l\'interface groupes');
          })
          .getGroupsInterface();
      } else {
        console.error('❌ Google Apps Script non disponible');
        alert('Google Apps Script non disponible');
      }
    };
    toolbar.appendChild(btn);
    console.log('✅ Bouton groupes ajouté');
  }
  
  // Initialiser le module
  if (typeof window !== 'undefined' && window && window.GroupsModule && typeof window.GroupsModule.init === 'function') {
    window.GroupsModule.init();
  }
}

// Initialisation après chargement du DOM
if (typeof window !== 'undefined' && typeof document !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGroupsModule);
  } else {
    setTimeout(initGroupsModule, 100);
  }
} else {
  console.log('🚫 Environnement non compatible, pas d\'initialisation automatique');
}

// Fix pour l'erreur "modal is not defined"
window.openStartupModal = function() {
  const modal = document.getElementById('startupModal');
  if (modal) {
    modal.classList.remove('hidden');
  } else {
    console.error('❌ Modal de démarrage introuvable');
  }
};

// Fonction pour notifier les changements (si utilisée ailleurs)
window.notifyGroupsChanged = function() {
  if (typeof window !== 'undefined' && window && window.GroupsModule) {
    window.GroupsModule.updateGroupsButton();
  }
  console.log('📊 Groupes mis à jour');
};

// ========== PATCHES POUR INTERFACEV2.HTML ==========

// 1. PATCH: Fonction pour obtenir les classes INT
window.getINTClasses = function() {
  const classes = [];
  
  // Parcourir STATE.structure pour trouver les classes INT sauvegardées
  if (STATE && STATE.savedStructures) {
    Object.keys(STATE.savedStructures).forEach(structName => {
      if (structName.endsWith('INT')) {
        classes.push(structName.replace('INT', ''));
      }
    });
  }
  
  // Alternative : utiliser un appel serveur
  if (classes.length === 0 && typeof google !== 'undefined') {
    google.script.run
      .withSuccessHandler(function(intClasses) {
        return intClasses.map(c => c.replace('INT', ''));
      })
      .getINTClassesForInterface();
  }
  
  return classes.length > 0 ? classes : ['6°1', '6°2', '6°3', '6°4', '5°1', '5°2'];
};

// 2. PATCH: Menu amélioré pour les groupes avec gestion des scores
function createEnhancedGroupsMenu() {
  const nav = document.querySelector('.app-header nav');
  if (!nav) return;
  
  // Remplacer le menu existant
  const existingWrapper = document.querySelector('#btnGroups')?.parentElement;
  if (existingWrapper) {
    existingWrapper.remove();
  }
  
  // Créer le nouveau menu amélioré
  const groupsWrapper = document.createElement('div');
  groupsWrapper.className = 'relative';
  
  const btnGroups = document.createElement('button');
  btnGroups.id = 'btnGroups';
  btnGroups.className = 'nav-button relative';
  btnGroups.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
  
  const dropdown = document.createElement('div');
  dropdown.id = 'groupsDropdown';
  dropdown.className = 'absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-50 hidden opacity-0 transform scale-95 transition-all duration-200';
  dropdown.innerHTML = `
    <div class="py-2">
      <!-- Section Création -->
      <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Création</div>
      
      <button onclick="openGroupsInterface('creator')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
        <i class="fas fa-plus-circle text-green-600"></i>
        <div>
          <div class="font-medium">Créer des groupes</div>
          <div class="text-xs text-gray-500">Langues ou besoins</div>
        </div>
      </button>
      
      <!-- Section Scores (pour groupes de besoins) -->
      <div class="border-t border-gray-100 mt-2 pt-2">
        <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Scores (Besoins)</div>
        
        <button onclick="importScores()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-file-import text-orange-600"></i>
          <div>
            <div class="font-medium">Importer des scores</div>
            <div class="text-xs text-gray-500">CSV avec scores 1-4</div>
          </div>
        </button>
        
        <button onclick="downloadScoreTemplate()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-file-download text-blue-600"></i>
          <div>
            <div class="font-medium">Télécharger modèle CSV</div>
            <div class="text-xs text-gray-500">Pour import des scores</div>
          </div>
        </button>
        
        <button onclick="viewScoreStats()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-chart-pie text-purple-600"></i>
          <div>
            <div class="font-medium">Statistiques des scores</div>
            <div class="text-xs text-gray-500">Par classe et matière</div>
          </div>
        </button>
      </div>
      
      <!-- Section Gestion -->
      <div class="border-t border-gray-100 mt-2 pt-2">
        <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Gestion</div>
        
        <button onclick="openGroupsInterface('manager')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-cog text-blue-600"></i>
          <div>
            <div class="font-medium">Gérer les groupes</div>
            <div class="text-xs text-gray-500">Modifier ou supprimer</div>
          </div>
        </button>
        
        <button onclick="openGroupsInterface('templates')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-layer-group text-purple-600"></i>
          <div>
            <div class="font-medium">Modèles de groupes</div>
            <div class="text-xs text-gray-500">Configurations prédéfinies</div>
          </div>
        </button>
      </div>
      
      <!-- Section Export/Actions -->
      <div class="border-t border-gray-100 mt-2 pt-2">
        <button onclick="exportGroupsData()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-download text-purple-600"></i>
          <div>
            <div class="font-medium">Exporter tous les groupes</div>
            <div class="text-xs text-gray-500">Format CSV</div>
          </div>
        </button>
        
        <button onclick="confirmDeleteAllGroups()" class="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-3 transition-colors text-red-600">
          <i class="fas fa-trash"></i>
          <div>
            <div class="font-medium">Supprimer tous les groupes</div>
            <div class="text-xs text-red-500">Action irréversible</div>
          </div>
        </button>
      </div>
    </div>
  `;
  
  groupsWrapper.appendChild(btnGroups);
  groupsWrapper.appendChild(dropdown);
  
  // Gérer l'ouverture/fermeture avec animation
  btnGroups.addEventListener('click', (e) => {
    e.stopPropagation();
    
    // Fermer tous les autres dropdowns
    document.querySelectorAll('.app-header .absolute').forEach(d => {
      if (d !== dropdown && !d.classList.contains('hidden')) {
        d.classList.add('hidden', 'opacity-0', 'scale-95');
        d.classList.remove('opacity-100', 'scale-100');
      }
    });
    
    // Toggle ce dropdown avec animation
    if (dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('hidden');
      setTimeout(() => {
        dropdown.classList.remove('opacity-0', 'scale-95');
        dropdown.classList.add('opacity-100', 'scale-100');
      }, 10);
    } else {
      dropdown.classList.remove('opacity-100', 'scale-100');
      dropdown.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  });
  
  // Fermer le menu si on clique ailleurs
  document.addEventListener('click', () => {
    if (!dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('opacity-100', 'scale-100');
      dropdown.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  });
  
  dropdown.addEventListener('click', e => e.stopPropagation());
  
  // Insérer dans la navigation
  nav.insertBefore(groupsWrapper, nav.firstChild);
  
  // Mettre à jour le compteur
  updateGroupsButton();
}

// 3. PATCH: Import des scores
window.importScores = function() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
      <h3 class="text-lg font-bold mb-4">
        <i class="fas fa-file-import text-orange-600 mr-2"></i>
        Importer les scores (Français et Maths)
      </h3>
      
      <div class="space-y-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle mr-2"></i>
            Format attendu : CSV avec colonnes Classe, Nom, Prénom, Score F, Score M
            <br>Les scores doivent être entre 1 et 4
          </p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Sélectionnez le fichier CSV
          </label>
          <input type="file" id="scoreFile" accept=".csv" class="w-full p-2 border rounded">
        </div>
        
        <div class="flex justify-end gap-3">
          <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
            Annuler
          </button>
          <button onclick="processScoreImport()" class="btn btn-primary">
            <i class="fas fa-upload mr-2"></i>
            Importer
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

window.processScoreImport = function() {
  const fileInput = document.getElementById('scoreFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert('Veuillez sélectionner un fichier');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const csvData = e.target.result;
    
    // Envoyer au serveur
    google.script.run
      .withSuccessHandler(function(result) {
        alert(result.message);
        document.querySelector('.fixed').remove();
      })
      .withFailureHandler(function(error) {
        alert('Erreur : ' + error.message);
      })
      .importScoresFromCSV(csvData);
  };
  
  reader.readAsText(file);
};

// 4. PATCH: Télécharger le modèle CSV
window.downloadScoreTemplate = function() {
  google.script.run
    .withSuccessHandler(function(csvContent) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'modele_scores.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast('Modèle téléchargé', 'success');
    })
    .withFailureHandler(function(error) {
      toast('Erreur : ' + error.message, 'error');
    })
    .generateScoreTemplate();
};

// 5. PATCH: Visualiser les statistiques des scores
window.viewScoreStats = function() {
  google.script.run
    .withSuccessHandler(function(stats) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
              <i class="fas fa-chart-pie text-purple-600 mr-2"></i>
              Statistiques des scores par classe
            </h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${Object.entries(stats).map(([className, classStats]) => `
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3">${className}</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span>Total élèves :</span>
                    <span class="font-medium">${classStats.total}</span>
                  </div>
                  
                  <div class="mt-3">
                    <div class="font-medium mb-1">Français (moyenne : ${classStats.avgF})</div>
                    <div class="flex gap-1">
                      ${[1, 2, 3, 4].map(score => `
                        <div class="flex-1 text-center">
                          <div class="bg-blue-500 text-white text-xs py-1 rounded">
                            ${score}
                          </div>
                          <div class="mt-1">${classStats.scoreF[score]}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <div class="mt-3">
                    <div class="font-medium mb-1">Maths (moyenne : ${classStats.avgM})</div>
                    <div class="flex gap-1">
                      ${[1, 2, 3, 4].map(score => `
                        <div class="flex-1 text-center">
                          <div class="bg-purple-500 text-white text-xs py-1 rounded">
                            ${score}
                          </div>
                          <div class="mt-1">${classStats.scoreM[score]}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  ${classStats.scoreF[0] > 0 || classStats.scoreM[0] > 0 ? `
                    <div class="text-orange-600 text-xs mt-2">
                      <i class="fas fa-exclamation-triangle mr-1"></i>
                      Sans score : F=${classStats.scoreF[0]}, M=${classStats.scoreM[0]}
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    })
    .withFailureHandler(function(error) {
      toast('Erreur : ' + error.message, 'error');
    })
    .getScoreStatistics();
};

// 6. Remplacer l'ancien menu par le nouveau au chargement
document.addEventListener('DOMContentLoaded', function() {
  // Remplacer par le menu amélioré
  createEnhancedGroupsMenu();
});

// ========== CORRECTION BOUTON SAUVEGARDER POUR BARRE DE PROGRESSION ==========
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    const btnSave = document.getElementById('btnSave');
    if (btnSave) {
      // On duplique pour effacer tous les anciens event listeners
      const newBtnSave = btnSave.cloneNode(true);
      btnSave.parentNode.replaceChild(newBtnSave, btnSave);

      newBtnSave.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Ferme le menu dropdown
        const dropdown = document.getElementById('dataDropdown');
        if (dropdown) dropdown.classList.add('hidden');
        
        // Lance la sauvegarde AVEC la barre de progression !
        await saveWithProgressINT();
      });

      console.log('✅ Bouton Sauvegarder corrigé pour barre de progression');
    }
  }, 2000); // laisse le temps à tous les scripts de loader
});

// ========== FONCTION DE FALLBACK SI saveWithProgressINT N'EXISTE PAS ==========
if (typeof window.saveWithProgressINT === 'undefined') {
  console.log('⚠️ saveWithProgressINT non définie, création d\'une version de fallback');
  
  window.saveWithProgressINT = async function() {
    if (!window.saveProgressManager) {
      console.error('❌ saveProgressManager non défini !');
      // Sauvegarde simple sans barre de progression
      try {
        const disposition = exportDisposition();
        const result = await gsRun('saveElevesSnapshot', disposition);
        if (result?.success) {
          toast('Onglets INT créés avec succès', 'success');
        } else {
          toast('Erreur lors de la création des onglets INT', 'error');
        }
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        toast('Erreur lors de la sauvegarde', 'error');
      }
      return;
    }
    
    if (!window.saveProgressManager.start()) return;
    
    try {
      // Étape 1 : Préparation (25%)
      window.saveProgressManager.updateProgress(25, 'step1');
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const disposition = exportDisposition();
      if (Object.keys(disposition).length === 0) {
        throw new Error('Aucune classe à sauvegarder');
      }
      
      // Étape 2 : Validation LV2 (50%)
      window.saveProgressManager.updateProgress(50, 'step2');
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // Étape 3 : Création des onglets INT (75%)
      window.saveProgressManager.updateProgress(75, 'step3');
      
      const result = await gsRun('saveElevesSnapshot', disposition);
      if (!result?.success) {
        throw new Error(result?.error || 'Erreur serveur');
      }
      
      // Étape 4 : Finalisation (100%)
      window.saveProgressManager.updateProgress(100, 'step4');
      await new Promise(resolve => setTimeout(resolve, 200));
      
      window.saveProgressManager.complete(true);
      toast(`Onglets INT créés avec succès pour ${Object.keys(disposition).length} classes`, 'success');
      
    } catch (error) {
      console.error('Erreur création onglets INT:', error);
      window.saveProgressManager.complete(false);
      toast('Erreur: ' + error.message, 'error');
    }
  };
}

// ========== DIAGNOSTIC DES FONCTIONS DISPONIBLES ==========
setTimeout(() => {
  console.log('🔍 Diagnostic des fonctions de sauvegarde :');
  console.log('- saveWithProgressINT:', typeof window.saveWithProgressINT);
  console.log('- saveProgressManager:', typeof window.saveProgressManager);
  console.log('- exportDisposition:', typeof window.exportDisposition);
  console.log('- gsRun:', typeof window.gsRun);
  
  // Vérifier que le bouton existe
  const btnSave = document.getElementById('btnSave');
  console.log('- Bouton Save existe:', !!btnSave);
}, 5000);
</script>

</body>
</html>